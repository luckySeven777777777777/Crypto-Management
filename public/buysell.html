<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Trade (Single Submit Fix)</title>
  <style>
    body { font-family: Arial; background: transparent; color: white; padding: 20px; margin: 0; }
    .container { max-width: 450px; margin: 0 auto; width: 100%; }
    h2 { text-align: center; margin-bottom: 20px; }
    .transaction-type { display: flex; justify-content: space-between; gap: 4%; width: 100%; }
    .btn { width: 48%; padding: 12px; border-radius: 8px; border: 2px solid; cursor: pointer; background: transparent; font-size: 16px; }
    .buy-btn { border-color: #2ecc71; color: #2ecc71; }
    .sell-btn { border-color: #e67e22; color: #e67e22; }
    input, select {
      width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #ccc;
      background: transparent !important; color: white !important; font-size: 16px; box-sizing: border-box;
    }
    select option { background: white !important; color: black !important; }
    .trade-btn {
      width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #3498db;
      background: transparent; color: #3498db; margin-top: 20px; cursor: pointer; font-size: 16px;
    }
    .adjusted-box p { margin: 5px 0; }
    .stop-box input[type="number"] { width: 48%; display: inline-block; margin-right: 4%; margin-top: 5px; }
    #orderIdBox {
      margin-top: 15px; padding: 12px; border: 1px solid #aaa; border-radius: 8px;
      font-size: 15px; display: none;
    }
    .hint-cn { margin-top: 6px; color: #bbb; font-size: 12px; line-height: 1.4; }
    .trade-btn.loading {
      opacity: 0.7; cursor: not-allowed; position: relative;
    }
    .trade-btn.loading::after {
      content: "";
      width: 18px; height: 18px;
      border: 3px solid rgba(52, 152, 219, 0.6);
      border-top-color: #3498db;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    }
    @keyframes spin {
      from { transform: translateY(-50%) rotate(0); }
      to { transform: translateY(-50%) rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="orderIdBox"></div>
  <h2></h2>

  <div class="transaction-type">
    <button class="btn buy-btn" id="buyBtn">Buy</button>
    <button class="btn sell-btn" id="sellBtn">Sell</button>
  </div>

  <label>Select Coin:</label>
  <select id="currency"></select>

  <label>Amount:</label>
  <input type="number" id="amount" min="0" step="any" />

  <label>Amount Currency:</label>
  <select id="amountCurrency"></select>

  <div class="adjusted-box" id="convertedBox">
    <p><b>Auto-conversion:</b></p>
  </div>

  <div class="stop-box">
    <label><input type="checkbox" id="slCheckbox" /> Enable Stop-loss / Take-profit</label>
    <div id="slBox" style="display:none;margin-top:6px;">
      <input type="number" id="takeProfit" placeholder="TP %" />
      <input type="number" id="stopLoss" placeholder="SL %" />
      <div id="tpResult" style="color:#7ed957;"></div>
      <div id="slResult" style="color:#ff8c69;"></div>
    </div>
  </div>

  <button class="trade-btn" id="tradeBtn">Trade</button>
  <p class="hint-cn">ðŸ¤– Please ensure you have completed your deposit...</p>
</div>

<script>
const API_BASE = "https://crypto-management-production-5e04.up.railway.app";
let submitting = false;

function getUID() {
  let uid = localStorage.getItem("NEXBIT_UID");
  if (!uid) {
    uid = "U" + Date.now() + "_" + Math.floor(Math.random() * 1e6);
    localStorage.setItem("NEXBIT_UID", uid);
  }
  return uid;
}
const USERID = getUID();

const COINS = ["BTC","ETH","BNB","SOL","XRP","ADA","DOGE","TRX","DOT","MATIC","AVAX","USDT"];
const STABLES = new Set(["USDT"]);
const live = {};

async function fetchPrice(sym) {
  if (STABLES.has(sym)) return 1;
  const r = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${sym}USDT`);
  const j = await r.json();
  return Number(j.price) || 0;
}

function ensure(sym) {
  if (live[sym]) return;
  fetchPrice(sym).then(p => { live[sym] = p; updateConverted(); updateTPSL(); });
}

function updateConverted() {
  const amt = Number(amount.value) || 0;
  const from = amountCurrency.value;
  const to = currency.value;
  const box = convertedBox;
  box.innerHTML = "<p><b>Auto-conversion:</b></p>";
  if (!amt) return;
  ensure(from); ensure(to);
  if (!live[from] || !live[to]) {
    box.innerHTML += "<p style='color:#aaa'>Fetching price...</p>";
    return;
  }
  const usd = amt * live[from];
  const conv = usd / live[to];
  box.innerHTML += `<p>${to}: ${conv.toFixed(6)}</p>`;
}

function updateTPSL() {
  if (!slCheckbox.checked) return;
  const p = live[currency.value];
  if (!p) return;
  if (takeProfit.value) tpResult.innerText = "TP Price: " + (p * (1 + takeProfit.value/100)).toFixed(6);
  if (stopLoss.value) slResult.innerText = "SL Price: " + (p * (1 - stopLoss.value/100)).toFixed(6);
}

async function checkBalance() {
  const r = await fetch(`${API_BASE}/api/balance/${USERID}`, { headers: { "X-User-Id": USERID }});
  const j = await r.json();
  return Number(j.balance) || 0;
}

function genOrderId() {
  return "TRD-" + Date.now() + "-" + Math.floor(Math.random()*1e6);
}

async function sendOrder() {
  if (submitting) return;
  submitting = true;

  tradeBtn.disabled = true;
  tradeBtn.classList.add("loading");
  tradeBtn.textContent = "Submitting...";

  const amt = Number(amount.value);
  if (!amt) {
    alert("Invalid amount");
    submitting = false;
    tradeBtn.disabled = false;
    tradeBtn.classList.remove("loading");
    tradeBtn.textContent = "Trade";
    return;
  }

  const bal = await checkBalance();
  if (bal < amt) {
    alert("ðŸ¤–Insufficient balance");
    submitting = false;
    tradeBtn.disabled = false;
    tradeBtn.classList.remove("loading");
    tradeBtn.textContent = "Trade";
    return;
  }

  const payload = {
    userId: USERID,
    user: USERID,
    side: window.tradeType,          // âœ… å…³é”®å­—æ®µï¼šserver.js ä½¿ç”¨
    tradeType: window.tradeType,     // ä¿ç•™
    coin: currency.value,
    currency: currency.value,
    amount: amt,
    amountCurrency: amountCurrency.value,
    orderId: genOrderId(),
    timestamp: Date.now()
  };

  orderIdBox.style.display = "block";
  orderIdBox.innerHTML = "Order submitted: <b>" + payload.orderId + "</b>";

  await fetch(`${API_BASE}/proxy/buysell`, {
    method: "POST",
    headers: { "Content-Type":"application/json","X-User-Id":USERID },
    body: JSON.stringify(payload)
  });

  tradeBtn.textContent = "Submitted";
}

document.addEventListener("DOMContentLoaded", () => {
  COINS.forEach(c => {
    currency.innerHTML += `<option>${c}</option>`;
    amountCurrency.innerHTML += `<option>${c}</option>`;
  });
  amountCurrency.value = "USDT";
  buyBtn.onclick = () => window.tradeType = "buy";
  sellBtn.onclick = () => window.tradeType = "sell";
  tradeBtn.onclick = sendOrder;
  slCheckbox.onclick = () => slBox.style.display = slCheckbox.checked ? "block" : "none";
  amount.oninput = updateConverted;
  currency.onchange = updateConverted;
  amountCurrency.onchange = updateConverted;
  takeProfit.oninput = updateTPSL;
  stopLoss.oninput = updateTPSL;
  window.tradeType = "buy";
});
</script>
</body>
</html>
