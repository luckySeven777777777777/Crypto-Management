<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NEXBIT ç®¡ç†åå° â€” æœ€ç»ˆç‰ˆ</title>
<style>
:root{--top-blue:#1976d2;--deep-blue:#0f2655;--bg:#f4f7fb;--card:#fff;
--red:#ff4444;--black:#000;--green:#00c851;--yellow:#ffbb33;--purple:#9933ff;}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Roboto,Arial;background:var(--bg);min-height:100vh}
.top-header{position:fixed;top:0;left:0;width:100%;height:64px;background:var(--top-blue);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1000;}
.top-header .brand{font-weight:700;font-size:18px}
.top-header .user{font-size:14px}
.app{display:flex;padding-top:64px}
.sidebar{width:88px;background:var(--deep-blue);color:#fff;min-height:calc(100vh - 64px);padding-top:20px;position:fixed;top:64px;left:0}
.sidebar .icon{display:block;padding:16px;text-align:center;color:#cdd6f4;cursor:pointer}
.sidebar .icon.active{background:var(--top-blue);color:#fff;border-radius:8px;margin:4px}
.main{margin-left:88px;flex:1;padding:22px 26px}
.container{background:var(--card);border-radius:8px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.page-title{font-size:20px;font-weight:700;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
.card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);} 
.filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
input,select,button{padding:8px;border:1px solid #ddd;border-radius:6px}
button.primary{background:var(--top-blue);color:#fff;border:none;cursor:pointer}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
.member-label{display:inline-block;padding:4px 8px;border-radius:4px;color:#fff;font-weight:600;margin-left:8px;font-size:12px}
.label-attention{background:var(--red)} .label-observe{background:var(--black)} .label-first-recharge{background:var(--green)} .label-first-withdraw{background:var(--yellow);color:#111} .label-vip{background:var(--purple)}
.small{font-size:12px;color:#666}
.actions button{margin-right:6px}
.footer-note{margin-top:10px;color:#888;font-size:12px}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}

/* ADDED: order/admin pages styles (keeps consistent) */
.subpage-actions{display:flex;gap:8px;align-items:center;margin-bottom:12px}
.table-sm th,.table-sm td{padding:8px;font-size:13px}
.badge{display:inline-block;padding:4px 8px;border-radius:4px;background:#eee;color:#333;font-weight:600}

/* small button style for action */
.small-btn { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; font-size:13px; }
.lock-btn { background:#ffcc00; }
.confirm-btn { background:#00c851; color:#fff; }
.cancel-btn { background:#ff4444; color:#fff; }
.unlock-btn { background:#6c757d; color:#fff; }

/* BuySell sticky marker in sidebar */
.sidebar .buysell { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border-radius:8px; margin:6px; padding:12px 6px; text-align:center }

/* wallet modal */
.modal{display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1200}
.modal .box{background:#fff;padding:16px;border-radius:8px;min-width:320px}
</style>
</head>
<body>

<div class="top-header">
  <div class="brand">NEXBIT ç®¡ç†åå°ï¼ˆä»£ç†ï¼‰</div>
  <div class="user"><span id="easternNow">US/Eastern: --</span> &nbsp;Â·&nbsp; å·²ç™»å½•ï¼šadmin</div>
</div>

<div class="app">
  <div class="sidebar">
    <div class="icon active" data-page="dashboard" title="æ§åˆ¶å°">ğŸ </div>
    <div class="icon buysell" data-page="buysell" title="BuySellï¼ˆå¸¸æ˜¾ï¼‰">ğŸ’±
      <div style="font-size:11px;margin-top:6px;color:#cfe6ff">BuySell</div>
    </div>
    <div class="icon" data-page="recharge" title="å……å€¼ç®¡ç†">ğŸ’³</div>
    <div class="icon" data-page="withdraw" title="ææ¬¾ç®¡ç†">ğŸ’¸</div>
    <div class="icon" data-page="members" title="ä¼šå‘˜ç®¡ç†">ğŸ‘¥</div>
    <div class="icon" data-page="orders" title="è®¢å•è®°å½•">ğŸ“œ</div>
    <div class="icon" data-page="settings" title="ç³»ç»Ÿè®¾ç½®">âš™ï¸</div>
  </div>
  <div class="main">
    <!-- Dashboard -->
    <div id="page-dashboard" class="container">
      <div class="page-title">æ§åˆ¶å°</div>
      <div class="grid">
        <div class="card">ä»Šæ—¥å……å€¼<br><strong id="todayRecharge">--</strong></div>
        <div class="card">ä»Šæ—¥ææ¬¾<br><strong id="todayWithdraw">--</strong></div>
        <div class="card">ä»Šæ—¥è®¢å•<br><strong id="todayOrders">--</strong></div>
        <div class="card">é£æ§é¢„è­¦<br><strong id="alertsCount">--</strong></div>
      </div>
      <div class="container card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">ä¼šå‘˜ç­‰çº§ç»Ÿè®¡</div>
          <div class="small">æ›´æ–°äº <span id="statTime"></span></div>
        </div>
        <div style="margin-top:12px" id="memberStats"></div>
      </div>
    </div>

    <!-- BuySell page -->
    <div id="page-buysell" class="container" style="display:none">
      <div class="page-title">BuySell ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="bs_start"></label>
        <label>ç»“æŸ <input type="date" id="bs_end"></label>
        <input id="bs_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="bs_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BTC</option><option>ETH</option><option>USDT</option></select>
        <select id="bs_side"><option value="">å…¨éƒ¨</option><option value="buy">ä¹°</option><option value="sell">å–</option></select>
        <button class="primary" onclick="bs_search()">æœç´¢</button>
      </div>

      <div style="margin-bottom:8px">å®æ—¶æ±‡ç‡ï¼š<span id="tickersSummary">-</span></div>

      <table class="table table-sm">
        <thead>
          <tr>
            <th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th>
            <th>æ—¶é—´ (US/Eastern)</th>
            <th>ç±»å‹</th>
            <th>é‡‘é¢</th>
            <th>å¸ç§</th>
            <th>ä¼°ç®— USDT</th>
            <th>wallet</th>
            <th>IP</th>
            <th>TP/SL</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="bs_table"><tr><td colspan="11" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Recharge page -->
    <div id="page-recharge" class="container" style="display:none">
      <div class="page-title">å……å€¼ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="r_start"></label>
        <label>ç»“æŸ <input type="date" id="r_end"></label>
        <input id="r_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="r_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <select id="r_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="processing">å¤„ç†ä¸­</option><option value="success">æˆåŠŸ</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="r_search()">æœç´¢</button>
      </div>

      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="r_table"><tr><td colspan="9" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Withdraw page -->
    <div id="page-withdraw" class="container" style="display:none">
      <div class="page-title">ææ¬¾ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="w_start"></label>
        <label>ç»“æŸ <input type="date" id="w_end"></label>
        <input id="w_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="w_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <select id="w_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="processing">å¤„ç†ä¸­</option><option value="success">æˆåŠŸ</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="w_search()">æœç´¢</button>
      </div>

      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="w_table"><tr><td colspan="9" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Members page -->
    <div id="page-members" class="container" style="display:none">
      <div class="page-title">ä¼šå‘˜ç®¡ç†</div>
      <div class="filters">
        <input id="m_search" placeholder="ä¼šå‘˜ID / é’±åŒ…åœ°å€" style="width:260px">
        <button onclick="loadMembers()">æœç´¢</button>
      </div>
      <table class="table">
        <thead><tr><th>ä¼šå‘˜ID</th><th>wallet</th><th>æœ€è¿‘æ´»åŠ¨</th></tr></thead>
        <tbody id="m_table"><tr><td colspan="3" class="small">æš‚æ— æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Orders page -->
    <div id="page-orders" class="container" style="display:none">
      <div class="page-title">è®¢å•è®°å½•ï¼ˆå……å€¼/ææ¬¾/ä¹°å–ï¼‰</div>

      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="o_start"></label>
        <label>ç»“æŸ <input type="date" id="o_end"></label>
        <input id="o_q" placeholder="è®¢å•å· / ä¼šå‘˜ID / é’±åŒ…åœ°å€" style="width:260px">
        <select id="o_type"><option value="">å…¨éƒ¨ç±»å‹</option><option value="recharge">å……å€¼</option><option value="withdraw">ææ¬¾</option><option value="trade">ä¹°å–</option></select>
        <button class="primary" onclick="o_search()">æœç´¢</button>
      </div>

      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="o_table"><tr><td colspan="9" class="small">æš‚æ— æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Admins page -->
    <div id="page-admins" class="container" style="display:none">
      <div class="page-title">ç®¡ç†å‘˜æƒé™</div>
      <div class="filters">
        <input id="admin_id" placeholder="ç®¡ç†å‘˜ID" style="width:220px;">
        <label><input type="checkbox" id="perm_recharge"> å……å€¼</label>
        <label><input type="checkbox" id="perm_withdraw"> ææ¬¾</label>
        <label><input type="checkbox" id="perm_trade"> äº¤æ˜“</label>
        <button class="primary" onclick="addAdmin()">æ–°å¢</button>
      </div>

      <table class="table table-sm">
        <thead><tr><th>ç®¡ç†å‘˜ID</th><th>æƒé™</th><th>æœ€è¿‘ç™»å½•</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="admin_table"><tr><td colspan="4" class="small">æš‚æ— ç®¡ç†å‘˜</td></tr></tbody>
      </table>
    </div>

    <div class="footer-note">ç³»ç»Ÿç”Ÿæˆï¼š<span id="genTime"></span></div>
  </div>
</div>
<script>
/* ---------------------------
   æ ¸å¿ƒ JSï¼šå·²å…¨éƒ¨ä¿®å¤åŠ è½½å¤±è´¥é—®é¢˜
   - æ‰€æœ‰ /proxy/transactions å·²ç§»é™¤
   - æ›¿æ¢ä¸º /api/transactions
   - æ‰€æœ‰æ›´æ–°æ“ä½œæ”¹ä¸º /api/transaction/update
   - UI å®Œå…¨ä¿ç•™ï¼Œæ‰€æœ‰é¡µé¢ä¿æŒåŸæ ·
------------------------------ */

// ä½¿ç”¨çœŸå®æ¥å£ï¼ˆå·²ç»å­˜åœ¨äº server.jsï¼‰
const API_TRANSACTIONS = '/api/transactions';
const API_UPDATE = '/api/transaction/update';

// helper
function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}

// Sidebar navigation
$all('.sidebar .icon').forEach(ic=>ic.addEventListener('click', ()=>{
  $all('.sidebar .icon').forEach(x=>x.classList.remove('active'));
  ic.classList.add('active');
  const page = ic.getAttribute('data-page');
  hideAllPages();
  const el = document.getElementById('page-' + page);
  if(el) el.style.display = 'block';
  if(page === 'dashboard') loadDashboard();
  if(page === 'recharge') r_search();
  if(page === 'withdraw') w_search();
  if(page === 'buysell') bs_search();
  if(page === 'orders') o_search();
  if(page === 'members') loadMembers();
  if(page === 'settings') loadSettings();
}));

function hideAllPages(){ $all('.main > .container').forEach(c=>c.style.display='none'); }
function showPage(key){ const el = document.getElementById('page-'+key); hideAllPages(); if(el) el.style.display='block'; }

// US/Eastern time
function updateEastern(){ 
  try{ 
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('en-US',{ 
      timeZone:'America/New_York', year:'numeric', month:'2-digit',
      day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' 
    });
    $('#easternNow').innerText = 'US/Eastern: ' + fmt.format(now);
  }catch(e){ $('#easternNow').innerText='US/Eastern: --'; }
}
setInterval(updateEastern,1000); updateEastern();

// Binance websocket realtime prices
const watchedSymbols = ['BTCUSDT','ETHUSDT','LTCUSDT','XRPUSDT','BCHUSDT'];
const priceMap = {};
let bsock = null;

function connectBinance(){
  try{
    const streams = watchedSymbols.map(s=>s.toLowerCase()+'@trade').join('/');
    const url = 'wss://stream.binance.com:9443/stream?streams=' + streams;
    bsock = new WebSocket(url);

    bsock.onmessage = ev=>{
      const msg = JSON.parse(ev.data);
      const d = msg.data || msg;
      const sym = (d.s||'').toUpperCase();
      const p = d.p || d.price || d.P || null;
      if(sym && p) priceMap[sym] = Number(p);
      updateTickSummary();
      refreshBuySellEstimates();
    };
    bsock.onclose = ()=>{ setTimeout(connectBinance,5000); };
  }catch{}
}
connectBinance();

function updateTickSummary(){
  const parts = watchedSymbols.map(s=> s + ': ' + (priceMap[s]? priceMap[s].toFixed(6) : '--'));
  $('#tickersSummary').innerText = parts.join(' | ');
}

// wallet modal
function showWallet(addr){ $('#walletAddr').innerText = addr || '--'; $('#walletModal').style.display = 'flex'; }
function closeWallet(){ $('#walletModal').style.display = 'none'; }

function shorten(s,len=12){ if(!s) return '--'; return s.length>len? s.slice(0, len-4)+'...'+s.slice(-4): s; }

// æ›´æ–°è®¢å•çŠ¶æ€
async function txAction(id, action){
  if(!id) return alert('ç¼ºå°‘è®¢å•ID');
  const body = { orderId: id, action };
  try{
    const res = await fetch(API_UPDATE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const j = await res.json();
    if(j.ok){
      alert('æ“ä½œæˆåŠŸ');
      const active = document.querySelector('.sidebar .icon.active').getAttribute('data-page');
      if(active==='recharge') r_search();
      else if(active==='withdraw') w_search();
      else if(active==='buysell') bs_search();
      else o_search();
    } else alert('æ“ä½œå¤±è´¥: ' + JSON.stringify(j));
  }catch(e){ alert('æœåŠ¡å™¨é”™è¯¯'); }
}

function viewDetail(id){ alert('æŸ¥çœ‹è®¢å•: '+id); }

// ä½¿ç”¨çœŸå®åç«¯æ¥å£è·å–è®¢å•æ•°æ®
async function fetchAll(params = {}){
  const url = new URL(API_TRANSACTIONS, window.location.origin);
  Object.keys(params).forEach(k=> url.searchParams.append(k, params[k]));
  const res = await fetch(url.toString());
  return await res.json();
}

/* ---------------- Recharge Search ---------------- */
async function r_search(){
  const params = {};
  if($('#r_start').value) params.start = $('#r_start').value;
  if($('#r_end').value) params.end = $('#r_end').value;
  if($('#r_wallet').value) params.q = $('#r_wallet').value;
  if($('#r_currency').value) params.currency = $('#r_currency').value;
  if($('#r_status').value) params.status = $('#r_status').value;

  const tbody = $('#r_table'); tbody.innerHTML = '<tr><td colspan="9">åŠ è½½ä¸­...</td></tr>';

  try{
    const all = await fetchAll(params);
    const list = all.recharge || [];
    if(!list.length) return tbody.innerHTML='<tr><td colspan="9">æ²¡æœ‰è®°å½•</td></tr>';
    tbody.innerHTML = list.map(it=>renderCommonRow(it,['',''])).join('');
  }catch{ tbody.innerHTML='<tr><td colspan="9">åŠ è½½å¤±è´¥</td></tr>'; }
}

/* ---------------- Withdraw Search ---------------- */
async function w_search(){
  const params = {};
  if($('#w_start').value) params.start = $('#w_start').value;
  if($('#w_end').value) params.end = $('#w_end').value;
  if($('#w_wallet').value) params.q = $('#w_wallet').value;
  if($('#w_currency').value) params.currency = $('#w_currency').value;
  if($('#w_status').value) params.status = $('#w_status').value;

  const tbody = $('#w_table'); tbody.innerHTML = '<tr><td colspan="9">åŠ è½½ä¸­...</td></tr>';

  try{
    const all = await fetchAll(params);
    const list = all.withdraw || [];
    if(!list.length) return tbody.innerHTML='<tr><td colspan="9">æ²¡æœ‰è®°å½•</td></tr>';
    tbody.innerHTML = list.map(it=>renderCommonRow(it,['',''])).join('');
  }catch{ tbody.innerHTML='<tr><td colspan="9">åŠ è½½å¤±è´¥</td></tr>'; }
}

/* ---------------- BuySell Search ---------------- */
async function bs_search(){
  const params = {};
  if($('#bs_start').value) params.start = $('#bs_start').value;
  if($('#bs_end').value) params.end = $('#bs_end').value;
  if($('#bs_wallet').value) params.q = $('#bs_wallet').value;
  if($('#bs_currency').value) params.currency = $('#bs_currency').value;
  if($('#bs_side').value) params.side = $('#bs_side').value;

  const tbody = $('#bs_table'); tbody.innerHTML = '<tr><td colspan="11">åŠ è½½ä¸­...</td></tr>';

  try{
    const all = await fetchAll(params);
    const list = all.buysell || [];
    if(!list.length) return tbody.innerHTML='<tr><td colspan="11">æ²¡æœ‰è®°å½•</td></tr>';
    tbody.innerHTML = list.map(it=>renderBuySellRow(it)).join('');
  }catch{ tbody.innerHTML='<tr><td colspan="11">åŠ è½½å¤±è´¥</td></tr>'; }
}

/* ---------------- Orders Search ---------------- */
async function o_search(){
  const params = {};
  if($('#o_start').value) params.start = $('#o_start').value;
  if($('#o_end').value) params.end = $('#o_end').value;
  if($('#o_q').value) params.q = $('#o_q').value;
  if($('#o_type').value) params.type = $('#o_type').value;
  if($('#o_currency').value) params.currency = $('#o_currency').value;
  if($('#o_status').value) params.status = $('#o_status').value;

  const tbody = $('#o_table'); tbody.innerHTML = '<tr><td colspan="9">åŠ è½½ä¸­...</td></tr>';

  try{
    const all = await fetchAll(params);
    const rows = [
      ...(all.recharge || []),
      ...(all.withdraw || []),
      ...(all.buysell || [])
    ];
    if(!rows.length) return tbody.innerHTML='<tr><td colspan="9">æ²¡æœ‰è®°å½•</td></tr>';
    tbody.innerHTML = rows.map(it=>renderCommonRow(it,['',''])).join('');
  }catch{ tbody.innerHTML='<tr><td colspan="9">åŠ è½½å¤±è´¥</td></tr>'; }
}

/* ---------------- Members Page ---------------- */
async function loadMembers(){
  const q = $('#m_search').value.trim();
  const tbody = $('#m_table'); tbody.innerHTML = '<tr><td colspan="4">åŠ è½½ä¸­...</td></tr>';

  try{
    const all = await fetchAll();
    const users = Object.keys(all.users || {}).map(uid=>({
      uid,
      balance: all.users[uid].balance,
      updated: all.users[uid].updated
    }));
    tbody.innerHTML = users.map(u=>`
      <tr>
        <td>${u.uid}</td>
        <td>-</td>
        <td>è§‚å¯Ÿä¼šå‘˜</td>
        <td>${u.updated}</td>
      </tr>
    `).join('');
  }catch(e){ tbody.innerHTML='<tr><td colspan="4">åŠ è½½å¤±è´¥</td></tr>'; }
}

/* ---------------- Dashboard ---------------- */
async function loadDashboard(){
  const box = $('#todayRecharge');
  box.innerText = "åŠ è½½ä¸­...";
  try{
    const all = await fetchAll();
    $('#todayRecharge').innerText = all.stats?.todayRecharge || 0;
    $('#todayWithdraw').innerText = all.stats?.todayWithdraw || 0;
    $('#todayOrders').innerText = all.stats?.todayOrders || 0;
    $('#alertsCount').innerText = all.stats?.alerts || 0;
    $('#genTime').innerText = new Date().toISOString();
  }catch(e){ box.innerText="--"; }
}

// init
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelector('.sidebar .icon.active').click();
});

</script>

</body>
</html>
