<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NEXBIT ç®¡ç†åå° â€” æœ€ç»ˆç‰ˆ</title>

<style>

:root{
  --top-blue:#1976d2;
  --deep-blue:#0f2655;
  --bg:#f4f7fb;
  --card:#fff;
  --red:#ff4444;
  --black:#000;
  --green:#00c851;
  --yellow:#ffbb33;
  --purple:#9933ff;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,Roboto,Arial;
  background:var(--bg);
  min-height:100vh;
}

  .modal[style*="display: flex"],
  .order-detail-modal[style*="display: flex"],
  .admin-login-modal[style*="display: flex"] {
    pointer-events: auto !important;
  }

/* ========= HEADER ========= */
.top-header{
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 64px;
  background: #1976d2;
  z-index: 1000;

  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;

  pointer-events: auto;   /* âœ… å¿…é¡»æ˜¯ auto */
}
.top-header .brand{
  font-weight:700;
  font-size:18px;
}
.top-header .user{
  font-size:14px;
}

/* ----------- LAYOUT ---------- */
.app{
  display:flex;
  padding-top:64px;
}
.sidebar{
  width:88px;
  background:var(--deep-blue);
  color:#fff;
  min-height:calc(100vh - 64px);
  padding-top:20px;
  position:fixed;
  top:64px; left:0;
}
.sidebar .icon{
  display:block;
  padding:16px;
  text-align:center;
  color:#cdd6f4;
  cursor:pointer;
}
.sidebar .icon.active{
  background:var(--top-blue);
  color:#fff;
  border-radius:8px;
  margin:4px;
}
.sidebar .buysell{
  background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));
  border-radius:8px;
  margin:6px;
  padding:12px 6px;
  text-align:center;
}

.main{
  margin-left:88px;
  flex:1;
  padding:22px 26px;
}
/* ====== FIX CLICK ISSUE ====== */

/* header ä¸æŒ¡ç‚¹å‡»ï¼Œåªç»™å†…éƒ¨æŒ‰é’® */

/* sidebar å¿…é¡»å¯ç‚¹ */
.sidebar{
  pointer-events: auto;
  z-index: 900;
}

/* ä¸»å†…å®¹å¿…é¡»åœ¨æœ€ä¸Šå±‚ */
.main {
  position: relative;
  z-index: 2000 !important;
  pointer-events: auto !important;
}
/* ----------- CARD / GRID ----------- */
.container{
  background:var(--card);
  border-radius:8px;
  padding:18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}
.page-title{
  font-size:20px;
  font-weight:700;
  margin-bottom:12px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
  margin-bottom:12px;
}
.card{
  background:#fff;
  border-radius:8px;
  padding:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
}
.filters{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:12px;
}

input,select,button{
  padding:8px;
  border:1px solid #ddd;
  border-radius:6px;
}
button.primary{
  background:var(--top-blue);
  color:#fff;
  border:none;
  cursor:pointer;
}

/* ----------- TABLE ----------- */
.table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
}
.table th,.table td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:left;
  font-size:13px;
}

/* ä¼šå‘˜ç­‰çº§æ ‡ç­¾ */
.member-label{
  display:inline-block;
  padding:4px 8px;
  border-radius:4px;
  color:#fff;
  font-weight:600;
  margin-left:8px;
  font-size:12px;
}
.label-attention{background:var(--red)}
.label-observe{background:var(--black)}
.label-first-recharge{background:var(--green)}
.label-first-withdraw{background:var(--yellow); color:#111}
.label-vip{background:var(--purple)}

.small{font-size:12px; color:#666}
.actions button{margin-right:6px}
.footer-note{margin-top:10px; color:#888; font-size:12px}

/* BuySell ticker style */
.table-sm th,.table-sm td{
  padding:8px; font-size:13px;
}

/* çŠ¶æ€å¾½ç«  */
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:4px;
  background:#eee;
  color:#333;
  font-weight:600;
}
/* ğŸ‘‡ åŠ åœ¨æœ€å */
.btn-disabled {
  opacity: 0.4 !important;
  pointer-events: none !important;
  filter: grayscale(100%);
  cursor: not-allowed;
}
/* ----------- å®¡æ ¸æŒ‰é’®æ ·å¼ ----------- */
.small-btn{
  padding:6px 8px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-size:13px;
}
.small-btn:disabled{
  opacity: 0.45;
  cursor: not-allowed;
  pointer-events: none;
}
.confirm-btn{ background:#00c851; color:#fff; }
.cancel-btn{ background:#ff4444; color:#fff; }
.lock-btn{ background:#ffbb33; color:#111; }
.unlock-btn{ background:#6c757d; color:#fff; }

/* Modal */
.modal{
  display:none;
  position:fixed;
  left:0; top:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5);
  align-items:center;
  justify-content:center;
  z-index:1200;
}
.modal .box{
  background:#fff;
  padding:16px;
  border-radius:8px;
  min-width:320px;
}

/* ===== Extra styles: order modal, admin login, alerts ===== */
.order-detail-modal { display:none; position:fixed; left:0; top:0; right:0; bottom:0;
  background: rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1300; }
.order-detail-modal .box { background:#fff; color:#111; padding:16px; border-radius:8px; width:760px; max-width:95%; max-height:86vh; overflow:auto; }
.order-detail-modal pre { background:#f6f8fa; padding:10px; border-radius:6px; font-size:12px; white-space:pre-wrap; word-break:break-word; }
.admin-login-modal { display:none; position:fixed; left:0; top:0; right:0; bottom:0;
  background: rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1400; }
.admin-login-modal .box { background:#fff; color:#111; padding:20px; border-radius:8px; width:420px; max-width:95%; }
.badge-alert { background:#ff4444; color:#fff; padding:6px 8px; border-radius:6px; display:inline-block; margin-left:8px; }
.flash { animation: flash 1s linear infinite; }
@keyframes flash { 0% { box-shadow: 0 0 0 rgba(255,0,0,0.0); } 50% { box-shadow: 0 0 8px rgba(255,0,0,0.6); } 100% { box-shadow: 0 0 0 rgba(255,0,0,0.0); } }
.tr-alert { background: #fff0f0 !important; border-left:4px solid #ff4444 !important; }

/* Responsive */
@media(max-width:900px){
  .grid{ grid-template-columns:repeat(2,1fr); }
}

/* åªæœ‰çœŸæ­£æ˜¾ç¤ºæ—¶ï¼Œæ‰å…è®¸ç‚¹å‡» */
.modal[style*="display: flex"],
.order-detail-modal[style*="display: flex"],
.admin-login-modal[style*="display: flex"] {
  pointer-events: auto !important;
}
/* ===== å…œåº•ï¼šç¡®ä¿æ“ä½œæŒ‰é’®æ°¸è¿œå¯ç‚¹å‡» ===== */
.small-btn{
  position: relative;
  z-index: 3001;
  pointer-events: auto;
}
/* ===== å¼ºåˆ¶æ¢å¤åå°æ“ä½œåŒºç‚¹å‡»èƒ½åŠ› ===== */
table,
tbody,
tr,
td,
.small-btn,
.action-btn,
button {
  pointer-events: auto !important;
}
.remark-drawer{
  position: fixed;
  top: 64px;
  right: -420px;
  width: 420px;
  height: calc(100vh - 64px);
  background: #0f172a;
  color: #fff;
  box-shadow: -4px 0 16px rgba(0,0,0,.4);
  transition: right .3s ease;
  z-index: 5000;
}

.remark-drawer.open{
  right: 0;
}

.drawer-header{
  padding: 14px 16px;
  font-weight: 700;
  background: #1976d2;
  display:flex;
  justify-content: space-between;
  align-items: center;
}

.drawer-header button{
  background: none;
  border: none;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
}

.drawer-body{
  padding: 16px;
  overflow-y: auto;
}

.drawer-meta{
  font-size: 13px;
  color: #cbd5e1;
  margin-bottom: 12px;
}

.remark-box{
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.remark-box.reject{
  background: rgba(255,68,68,.15);
  border-left: 4px solid #ff4444;
}

.remark-box.normal{
  background: rgba(25,118,210,.15);
  border-left: 4px solid #1976d2;
}

.remark-title{
  font-weight: 700;
  margin-bottom: 6px;
}
/* ===== ç›ˆäºé«˜äº® ===== */
.pnl-card{
  position: relative;
  border-radius: 10px;
  padding: 14px;
  color: #fff;
  font-weight: 700;
  overflow: hidden;
}

.pnl-positive{
  background: linear-gradient(135deg,#00c851,#00e676);
  box-shadow: 0 0 18px rgba(0,200,81,.45);
}

.pnl-negative{
  background: linear-gradient(135deg,#ff4444,#ff6b6b);
  box-shadow: 0 0 18px rgba(255,68,68,.45);
}

.pnl-value{
  font-size: 22px;
  margin-top: 6px;
  letter-spacing: .5px;
}

.pnl-sub{
  font-size: 12px;
  opacity: .9;
}

.pnl-flash{
  animation: pnlPulse 1.6s infinite;
}

@keyframes pnlPulse{
  0%{box-shadow:0 0 10px rgba(255,255,255,.15)}
  50%{box-shadow:0 0 24px rgba(255,255,255,.55)}
  100%{box-shadow:0 0 10px rgba(255,255,255,.15)}
}

</style>
</head>

<body>
<div class="top-header">
  <div class="brand">NEXBIT ç®¡ç†åå°ï¼ˆä»£ç†ï¼‰</div>
  <div class="user">
    <span id="adminUser">admin</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>


<div class="app">

  <div class="sidebar">
    <div class="icon active" data-page="dashboard" title="æ§åˆ¶å°">ğŸ </div>

    <div class="icon buysell" data-page="buysell" title="BuySellï¼ˆå¸¸æ˜¾ï¼‰">ğŸ’±
      <div style="font-size:11px;margin-top:6px;color:#cfe6ff">BuySell</div>
    </div>

    <div class="icon" data-page="recharge" title="å……å€¼ç®¡ç†">ğŸ’³</div>
    <div class="icon" data-page="withdraw" title="ææ¬¾ç®¡ç†">ğŸ’¸</div>
    <div class="icon" data-page="members" title="ä¼šå‘˜ç®¡ç†">ğŸ‘¥</div>
    <div class="icon" data-page="orders" title="è®¢å•è®°å½•">ğŸ“œ</div>
    <div class="icon" data-page="settings" title="ç³»ç»Ÿè®¾ç½®">âš™ï¸</div>
  </div>

  <div class="main">

    <!-- Dashboard -->
    <div id="page-dashboard" class="container">
      <div class="page-title">æ§åˆ¶å°</div>

      <div class="grid">
  <div class="card">
    ä»Šæ—¥å……å€¼<br>
    <strong id="todayRecharge">--</strong>
    <div class="small">USDTï¼š<span id="todayRechargeSum">--</span></div>
  </div>

  <div class="card">
    ä»Šæ—¥ææ¬¾<br>
    <strong id="todayWithdraw">--</strong>
    <div class="small">USDTï¼š<span id="todayWithdrawSum">--</span></div>
  </div>

  <div class="card">
    BuySell<br>
    <strong id="todayOrders">--</strong>
    <div class="small">USDTï¼š<span id="todayBuySellSum">--</span></div>
  </div>
<div class="card pnl-card" id="pnlCard">
  æ€»ç›ˆäº
  <div class="pnl-value" id="pnlValue">--</div>
  <div class="pnl-sub">USDTï¼ˆå®æ—¶ï¼‰</div>
</div>

  <div class="card">
    é£æ§é¢„è­¦<br>
    <strong id="alertsCount">--</strong>
  </div>
</div>


      <div class="container card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">ä¼šå‘˜ç­‰çº§ç»Ÿè®¡</div>
          <div class="small">æ›´æ–°äº <span id="statTime"></span></div>
        </div>
        <div style="margin-top:12px" id="memberStats"></div>
      </div>
    </div>

    <!-- BuySell page -->
    <div id="page-buysell" class="container" style="display:none">
      <div class="page-title">BuySell ç®¡ç†</div>

      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="bs_start"></label>
        <label>ç»“æŸ <input type="date" id="bs_end"></label>
        <input id="bs_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="bs_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BTC</option><option>ETH</option><option>USDT</option></select>
        <select id="bs_side"><option value="">å…¨éƒ¨</option><option value="buy">ä¹°</option><option value="sell">å–</option></select>
        <button class="primary" onclick="bs_search()">æœç´¢</button>
      </div>

      <div style="margin-bottom:8px">å®æ—¶æ±‡ç‡ï¼š<span id="tickersSummary">-</span></div>

      <table class="table table-sm">
        <thead>
          <tr>
            <th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th>
            <th>æ—¶é—´ (US/Eastern)</th>
            <th>ç±»å‹</th>
            <th>é‡‘é¢</th>
            <th>å¸ç§</th>
            <th>ä¼°ç®— USDT</th>
            <th>wallet</th>
            <th>IP</th>
            <th>TP/SL</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
            <th>å¤‡æ³¨</th>
          </tr>
        </thead>

        <tbody id="bs_table"><tr><td colspan="12" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Recharge page -->
    <div id="page-recharge" class="container" style="display:none">
      <div class="page-title">å……å€¼ç®¡ç†</div>

      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="r_start"></label>
        <label>ç»“æŸ <input type="date" id="r_end"></label>
        <input id="r_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="r_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <select id="r_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="processing">å¤„ç†ä¸­</option><option value="success">æˆåŠŸ</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="r_search()">æœç´¢</button>
      </div>

      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>ä¼°ç®— USDT</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th><th>å¤‡æ³¨</th></tr></thead>
        <tbody id="r_table"><tr><td colspan="11" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Withdraw page -->
    <div id="page-withdraw" class="container" style="display:none">
      <div class="page-title">ææ¬¾ç®¡ç†</div>

      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="w_start"></label>
        <label>ç»“æŸ <input type="date" id="w_end"></label>
        <input id="w_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="w_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <select id="w_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="processing">å¤„ç†ä¸­</option><option value="success">æˆåŠŸ</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="w_search()">æœç´¢</button>
      </div>

      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>ä¼°ç®— USDT</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th><th>å¤‡æ³¨</th></thead>
        <tbody id="w_table"><tr><td colspan="11" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Members page -->
    <div id="page-members" class="container" style="display:none">
      <div class="page-title">ä¼šå‘˜ç®¡ç†</div>
      <div class="filters">
        <input id="m_search" placeholder="ä¼šå‘˜ID / é’±åŒ…åœ°å€" style="width:260px">
        <button onclick="loadMembers()">æœç´¢</button>
      </div>
      <table class="table">
        <thead><tr><th>ä¼šå‘˜ID</th><th>wallet</th><th>æœ€è¿‘æ´»åŠ¨</th></tr></thead>
        <tbody id="m_table"><tr><td colspan="3" class="small">æš‚æ— æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Orders page -->
    <div id="page-orders" class="container" style="display:none">
      <div class="page-title">è®¢å•è®°å½•ï¼ˆå……å€¼/ææ¬¾/ä¹°å–ï¼‰</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="o_start"></label>
        <label>ç»“æŸ <input type="date" id="o_end"></label>
        <input id="o_q" placeholder="è®¢å•å· / ä¼šå‘˜ID / é’±åŒ…åœ°å€" style="width:260px">
        <select id="o_type"><option value="">å…¨éƒ¨ç±»å‹</option><option value="recharge">å……å€¼</option><option value="withdraw">ææ¬¾</option><option value="trade">ä¹°å–</option></select>
        <button class="primary" onclick="o_search()">æœç´¢</button>
      </div>
      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="o_table"><tr><td colspan="11" class="small">æš‚æ— æ•°æ®</td></tr></tbody>
      </table>
    </div>
    <!-- ===============================
     ç³»ç»Ÿè®¾ç½® / ç®¡ç†å‘˜ç®¡ç†
=============================== -->
<div id="page-settings" class="container" style="display:none">

  <div class="page-title">ç³»ç»Ÿè®¾ç½®</div>

  <!-- ç®¡ç†å‘˜è´¦å·ç®¡ç† -->
  <div class="card" style="margin-bottom:16px">
    <div class="page-title" style="font-size:16px">ç®¡ç†å‘˜è´¦å·ç®¡ç†</div>

    <div class="filters">
      <input id="newAdminId" placeholder="ç®¡ç†å‘˜è´¦å·">
      <input id="newAdminPassword" placeholder="åˆå§‹å¯†ç ">

      <label><input type="checkbox" value="recharge"> å……å€¼</label>
      <label><input type="checkbox" value="withdraw"> ææ¬¾</label>
      <label><input type="checkbox" value="buysell"> BuySell</label>

      <button class="primary" onclick="createAdmin()">æ–°å¢ç®¡ç†å‘˜</button>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>è´¦å·</th>
          <th>æƒé™</th>
          <th>çŠ¶æ€</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="adminTable">
        <tr><td colspan="4">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
<!-- Google äºŒçº§éªŒè¯ç  -->
<div class="card" style="margin-top:16px">
  <div class="page-title" style="font-size:16px">Google äºŒçº§éªŒè¯ç ï¼ˆ2FAï¼‰</div>

  <div class="filters">
    <input id="gaAdminId" placeholder="ç®¡ç†å‘˜è´¦å·">
    <button class="primary" onclick="generateGoogle2FA()">ç”Ÿæˆç»‘å®š</button>
  </div>

  <div id="gaBox" style="display:none;margin-top:12px">
    <div class="small">è¯·ä½¿ç”¨ Google Authenticator æ‰«ç ï¼š</div>
    <img id="gaQr" style="margin:8px 0">
    <input id="gaCode" placeholder="è¾“å…¥ 6 ä½éªŒè¯ç ">
    <button class="primary" onclick="verifyGoogle2FA()">ç¡®è®¤ç»‘å®š</button>
  </div>
</div>

<!-- ç®¡ç†å‘˜å¯†ç é‡ç½® -->
<div class="card" style="margin-bottom:16px">
  <div class="page-title" style="font-size:16px">é‡ç½®ç®¡ç†å‘˜ç™»å½•å¯†ç </div>

  <div class="filters">
    <input id="resetAdminId" placeholder="ç®¡ç†å‘˜è´¦å·">
    <input id="resetAdminPassword" placeholder="æ–°ç™»å½•å¯†ç ">
    <button class="primary" onclick="resetAdminLoginPassword()">é‡ç½®</button>
  </div>
</div>

  <!-- ç”¨æˆ·ææ¬¾å¯†ç é‡ç½® -->
  <div class="card">
    <div class="page-title" style="font-size:16px">é‡ç½®ç”¨æˆ·ææ¬¾å¯†ç </div>

    <div class="filters">
      <input id="searchWithdrawWallet" placeholder="å·²ææ¬¾çš„é’±åŒ…åœ°å€">
<input id="searchWithdrawOrder" placeholder="è®¢å•å·ï¼ˆå¯é€‰ï¼‰">
<input id="newWithdrawPassword" placeholder="æ–°ææ¬¾å¯†ç ">
<button class="primary" onclick="resetWithdrawPassword()">é‡ç½®</button>

    </div>
  </div>

</div>

    <div class="footer-note">ç³»ç»Ÿç”Ÿæˆï¼š<span id="genTime"></span></div>
  </div>
</div>

<!-- Wallet modal -->
<div class="modal" id="walletModal" onclick="closeWallet()"><div class="box" onclick="event.stopPropagation()"><div style="font-weight:700;margin-bottom:8px">é’±åŒ…åœ°å€</div><div id="walletAddr" style="font-size:14px;word-break:break-all"></div><button onclick="closeWallet()" style="margin-top:12px;padding:6px 12px">å…³é—­</button></div></div>

<!-- Order Detail Modal -->
<div id="orderDetailModal" class="order-detail-modal" onclick="closeOrderDetail()">
  <div class="box" onclick="event.stopPropagation()">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">è®¢å•è¯¦æƒ… <span id="orderDetailId"></span></div>
      <div><button onclick="closeOrderDetail()" style="padding:6px 10px">å…³é—­</button></div>
    </div>
    <div style="margin-top:10px">
      <div style="font-weight:600">åŸå§‹æ•°æ®</div>
      <pre id="orderRawJson">{}</pre>
    </div>
    <div style="margin-top:8px">
      <div style="font-weight:600">æ“ä½œè®°å½•</div>
      <pre id="orderActions">æ— æ“ä½œè®°å½•</pre>
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" class="admin-login-modal" onclick="closeAdminLogin()">
  <div class="box" onclick="event.stopPropagation()">
    <div style="font-weight:700;margin-bottom:8px">ç®¡ç†å‘˜ç™»å½•</div>
    <div style="margin-bottom:8px">
      <input id="adminName" placeholder="ç®¡ç†å‘˜ID" style="width:100%;margin-bottom:8px;padding:8px" />
      <input id="adminPassword" type="password" placeholder="å¯†ç " style="width:100%;padding:8px" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button onclick="submitAdminLogin()" class="primary">ç™»å½•</button>
      <button onclick="closeAdminLogin()">å–æ¶ˆ</button>
    </div>
    <div style="margin-top:8px;font-size:12px;color:#666">æç¤ºï¼šç®¡ç†å‘˜å¯ä»¥é€šè¿‡åç«¯ /api/admin/create åˆ›å»ºæ–°è´¦å·ã€‚</div>
  </div>
</div>
<!-- å¤‡æ³¨ Drawer -->
<div id="remarkDrawer" class="remark-drawer">
  <div class="drawer-header">
    <span>å¤‡æ³¨è¯¦æƒ…</span>
    <button onclick="closeRemarkDrawer()">âœ•</button>
  </div>

  <div class="drawer-body">
    <div class="drawer-meta">
      <div>è®¢å•å·ï¼š<span id="rd-order"></span></div>
      <div>ç±»å‹ï¼š<span id="rd-type"></span></div>
      <div>æ—¶é—´ï¼š<span id="rd-time"></span></div>
    </div>
<!-- ===== è®¢å•è¯¦æƒ… ===== -->
<div class="rd-block rd-detail">

  <div class="rd-row">
    <span class="rd-label">æ–¹å‘</span>
    <span id="rd-side" class="rd-value">--</span>
  </div>

  <div class="rd-row">
    <span class="rd-label">é‡‘é¢</span>
    <span id="rd-amount" class="rd-value">--</span>
  </div>

  <div class="rd-row">
    <span class="rd-label">ä¼°ç®— USDT</span>
    <span id="rd-estimate" class="rd-value">--</span>
  </div>

  <div class="rd-row">
    <span class="rd-label">TP / SL</span>
    <span id="rd-tpsl" class="rd-value">--</span>
  </div>

  <div class="rd-row">
    <span class="rd-label">çŠ¶æ€</span>
    <span id="rd-status" class="rd-value">--</span>
  </div>

  <div class="rd-row">
    <span class="rd-label">Wallet</span>
    <span id="rd-wallet" class="rd-value">--</span>
  </div>

  <div class="rd-row">
    <span class="rd-label">IP</span>
    <span id="rd-ip" class="rd-value">--</span>
  </div>

</div>

    <div id="rd-reject-box" class="remark-box reject" style="display:none">
      <div class="remark-title">æ‹’ç»åŸå› </div>
      <div id="rd-reject"></div>
    </div>

    <div id="rd-note-box" class="remark-box normal" style="display:none">
      <div class="remark-title">æ™®é€šå¤‡æ³¨</div>
      <div id="rd-note"></div>
    </div>
  </div>
</div>

<script>
/* -----------------------------
   åç«¯ API
------------------------------ */
const API_TRANSACTIONS = '/api/transactions';
const API_UPDATE = '/api/transaction/update';

/* helpers */
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.from(document.querySelectorAll(s)); }
// ===== Dashboard ä»Šæ—¥æ—¶é—´èŒƒå›´ =====
function getTodayRange(){
  const now = new Date();
  const start = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate(),
    0, 0, 0
  );
  const end = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate(),
    23, 59, 59
  );
  return { start, end };
}
// ===== åˆ¤æ–­è®¢å•æ˜¯å¦å±äºä»Šå¤© =====
function isTodayOrder(o){
  const t = o.time_us || o.time || o.createdAt;
  if(!t) return false;

  const d = new Date(t);
  const { start, end } = getTodayRange();
  return d >= start && d <= end;
}

/* ===== å‰ç«¯çœŸå®è¿‡æ»¤é€»è¾‘ï¼ˆæ–°å¢ï¼‰===== */
function applyFilters(list, {
  start, end, q, currency, status, side
}) {
  return list.filter(o => {

   
    // 1ï¸âƒ£ æ—¶é—´è¿‡æ»¤ï¼ˆå…¼å®¹æ‰€æœ‰æ—¶é—´å­—æ®µï¼‰
const t = o.time_us || o.time || o.createdAt;

if (start && t && new Date(t) < new Date(start)) return false;
if (end && t && new Date(t) > new Date(end + ' 23:59:59')) return false;


    // 2ï¸âƒ£ å…³é”®å­—æœç´¢ï¼ˆè®¢å• / ä¼šå‘˜ / é’±åŒ…ï¼‰
    if (q) {
      const key = q.toLowerCase();
      const hay = `
        ${o.orderId || ''}
        ${o.userId || ''}
        ${o.wallet || ''}
      `.toLowerCase();
      if (!hay.includes(key)) return false;
    }

    // 3ï¸âƒ£ å¸ç§è¿‡æ»¤
   if (currency) {
  const coin = (o.coin || o.currency || '').toUpperCase();
  if (coin !== currency.toUpperCase()) return false;
}

    // 4ï¸âƒ£ çŠ¶æ€è¿‡æ»¤
    if (status && o.status !== status) return false;

    // 5ï¸âƒ£ ä¹°å–æ–¹å‘ï¼ˆBuySell ä¸“ç”¨ï¼‰
    if (side && o.side !== side) return false;

    return true;
  });
}
/* ===============================
   âœ… type ç»Ÿä¸€æ˜ å°„ï¼ˆæ–°å¢ï¼‰
=============================== */
function normalizeType(t){
  if(!t) return t;
  if(t === 'ææ¬¾' || t === 'æç°') return 'withdraw';
  if(t === 'å……å€¼') return 'recharge';
  if(t === 'ä¹°å–') return 'buysell';
  return String(t).toLowerCase().trim();
}
/* -----------------------------
   US/Eastern æ—¶é—´æ˜¾ç¤º
------------------------------ */


/* Binance websocket (tickers) */
const watchedSymbols = ['BTCUSDT','ETHUSDT','LTCUSDT','BCHUSDT','XRPUSDT'];
const priceMap = {}; let bsock = null;
function connectBinance(){
  try{
    const streams = watchedSymbols.map(s=>s.toLowerCase()+'@trade').join('/');
    bsock = new WebSocket('wss://stream.binance.com:9443/stream?streams=' + streams);
    bsock.onmessage = ev=>{
      const msg = JSON.parse(ev.data);
      const d = msg.data || msg;
      const sym = (d.s||'').toUpperCase(); const p = Number(d.p || d.P || d.price || 0);
      if(sym && p){ priceMap[sym]=p; updateTickSummary(); }
    };
    bsock.onclose = ()=> setTimeout(connectBinance,3000);
  }catch(e){}
}
connectBinance();
function updateTickSummary(){ $('#tickersSummary').innerText = watchedSymbols.map(s=> `${s}: ${priceMap[s]?priceMap[s].toFixed(6):'--'}`).join(' | '); }

/* -----------------------------
   Page control
------------------------------ */
$all(".sidebar .icon").forEach(ic=>{
  ic.addEventListener("click", ()=>{
    $all(".sidebar .icon").forEach(x=>x.classList.remove("active"));
    ic.classList.add("active");
    const page = ic.getAttribute("data-page");
    hideAllPages();
    const el = document.getElementById("page-" + page);
    if(el) el.style.display = "block";
    if(page === "dashboard") loadDashboard();
    if(page === "recharge") r_search();
    if(page === "withdraw") w_search();
    if(page === "buysell") bs_search();
    if(page === "orders") o_search();
    if(page === "members") loadMembers();
  });
});
function hideAllPages(){ $all(".main > .container").forEach(c=>c.style.display="none"); }

/* -----------------------------
   Fetch all orders helper
------------------------------ */
async function fetchAll(params = {}) {
  const url = new URL(API_TRANSACTIONS, window.location.origin);
  Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
  const res = await fetch(url.toString(), {
    headers: authHeaders()   // âœ… å…³é”®å°±åœ¨è¿™ä¸€è¡Œ
  });
  return await res.json();
}


/* -----------------------------
   Admin auth helpers (token stored in localStorage)
------------------------------ */
const ADMIN_TOKEN_KEY = 'nexbit_admin_token';
function setAdminToken(t){ try{ localStorage.setItem(ADMIN_TOKEN_KEY, t); }catch(e){} }
function getAdminToken(){ try{ return localStorage.getItem(ADMIN_TOKEN_KEY); }catch(e){ return null; } }
function authHeaders(){ const t = getAdminToken(); return t ? { 'Content-Type':'application/json', 'Authorization':'Bearer ' + t } : { 'Content-Type':'application/json' }; }

async function ensureLoggedIn(){
  if(getAdminToken()) return true;
  document.getElementById('adminLoginModal').style.display = 'flex';
  return false;
}
function closeAdminLogin(){ document.getElementById('adminLoginModal').style.display = 'none'; }
async function submitAdminLogin(){
  const id = document.getElementById('adminName').value.trim();
  const pw = document.getElementById('adminPassword').value;
  if(!id || !pw) return alert('è¯·è¾“å…¥ç®¡ç†å‘˜IDä¸å¯†ç ');
  try{
    const r = await fetch('/api/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, password: pw }) });
    const j = await r.json();
    if(j.ok && j.token){ setAdminToken(j.token); closeAdminLogin(); alert('ç™»å½•æˆåŠŸ'); loadDashboard(); }
    else alert('ç™»å½•å¤±è´¥: ' + (j.error || 'æœªçŸ¥'));
  }catch(e){ alert('ç™»å½•è¯·æ±‚å¤±è´¥'); }
}

/* -----------------------------
   Render action buttons (all orders)
------------------------------ */
function renderActionButtons(orderId, type, processed, status){
  try{
    const active = document.querySelector('.sidebar .icon.active')?.getAttribute('data-page') || '';
    if(active === 'orders') return '';
  }catch(e){}

  const disabledAttr = processed ? 'disabled' : '';

  return `
    <button class="small-btn confirm-btn"
  onclick="txAction(this,'${orderId}','${type}','approve')">
  é€šè¿‡âœ”
</button>

    <button class="small-btn cancel-btn" ${disabledAttr}
  onclick="txAction(this,'${orderId}','${type}','reject')">
  æ‹’ç»âŒ
</button>

   <button class="small-btn lock-btn"
  onclick="txAction(this,'${orderId}','${type}','lock')">
  é”å®šğŸ”’
</button>

    <button class="small-btn unlock-btn"
  onclick="txAction(this,'${orderId}','${type}','unlock')">
  å·²è§£é”ğŸ”“
</button>

    <button class="small-btn"
  onclick="addRemark('${orderId}','${type}','${status}')">
  å¤‡æ³¨ğŸ“
</button>

  `;
}
/* -----------------------------
   Core: txAction (use authHeaders)
------------------------------ */
async function txAction(btn, orderId, type, action){
  if(!orderId) return alert('ç¼ºå°‘è®¢å•ID');

  // âœ… ç«‹å³é”æŒ‰é’®ï¼ˆé˜²è¿ç‚¹ï¼‰
  if(btn){
    btn.disabled = true;
    btn.classList.add('btn-disabled');
  }

  // ç¡®è®¤æ¡†
  if(!confirm(`ç¡®å®šå¯¹è®¢å• ${orderId} æ‰§è¡Œï¼š${action} å—ï¼Ÿ`)){
    if(btn) btn.disabled = false;
    return;
  }

  // ç™»å½•æ£€æŸ¥
  if(!getAdminToken()){
    await ensureLoggedIn();
    if(!getAdminToken()){
      if(btn) btn.disabled = false;
      return;
    }
  }

 // çŠ¶æ€æ˜ å°„ï¼ˆè¿™æ®µä¿ç•™ï¼‰
const finalStatus =
  action === 'approve' ? 'success' :
  action === 'reject'  ? 'failed'  :
  action === 'lock'    ? 'locked'  :
  'processing';

// å¤‡æ³¨é€»è¾‘
let note = action;
if(action === 'reject'){
  note = prompt('è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå¿…å¡«ï¼‰');
  if(!note){
    if(btn) btn.disabled = false;
    return;
  }
}

// âœ… çœŸæ­£å‘é€çš„å†…å®¹ï¼ˆé‡ç‚¹ï¼‰
const body = {
  orderId,
  type: normalizeType(type),
  status: finalStatus,   // âœ… å¿…é¡»ç”¨ finalStatus
  note                  // âœ… ç”¨ä¸Šé¢ç®—å‡ºæ¥çš„ note
};


  try{
    const r = await fetch(API_UPDATE,{
      method:'POST',
      headers: authHeaders(),
      body: JSON.stringify(body)
    });
    const j = await r.json();

    if(j.ok){
      const active = document.querySelector('.sidebar .icon.active').dataset.page;
      if(active==='recharge') r_search();
      else if(active==='withdraw') w_search();
      else if(active==='buysell') bs_search();
      else o_search();
    }else{
      alert('æ“ä½œå¤±è´¥');
      if(btn) btn.disabled = false;
    }
  }catch(e){
    alert('æœåŠ¡å™¨é”™è¯¯');
    if(btn) btn.disabled = false;
  }
}
async function addRemark(orderId, type, currentStatus){
  if(!orderId) return;

  if(!getAdminToken()){
    await ensureLoggedIn();
    if(!getAdminToken()) return;
  }

  const remark = prompt('è¯·è¾“å…¥å¤‡æ³¨å†…å®¹ï¼ˆä»…åå°å¯è§ï¼‰ï¼š');
  if(!remark) return;

  const statusSafe = currentStatus || 'processing';

  const body = {
    orderId,
    type: normalizeType(type),
    status: statusSafe,
    note: remark
  };

  try{
    const r = await fetch(API_UPDATE,{
      method:'POST',
      headers: authHeaders(),
      body: JSON.stringify(body)
    });
    const j = await r.json();

    if(j.ok){
      alert('å¤‡æ³¨å·²ä¿å­˜');

      const active = document.querySelector('.sidebar .icon.active')?.dataset.page;
      if(active === 'recharge') r_search();
      else if(active === 'withdraw') w_search();
      else if(active === 'buysell') bs_search();
      else o_search();

    }else{
      alert('å¤‡æ³¨å¤±è´¥ï¼š' + (j.error || 'æœªçŸ¥é”™è¯¯'));
    }

  }catch(e){
    console.error(e);
    alert('å¤‡æ³¨è¯·æ±‚å¼‚å¸¸');
  }
}
function openRemarkFromRow(el){
  try{
    const data = JSON.parse(
      decodeURIComponent(
        escape(
          atob(el.dataset.remark)
        )
      )
    );
    openRemarkDrawer(data);
  }catch(e){
    console.error('remark parse error', e);
    alert('å¤‡æ³¨æ•°æ®è§£æå¤±è´¥');
  }
}
let currentRemarkData = null;
function openRemarkDrawer(data){
  console.log('openRemarkDrawer', data);
  if(!data) return;

  const drawer = document.getElementById('remarkDrawer');
  if(!drawer) return;

  drawer.classList.add('open');

  // ===== meta =====
  document.getElementById('rd-order').innerText = data.orderId || '--';
  document.getElementById('rd-type').innerText  = data.type || '--';
  document.getElementById('rd-time').innerText  = data.time || '--';

  // ===== è®¢å•æ ¸å¿ƒä¿¡æ¯ï¼ˆæ–°å¢ï¼‰=====
  document.getElementById('rd-side').innerText =
    data.side ? data.side.toUpperCase() : '--';

  document.getElementById('rd-amount').innerText =
    (data.amount && data.coin)
      ? `${data.amount} ${data.coin}`
      : '--';

  document.getElementById('rd-estimate').innerText =
    data.estimate ? `${data.estimate} USDT` : '--';

  document.getElementById('rd-tpsl').innerText =
    (data.tp || '-') + ' / ' + (data.sl || '-');

  document.getElementById('rd-status').innerText =
    data.status || '--';

  document.getElementById('rd-wallet').innerText =
    data.wallet || '--';

  document.getElementById('rd-ip').innerText =
    data.ip || '--';

  // ===== æ‹’ç»åŸå›  =====
  const rejectBox = document.getElementById('rd-reject-box');
  const rejectText = document.getElementById('rd-reject');

  if (data.reject) {
    rejectBox.style.display = 'block';
    rejectText.innerText = data.reject;
  } else {
    rejectBox.style.display = 'none';
    rejectText.innerText = '';
  }

  // ===== æ™®é€šå¤‡æ³¨ =====
  const noteBox = document.getElementById('rd-note-box');
  const noteText = document.getElementById('rd-note');

  if (data.note) {
    noteBox.style.display = 'block';
    noteText.innerText = data.note;
  } else {
    noteBox.style.display = 'none';
    noteText.innerText = '';
  }
}
// âœ… åªä¿ç•™è¿™ä¸€ä¸ª
function closeRemarkDrawer(){
  document.getElementById('remarkDrawer')?.classList.remove('open');
}

/* -----------------------------
   Render rows for each type
------------------------------ */
function renderBuySellRow(o){
  return `
<tr>
  <td><div class="order-id">${o.orderId}</div><div class="small">${o.userId}</div></td>
  <td>${o.time_us || o.time || o.createdAt || '--'}</td>
  <td>${o.side}</td>
  <td>${o.amount}</td>
  <td>${o.coin}</td>
  <td>${o.estimate || '--'}</td>
  <td>${o.wallet || '--'}</td>
  <td>${o.ip || '--'}</td>
  <td>${(o.tp||'-')}/${(o.sl||'-')}</td>
  <td>
    <span class="badge">${o.status}</span>
  </td>
  <td>${renderActionButtons(o.orderId,'buysell', o.processed, o.status)}</td>
  <td>
${
  o.note
  ? (() => {
      const remarkData = btoa(
        unescape(
          encodeURIComponent(
            JSON.stringify({
              // åŸºæœ¬
              orderId: o.orderId,
              type: 'buysell',
              time: o.time_us || '',

              // ğŸ”¥ è®¢å•æ ¸å¿ƒä¿¡æ¯
              side: o.side,
              amount: o.amount,
              coin: o.coin,
              estimate: o.estimate,
              tp: o.tp,
              sl: o.sl,
              wallet: o.wallet,
              ip: o.ip,
              status: o.status,

              // å¤‡æ³¨
              note: o.note
            })
          )
        )
      );

      return `
        <span
          style="color:#1976d2;cursor:pointer"
          data-remark="${remarkData}"
          onclick="openRemarkFromRow(this)"
        >æŸ¥çœ‹</span>
      `;
    })()
  : '--'
}
</td>

</tr>`;
}

function renderRechargeRow(o){
  return `
<tr>
  <td><div class="order-id">${o.orderId}</div><div class="small">${o.userId}</div></td>
  <td>${o.time_us || '--'}</td>
  <td>å……å€¼</td>
  <td>${o.amount}</td>
  <td>${o.coin || '--'}</td>
  <td>${o.estimate ?? '--'}</td>
  <td>${o.wallet || '--'}</td>
  <td>${o.ip || '--'}</td>
  <td><span class="badge">${o.status}</span></td>
  <td>${renderActionButtons(o.orderId,'recharge', o.processed, o.status)}</td>
  <td>
${
  o.note
  ? (() => {
      const remarkData = btoa(
        unescape(
          encodeURIComponent(
            JSON.stringify({
              // åŸºæœ¬
              orderId: o.orderId,
              type: 'recharge',
              time: o.time_us || '',

              // ğŸ”¥ è®¢å•æ ¸å¿ƒä¿¡æ¯
              side: o.side,
              amount: o.amount,
              coin: o.coin,
              estimate: o.estimate,
              tp: o.tp,
              sl: o.sl,
              wallet: o.wallet,
              ip: o.ip,
              status: o.status,

              // å¤‡æ³¨
              note: o.note
            })
          )
        )
      );

      return `
        <span
          style="color:#1976d2;cursor:pointer"
          data-remark="${remarkData}"
          onclick="openRemarkFromRow(this)"
        >æŸ¥çœ‹</span>
      `;
    })()
  : '--'
}
</td>

</tr>`;
}
function renderWithdrawRow(o){
  return `
<tr>
  <td><div class="order-id">${o.orderId}</div><div class="small">${o.userId}</div></td>
  <td>${o.time_us || '--'}</td>
  <td>ææ¬¾</td>
  <td>${o.amount}</td>
  <td>${o.coin || '--'}</td>
  <td>${o.estimate ?? '--'}</td>
  <td>${o.wallet || '--'}</td>
  <td>${o.ip || '--'}</td>
  <td><span class="badge">${o.status}</span></td>
  <td>${renderActionButtons(o.orderId,'withdraw', o.processed, o.status)}</td>
 <td>
${
  o.note
  ? (() => {
      const remarkData = btoa(
        unescape(
          encodeURIComponent(
            JSON.stringify({
              // åŸºæœ¬
              orderId: o.orderId,
              type: 'withdraw',
              time: o.time_us || '',

              // ğŸ”¥ è®¢å•æ ¸å¿ƒä¿¡æ¯
              side: o.side,
              amount: o.amount,
              coin: o.coin,
              estimate: o.estimate,
              tp: o.tp,
              sl: o.sl,
              wallet: o.wallet,
              ip: o.ip,
              status: o.status,

              // å¤‡æ³¨
              note: o.note
            })
          )
        )
      );

      return `
        <span
          style="color:#1976d2;cursor:pointer"
          data-remark="${remarkData}"
          onclick="openRemarkFromRow(this)"
        >æŸ¥çœ‹</span>
      `;
    })()
  : '--'
}
</td>

</tr>`;
}
/* -----------------------------
   Fetch single order for modal (server handles fetchOrder)
------------------------------ */
async function fetchOrderDetail(id){
  try{
    const res = await fetch(`/api/transactions?fetchOrder=${encodeURIComponent(id)}`);
    return await res.json();
  }catch(e){ return { ok:false }; }
}

/* -----------------------------
   Order detail modal functions
------------------------------ */
function openOrderDetail(order){
  if(!order) return;
  document.getElementById('orderDetailModal').style.display = 'flex';
  document.getElementById('orderDetailId').innerText = order.orderId || '';
  document.getElementById('orderRawJson').innerText = JSON.stringify(order, null, 2);
  // fetch actions
  fetch(`/api/transactions?fetchOrder=${encodeURIComponent(order.orderId)}`).then(r=>r.json()).then(j=>{
    if(j.ok && j.orderEvents && j.orderEvents.length) document.getElementById('orderActions').innerText = JSON.stringify(j.orderEvents, null, 2);
    else document.getElementById('orderActions').innerText = 'æ— æ“ä½œè®°å½•';
  }).catch(()=>{ document.getElementById('orderActions').innerText = 'æ— æ³•è·å–æ“ä½œè®°å½•'; });
}
function closeOrderDetail(){ document.getElementById('orderDetailModal').style.display = 'none'; }

/* -----------------------------
   Bind clickable order IDs after rendering
------------------------------ */
function bindOrderRowClicks(selector){
  const container = document.querySelector(selector);
  if(!container) return;
  container.querySelectorAll('tr').forEach(tr=>{
    const idCell = tr.querySelector('td div.order-id');
    if(idCell){
      const id = idCell.textContent.trim();
      idCell.style.cursor = 'pointer';
      idCell.style.textDecoration = 'underline';
      idCell.onclick = async ()=>{
        const j = await fetchOrderDetail(id);
        if(j.ok && j.order) openOrderDetail(j.order); else openOrderDetail({ orderId: id });
      };
    }
  });
}

/* -----------------------------
   post-render decorate (highlight & bind)
------------------------------ */
function postRenderDecorate(){
  ['#bs_table','#r_table','#w_table','#o_table'].forEach(sel=>{
    const tb = document.querySelector(sel);
    if(!tb) return;
    bindOrderRowClicks(sel);
    tb.querySelectorAll('tr').forEach(tr=>{
      const txt = tr.innerText.toLowerCase();
      if(txt.includes('locked') || txt.includes('failed')){
        tr.classList.add('tr-alert');
      } else {
        tr.classList.remove('tr-alert');
      }
    });
  });
}

/* -----------------------------
   SSE realtime orders
------------------------------ */
let orderEventSource = null;

function connectOrderSSE(){
  try{
    if(orderEventSource) orderEventSource.close();

    orderEventSource = new EventSource('/api/orders/stream');

    orderEventSource.onmessage = function(ev){
      try{
        const d = JSON.parse(ev.data);
        if(d && d.order){

          // flash alert if locked/failed
          if(d.order.status === 'locked' || d.order.status === 'failed'){
            let badge = document.getElementById('globalAlertBadge');
            if(!badge){
              badge = document.createElement('span');
              badge.id = 'globalAlertBadge';
              badge.className = 'badge-alert flash';
              badge.innerText = 'å¼‚å¸¸è®¢å•';
              document
                .querySelector('.top-header .user')
                .appendChild(badge);
            }
          }

          // refresh active page
          const active = document
            .querySelector('.sidebar .icon.active')
            ?.getAttribute('data-page');

          if(active === 'recharge'){
            r_search();
          }
          else if(active === 'withdraw'){
            w_search();
          }
          else if(active === 'buysell'){
            bs_search();
          }
          else if(active === 'dashboard'){
            // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šDashboard ç›ˆäºç«‹åˆ»åˆ·æ–°
            loadDashboard();
          }
          else{
            o_search();
          }
        }
      }catch(e){
        console.error(e);
      }
    };

    orderEventSource.onerror = function(){
      try{ orderEventSource.close(); }catch(e){}
      setTimeout(connectOrderSSE, 3000);
    };

  }catch(e){
    console.warn('SSE not available', e);
  }
}

connectOrderSSE();
/* -----------------------------
   Search functions (bs_search / r_search / w_search / o_search)
   Each will call postRenderDecorate() after rendering
------------------------------ */
async function bs_search(){
  const params = {};
  if($('#bs_start').value) params.start = $('#bs_start').value;
  if($('#bs_end').value) params.end = $('#bs_end').value;
  if($('#bs_wallet').value) params.q = $('#bs_wallet').value;
  if($('#bs_currency').value) params.currency = $('#bs_currency').value;
  if($('#bs_side').value) params.side = $('#bs_side').value;

  const tbody = $('#bs_table');
  tbody.innerHTML = `<tr><td colspan="12">åŠ è½½ä¸­...</td></tr>`;

  try{
    const all = await fetchAll(params);

    /* ğŸ”¥ å‰ç«¯çœŸå®è¿‡æ»¤ */
    let list = all.buysell || [];

    list = applyFilters(list, {
      start: $('#bs_start').value,
      end: $('#bs_end').value,
      q: $('#bs_wallet').value,
      currency: $('#bs_currency').value,
      side: $('#bs_side').value
    });

    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="12">æ²¡æœ‰è®°å½•</td></tr>`;
      window.buySellPNL = 0;   // âœ… ä¿è¯å˜é‡å­˜åœ¨
      return;
    }

    // ===== æ¸²æŸ“è¡¨æ ¼ =====
    tbody.innerHTML = list.map(o => renderBuySellRow(o)).join('');
    postRenderDecorate();

    // ===============================
    // âœ… BuySell ç›ˆäºç»Ÿè®¡ï¼ˆçœŸæ­£æ¥å…¥ï¼‰
    // ===============================
    const buySellPNL = list
      .filter(o => o.status === 'success')
      .reduce((sum, o) => {
        const amount = Number(o.estimate || 0);
        if (o.side === 'buy')  return sum - amount;
        if (o.side === 'sell') return sum + amount;
        return sum;
      }, 0);

    // æä¾›ç»™ Dashboard æˆ–å…¶ä»–æ¨¡å—ä½¿ç”¨
    window.buySellPNL = buySellPNL;

    console.log('ã€BuySell ç›ˆäºã€‘USDT:', buySellPNL.toFixed(2));

  }catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="12">åŠ è½½å¤±è´¥</td></tr>`;
    window.buySellPNL = 0; // å®¹é”™
  }
}

async function r_search(){
  const params = {};
  if($('#r_start').value) params.start = $('#r_start').value;
  if($('#r_end').value) params.end = $('#r_end').value;
  if($('#r_wallet').value) params.q = $('#r_wallet').value;
  if($('#r_currency').value) params.currency = $('#r_currency').value;
  if($('#r_status').value) params.status = $('#r_status').value;

  const tbody = $('#r_table');
  tbody.innerHTML = `<tr><td colspan="12">åŠ è½½ä¸­...</td></tr>`;

  try{
    const all = await fetchAll(params);

    /* ğŸ”¥ å‰ç«¯çœŸå®è¿‡æ»¤ */
    let list = all.recharge || [];

    list = applyFilters(list, {
      start: $('#r_start').value,
      end: $('#r_end').value,
      q: $('#r_wallet').value,
      currency: $('#r_currency').value,
      status: $('#r_status').value
    });

    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="9">æ²¡æœ‰è®°å½•</td></tr>`;
      window.rechargeProfit = 0;   // âœ… ä¿è¯å˜é‡å­˜åœ¨
      return;
    }

    // ===== æ¸²æŸ“è¡¨æ ¼ =====
    tbody.innerHTML = list.map(o => renderRechargeRow(o)).join('');
    postRenderDecorate();

    // ===============================
    // âœ… å……å€¼ç›ˆä½™ç»Ÿè®¡ï¼ˆçœŸæ­£æ¥å…¥ï¼‰
    // ===============================
    const rechargeProfit = list
      .filter(o => o.status === 'success')
      .reduce((sum, o) => sum + Number(o.estimate || 0), 0);

    // æä¾›ç»™ Dashboard / å…¶ä»–æ¨¡å—
    window.rechargeProfit = rechargeProfit;

    console.log('ã€å……å€¼ç›ˆä½™ã€‘USDT:', rechargeProfit.toFixed(2));

  }catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="12">åŠ è½½å¤±è´¥</td></tr>`;
    window.rechargeProfit = 0; // å®¹é”™
  }
}
async function w_search(){
  const params = {};
  if($('#w_start').value) params.start = $('#w_start').value;
  if($('#w_end').value) params.end = $('#w_end').value;
  if($('#w_wallet').value) params.q = $('#w_wallet').value;
  if($('#w_currency').value) params.currency = $('#w_currency').value;
  if($('#w_status').value) params.status = $('#w_status').value;

  const tbody = $('#w_table');
  tbody.innerHTML = `<tr><td colspan="12">åŠ è½½ä¸­...</td></tr>`;

  try{
    const all = await fetchAll(params);

    /* ğŸ”¥ å‰ç«¯çœŸå®è¿‡æ»¤ */
    let list = all.withdraw || [];

    list = applyFilters(list, {
      start: $('#w_start').value,
      end: $('#w_end').value,
      q: $('#w_wallet').value,
      currency: $('#w_currency').value,
      status: $('#w_status').value
    });

    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="12">æ²¡æœ‰è®°å½•</td></tr>`;
      window.withdrawLoss = 0;   // âœ… ä¿è¯å˜é‡å­˜åœ¨
      return;
    }

    // ===== æ¸²æŸ“è¡¨æ ¼ =====
    tbody.innerHTML = list.map(o => renderWithdrawRow(o)).join('');
    postRenderDecorate();

    // ===============================
    // âœ… ææ¬¾æ”¯å‡ºç»Ÿè®¡ï¼ˆçœŸæ­£æ¥å…¥ï¼‰
    // ===============================
    const withdrawLoss = list
      .filter(o => o.status === 'success')
      .reduce((sum, o) => sum + Number(o.estimate || 0), 0);

    // æä¾›ç»™ Dashboard / å…¶ä»–æ¨¡å—
    window.withdrawLoss = withdrawLoss;

    console.log('ã€ææ¬¾æ”¯å‡ºã€‘USDT:', withdrawLoss.toFixed(2));

  }catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="12">åŠ è½½å¤±è´¥</td></tr>`;
    window.withdrawLoss = 0; // å®¹é”™
  }
}
async function o_search(){
  const params = {};
  if($('#o_start').value) params.start = $('#o_start').value;
  if($('#o_end').value) params.end = $('#o_end').value;
  if($('#o_q').value) params.q = $('#o_q').value;
  if($('#o_type').value) params.type = $('#o_type').value;
  const tbody = $('#o_table'); tbody.innerHTML = `<tr><td colspan="12">åŠ è½½ä¸­...</td></tr>`;
  try{
    const all = await fetchAll(params);
    let rows = [
  ...(all.recharge || []).map(o => ({ ...o, _type: 'recharge' })),
  ...(all.withdraw || []).map(o => ({ ...o, _type: 'withdraw' })),
  ...(all.buysell || []).map(o => ({ ...o, _type: 'buysell' }))
];

// âœ… å‰ç«¯çœŸå®è¿‡æ»¤ï¼ˆå’Œå……å€¼ / ææ¬¾ä¸€è‡´ï¼‰
rows = applyFilters(rows, {
  start: $('#o_start').value,
  end: $('#o_end').value,
  q: $('#o_q').value
});

// âœ… ç±»å‹è¿‡æ»¤ï¼ˆè®¢å•è®°å½•ä¸“ç”¨ï¼‰
const type = $('#o_type').value;
if (type) {
  rows = rows.filter(o => o._type === type);
}

// âœ… æœ€æ–°åœ¨æœ€ä¸Šé¢
rows.sort((a, b) => {
  const ta = new Date(a.time_us || a.time || a.createdAt || 0).getTime();
  const tb = new Date(b.time_us || b.time || b.createdAt || 0).getTime();
  return tb - ta;
});


    if(!rows.length){ tbody.innerHTML = `<tr><td colspan="12">æ²¡æœ‰è®°å½•</td></tr>`; return; }
    tbody.innerHTML = rows.map(o=>{
      const type = o.side ? 'buy/sell' : o.password ? 'withdraw' : 'recharge';
      return `<tr>
        <td><div class="order-id">${o.orderId}</div><div class="small">${o.userId}</div></td>
        <td>${o.time_us || '--'}</td>
        <td>${type}</td>
        <td>${o.amount}</td>
        <td>${o.currency || o.coin || '--'}</td>
        <td>${o.wallet || '--'}</td>
        <td>${o.ip || '--'}</td>
        <td>
  <span class="badge" style="background:
    ${ o.status==='success' ? '#00c851' :
       o.status==='failed'  ? '#ff4444' :
       o.status==='locked'  ? '#ffbb33' :
       '#1976d2' };
    color:#fff;"
    ${o.status==='failed' && o.note ? `title="${o.note.replace(/"/g,'&quot;')}"` : ''}>
    ${o.status}
  </span>
</td>
      </tr>`;
    }).join('');
    postRenderDecorate();
  }catch(e){ tbody.innerHTML = `<tr><td colspan="12">åŠ è½½å¤±è´¥</td></tr>`; }
}

/* -----------------------------
   Members & Dashboard
------------------------------ */
async function loadMembers(){
  const tbody = $('#m_table'); tbody.innerHTML = `<tr><td colspan="12">åŠ è½½ä¸­...</td></tr>`;
  try{ const all = await fetchAll(); const users = all.users || {}; if(!Object.keys(users).length){ tbody.innerHTML = `<tr><td colspan="12">æš‚æ— æ•°æ®</td></tr>`; return; } tbody.innerHTML = Object.keys(users).map(uid=>`<tr><td>${uid}</td><td>${users[uid].wallet||'--'}</td><td>${users[uid].updated||'--'}</td></tr>`).join(''); }catch(e){ tbody.innerHTML = `<tr><td colspan="12">åŠ è½½å¤±è´¥</td></tr>`; }
}
async function loadDashboard(){
  try{
    const all = await fetchAll();

    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    const isSameDay = (d, base) =>
      d.getFullYear() === base.getFullYear() &&
      d.getMonth() === base.getMonth() &&
      d.getDate() === base.getDate();

    const recharge = all.recharge || [];
    const withdraw = all.withdraw || [];
    const buysell  = all.buysell  || [];

    const rToday = recharge.filter(o => isSameDay(new Date(o.time_us), today));
    const rYest  = recharge.filter(o => isSameDay(new Date(o.time_us), yesterday));

    const wToday = withdraw.filter(o => isSameDay(new Date(o.time_us), today));
    const wYest  = withdraw.filter(o => isSameDay(new Date(o.time_us), yesterday));

    const bToday = buysell.filter(o => isSameDay(new Date(o.time_us), today));
    const bYest  = buysell.filter(o => isSameDay(new Date(o.time_us), yesterday));

    const sumUSDT = arr =>
      arr.reduce((s,o)=> s + Number(o.estimate || 0), 0);

    // ===== ä»Šæ—¥ =====
    $('#todayRecharge').innerText = rToday.length;
    $('#todayWithdraw').innerText = wToday.length;
    $('#todayOrders').innerText  = bToday.length;

    $('#todayRechargeSum').innerText = sumUSDT(rToday).toFixed(2);
    $('#todayWithdrawSum').innerText = sumUSDT(wToday).toFixed(2);
    $('#todayBuySellSum').innerText  = sumUSDT(bToday).toFixed(2);

    // ===== â†‘ â†“ å¯¹æ¯” =====
    const arrow = (t,y) =>
      t > y ? 'â†‘' : t < y ? 'â†“' : 'â€“';

    $('#todayRecharge').innerText += ` ${arrow(rToday.length, rYest.length)}`;
    $('#todayWithdraw').innerText += ` ${arrow(wToday.length, wYest.length)}`;
    $('#todayOrders').innerText  += ` ${arrow(bToday.length, bYest.length)}`;

    // ===== é£æ§ =====
    const alerts =
      [...rToday, ...wToday, ...bToday]
        .filter(o => o.status === 'failed' || o.status === 'locked');

    $('#alertsCount').innerText = alerts.length;
    $('#statTime').innerText = new Date().toLocaleString();

    // ==================================================
    // ğŸ”¥ æ€»ç›ˆäºé«˜äº®æ˜¾ç¤ºï¼ˆä¿ç•™ä½ åŸæ¥çš„æ¨¡å¼ï¼‰
    // ==================================================
    const pnl =
      sumUSDT(rToday)        // ä»Šæ—¥å……å€¼
      - sumUSDT(wToday)      // ä»Šæ—¥ææ¬¾
      + (() => {
          return bToday
            .filter(o => o.status === 'success')
            .reduce((sum, o) => {
              const v = Number(o.estimate || 0);
              if (o.side === 'buy')  return sum - v;
              if (o.side === 'sell') return sum + v;
              return sum;
            }, 0);
        })();

    const pnlCard  = document.getElementById('pnlCard');
    const pnlValue = document.getElementById('pnlValue');

    if(pnlCard && pnlValue){
      pnlValue.innerText =
        (pnl >= 0 ? '+' : '') + pnl.toFixed(2);

      pnlCard.classList.remove(
        'pnl-positive',
        'pnl-negative',
        'pnl-flash'
      );

      if(pnl >= 0){
        pnlCard.classList.add('pnl-positive','pnl-flash');
      }else{
        pnlCard.classList.add('pnl-negative','pnl-flash');
      }
    }

  }catch(e){
    console.error(e);
  }
}

/* -----------------------------
   Init
------------------------------ */
  loadDashboard();

</script>
<script>
document.getElementById('logoutBtn')?.addEventListener('click', () => {
  localStorage.removeItem('nexbit_admin_token');
  localStorage.removeItem('admin_user');
  location.href = 'login.html';
});
</script>
</body>
</html>
