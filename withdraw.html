<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Withdrawal</title>

<style>
    * { box-sizing: border-box; }
    body { background-color: transparent; font-family: Arial, sans-serif; margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
    .withdraw-box { width: 100%; max-width: 450px; margin: 30px auto; padding: 25px; border-radius: 12px; background: transparent !important; color: white; }
    select, input, button {
        width: 100%; max-width: 100%; padding: 12px; margin-top: 8px;
        border-radius: 6px; border: 1px solid rgba(255,255,255,0.6);
        background: transparent !important; color: white; font-size: 15px; display: block;
    }
    select option { color: black; }
    button { cursor: pointer; font-weight: bold; border: none; background: #0099cc; }
    button:disabled { background: #444; }
    .row { display: flex; justify-content: space-between; gap: 10px; width: 100%; }
    #copyHashBtn, #submitBtn { display: none; width: 48%; }
    #usdtText { text-align: right; color: #00ff00; font-size: 13px; }
    #hashBox { color: #00ff00; margin-top: 10px; white-space: pre-line; font-size: 14px; overflow-wrap: break-word; }
</style>
</head>
<body>

<!-- ========================================================= -->
<!-- ðŸ”µ Strikingly å¤–é“¾æ³¨å…¥ç”¨æˆ·è¯†åˆ«è„šæœ¬ï¼ˆB è„šæœ¬ï¼‰ -->
<!-- ========================================================= -->
<script>
(function(){
  const USER_KEY = 'nexbit_uid_v1';
  function gen() { return 'U' + Math.random().toString(36).substr(2,4).toUpperCase(); }
  if(!localStorage.getItem(USER_KEY)) localStorage.setItem(USER_KEY, gen());
  window.STR_USER_ID = localStorage.getItem(USER_KEY);

  const externalDomains = [
    'crypto-management-production-5e04.up.railway.app',
    'www.nexbitsafe.com',
    'crypto-management-production-5e04.up.railway.app:443'
  ];

  function appendToHref(a){
    try{
      const href = a.getAttribute('href');
      if(!href) return;
      if(!/^https?:\/\//i.test(href)) return;
      const hostname = new URL(href).hostname;
      if(externalDomains.some(d => hostname.includes(d))){
        const url = new URL(href);
        if(!url.searchParams.get('userid')) url.searchParams.set('userid', window.STR_USER_ID);
        a.setAttribute('href', url.toString());
      }
    }catch(e){}
  }

  function appendToIframe(iframe){
    try{
      const src = iframe.getAttribute('src');
      if(!src) return;
      if(!/^https?:\/\//i.test(src)) return;
      const hostname = new URL(src).hostname;
      if(externalDomains.some(d => hostname.includes(d))){
        const url = new URL(src);
        if(!url.searchParams.get('userid')) url.searchParams.set('userid', window.STR_USER_ID);
        iframe.setAttribute('src', url.toString());
      }
    }catch(e){}
  }

  function scanAndPatch(){
    document.querySelectorAll('a[href]').forEach(appendToHref);
    document.querySelectorAll('iframe').forEach(appendToIframe);
  }

  document.addEventListener('DOMContentLoaded', scanAndPatch);
  const obs = new MutationObserver(scanAndPatch);
  obs.observe(document.body, {childList:true, subtree:true});

  window.addEventListener('message', function(ev){
    try{
      const allowedOrigins = [
        'https://crypto-management-production-5e04.up.railway.app',
        'https://www.nexbitsafe.com'
      ];
      if(!allowedOrigins.includes(ev.origin)) return;
      if(ev.data && ev.data.type === 'GET_USER_ID'){
        ev.source.postMessage({type:'USER_ID', userid: window.STR_USER_ID}, ev.origin);
      }
    }catch(e){}
  }, false);

})();
</script>
<!-- ========================================================= -->
<!-- B è„šæœ¬ç»“æŸ -->
<!-- ========================================================= -->

<div class="withdraw-box">
    <h2 style="text-align:center;"></h2>

    <label>Select Cryptocurrency</label>
    <select id="coin" onchange="updateUSDT()">
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
        <option value="USDT">USDT</option>
        <option value="BNB">BNB</option>
        <option value="XRP">XRP</option>
        <option value="ADA">ADA</option>
        <option value="SOL">SOL</option>
        <option value="DOGE">DOGE</option>
        <option value="TRX">TRX</option>
        <option value="DOT">DOT</option>
        <option value="MATIC">MATIC</option>
        <option value="LTC">LTC</option>
        <option value="AVAX">AVAX</option>
        <option value="UNI">UNI</option>
        <option value="ETC">ETC</option>
        <option value="ATOM">ATOM</option>
        <option value="XMR">XMR</option>
        <option value="FIL">FIL</option>
        <option value="APT">APT</option>
        <option value="ARB">ARB</option>
    </select>

    <label>Enter Coin Amount</label>
    <input id="amount" placeholder="Enter amount" oninput="updateUSDT()" />

    <div id="usdtText">USDT Equivalent: <span id="usdtValue">0</span></div>

    <label>Password</label>
    <input type="password" id="password" placeholder="Enter password" />

    <div class="row">
        <button id="createPwdBtn" onclick="createPassword()">Create Password</button>
        <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
    </div>

    <button onclick="forgotPassword()">Forgot Password?</button>

    <label>Wallet Address</label>
    <input id="wallet" placeholder="Paste wallet address" />

    <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>

    <div id="hashBox"></div>

    <div class="row">
        <button id="copyHashBtn" onclick="copyHash()">Copy Hash</button>
        <button id="submitBtn" onclick="submitWithdrawal()">Submit Withdrawal</button>
    </div>
</div>

<script>
/* BINANCE PRICE */
const prices = {};
let ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");

ws.onmessage = msg => {
    const data = JSON.parse(msg.data);
    data.forEach(t => {
        if (t.s.endsWith("USDT")) {
            const coin = t.s.replace("USDT", "");
            prices[coin] = parseFloat(t.c);
        }
    });
    updateUSDT();
};

function updateUSDT() {
    const coin = document.getElementById("coin").value;
    const amount = parseFloat(document.getElementById("amount").value || 0);
    const price = prices[coin] || 0;
    document.getElementById("usdtValue").innerText = (amount * price).toFixed(6);
}

/* PASSWORD SYSTEM */
let storedPassword = localStorage.getItem("withdraw_password");
let passwordConfirmed = false;

window.onload = () => {
    if (storedPassword) {
        document.getElementById("createPwdBtn").style.display = "none";
    }
};

function createPassword() {
    if (storedPassword) return alert("Password already created.");

    storedPassword = Math.random().toString(36).substr(2, 6).toUpperCase();
    localStorage.setItem("withdraw_password", storedPassword);

    alert("Your Password: " + storedPassword + "\n\nðŸ¤– Please change your withdrawal password immediately.");

    document.getElementById("createPwdBtn").style.display = "none";
}

function confirmPassword() {
    const input = document.getElementById("password").value;
    if (input === storedPassword) {
        passwordConfirmed = true;
        alert("Password confirmed!");
    } else {
        alert("Wrong password!");
    }
}

function forgotPassword() {
    if (!storedPassword) return alert("Password not created.");

    const oldp = prompt("Enter current password:");
    if (oldp !== storedPassword) return alert("Wrong password.");

    const newp = prompt("Enter new password (min 4 chars):");
    if (!newp || newp.length < 4) return alert("Too short.");

    storedPassword = newp;
    localStorage.setItem("withdraw_password", newp);
    alert("Password updated!");
}

/* WALLET + HASH */
let txHash = null;

function confirmWallet() {
    if (!passwordConfirmed) return alert("Confirm password first.");
    const wallet = document.getElementById("wallet").value;
    if (!wallet) return alert("Enter wallet address.");

    txHash = "TX-" + Math.random().toString(36).substr(2, 8).toUpperCase();

    document.getElementById("hashBox").innerText = "Transaction Hash:\n" + txHash;
    document.getElementById("copyHashBtn").style.display = "block";
    document.getElementById("submitBtn").style.display = "block";
    document.getElementById("walletBtn").disabled = true;
}

function copyHash() {
    navigator.clipboard.writeText(txHash);
    alert("Hash copied!");
}

/* SUBMIT */
async function submitWithdrawal() {
    const payload = {
        coin: document.getElementById("coin").value,
        amount: document.getElementById("amount").value,
        usdt: document.getElementById("usdtValue").innerText,
        wallet: document.getElementById("wallet").value,
        password: storedPassword,
        hash: txHash,
        userid: window.STR_USER_ID
    };

    try {
        const res = await fetch("https://crypto-management-production-5e04.up.railway.app/api/order/withdraw", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) alert("Withdrawal submitted!");
        else alert("Server Error: " + data.error);
    } catch (e) {
        alert("Network error");
    }
}
</script>

</body>
</html>
