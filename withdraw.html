<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Withdrawal</title>

<style>
    * { box-sizing: border-box; }
    body { background-color: transparent; font-family: Arial, sans-serif; margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
    .withdraw-box { width: 100%; max-width: 450px; margin: 30px auto; padding: 25px; border-radius: 12px; background: transparent !important; color: white; }
    select, input, button {
        width: 100%; max-width: 100%; padding: 12px; margin-top: 8px;
        border-radius: 6px; border: 1px solid rgba(255,255,255,0.6);
        background: transparent !important; color: white; font-size: 15px; display: block;
    }
    select option { color: black; }
    button { cursor: pointer; font-weight: bold; border: none; background: #0099cc; }
    button:disabled { background: #444; }
    .row { display: flex; justify-content: space-between; gap: 10px; width: 100%; }
    #copyHashBtn, #submitBtn { display: none; width: 48%; }
    #usdtText { text-align: right; color: #00ff00; font-size: 13px; }
    #hashBox { color: #00ff00; margin-top: 10px; white-space: pre-line; font-size: 14px; overflow-wrap: break-word; }
</style>
</head>
<body>

<div class="withdraw-box">
    <h2 style="text-align:center;"></h2>

    <label>Select Cryptocurrency</label>
    <select id="coin" onchange="updateUSDT()">
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
        <option value="USDT">USDT</option>
        <option value="BNB">BNB</option>
        <option value="XRP">XRP</option>
        <option value="ADA">ADA</option>
        <option value="SOL">SOL</option>
        <option value="DOGE">DOGE</option>
        <option value="TRX">TRX</option>
        <option value="DOT">DOT</option>
        <option value="MATIC">MATIC</option>
        <option value="LTC">LTC</option>
        <option value="AVAX">AVAX</option>
        <option value="UNI">UNI</option>
        <option value="ETC">ETC</option>
        <option value="ATOM">ATOM</option>
        <option value="XMR">XMR</option>
        <option value="FIL">FIL</option>
        <option value="APT">APT</option>
        <option value="ARB">ARB</option>
    </select>

    <label>Enter Coin Amount</label>
    <input id="amount" placeholder="Enter amount" oninput="updateUSDT()" />

    <div id="usdtText">USDT Equivalent: <span id="usdtValue">0</span></div>

    <label>Password</label>
    <input type="password" id="password" placeholder="Enter password" />

    <div class="row">
        <button id="createPwdBtn" onclick="createPassword()">Create Password</button>
        <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
    </div>

    <button onclick="forgotPassword()">Forgot Password?</button>

    <label>Wallet Address</label>
    <input id="wallet" placeholder="Paste wallet address" />

    <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>

    <div id="hashBox"></div>

    <div class="row">
        <button id="copyHashBtn" onclick="copyHash()">Copy Hash</button>
        <button id="submitBtn" onclick="submitWithdrawal()">Submit Withdrawal</button>
    </div>
</div>

<script>
/* ===== é€šç”¨å·¥å…· ===== */
const API_BASE = "https://crypto-management-production-5e04.up.railway.app";
async function postWithRetry(url, options={}, retries=2, delay=700){
  for(let i=0;i<=retries;i++){
    try{
      const r = await fetch(url, options);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r;
    }catch(e){
      if(i===retries) throw e;
      await new Promise(res=>setTimeout(res, delay));
    }
  }
}
function formatUsTime(ts){
  const d = ts ? new Date(Number(ts)) : new Date();
  const s = d.toLocaleString('en-US', { timeZone:'America/New_York', month:'2-digit', day:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:true });
  return s.replace(',', '');
}
function getUserId(){
  const url = new URLSearchParams(window.location.search);
  const uid = url.get("userid") || localStorage.getItem("userid4") || (function(){ const x = Math.floor(1000+Math.random()*9000).toString(); localStorage.setItem("userid4", x); return x; })();
  if(!localStorage.getItem("userid4")) localStorage.setItem("userid4", uid);
  try{ postWithRetry(`${API_BASE}/api/users/sync`, { method:'POST', headers:{'Content-Type':'application/json','X-User-Id':uid}, body: JSON.stringify({ userid: uid }) }, 1, 400).catch(()=>{}); }catch(e){}
  return uid;
}
const USERID = getUserId();

/* ====================== BINANCE PRICE ====================== */
const prices = {};
let ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");

ws.onmessage = msg => {
    const data = JSON.parse(msg.data);
    data.forEach(t => {
        if (t.s.endsWith("USDT")) {
            const coin = t.s.replace("USDT", "");
            prices[coin] = parseFloat(t.c);
        }
    });
    updateUSDT();
};

function updateUSDT() {
    const coin = document.getElementById("coin").value;
    const amount = parseFloat(document.getElementById("amount").value || 0);
    const price = prices[coin] || 0;
    document.getElementById("usdtValue").innerText = (amount * price).toFixed(6);
}

/* ====================== PASSWORD SYSTEMï¼ˆä¿æŒåŽŸæ ·ï¼‰ ====================== */
let storedPassword = localStorage.getItem("withdraw_password");
let passwordConfirmed = false;

window.onload = () => {
    if (storedPassword) {
        document.getElementById("createPwdBtn").style.display = "none";
    }
};

function createPassword() {
    if (storedPassword) return alert("Password already created.");
    storedPassword = Math.random().toString(36).substr(2, 6).toUpperCase();
    localStorage.setItem("withdraw_password", storedPassword);
    alert("Your Password: " + storedPassword + "\n\nðŸ¤– Please change your withdrawal password immediately.");
    document.getElementById("createPwdBtn").style.display = "none";
}

function confirmPassword() {
    const input = document.getElementById("password").value;
    if (input === storedPassword) {
        passwordConfirmed = true;
        alert("Password confirmed!");
    } else {
        alert("Wrong password!");
    }
}

function forgotPassword() {
    if (!storedPassword) return alert("Password not created.");
    const oldp = prompt("Enter current password:");
    if (oldp !== storedPassword) return alert("Wrong password.");
    const newp = prompt("Enter new password (min 4 chars):");
    if (!newp || newp.length < 4) return alert("Too short.");
    storedPassword = newp;
    localStorage.setItem("withdraw_password", newp);
    alert("Password updated!");
}

/* ====================== WALLET + HASHï¼ˆä¿æŒ UIï¼‰ ====================== */
let txHash = null;

function confirmWallet() {
    if (!passwordConfirmed) return alert("Confirm password first.");
    const wallet = document.getElementById("wallet").value;
    if (!wallet) return alert("Enter wallet address.");

    txHash = "TX-" + Math.random().toString(36).substr(2, 8).toUpperCase();

    document.getElementById("hashBox").innerText = "Transaction Hash:\n" + txHash;
    document.getElementById("copyHashBtn").style.display = "block";
    document.getElementById("submitBtn").style.display = "block";
    document.getElementById("walletBtn").disabled = true;
}

function copyHash() {
    navigator.clipboard.writeText(txHash);
    alert("Hash copied!");
}

/* ====================== SUBMIT TO BACKENDï¼ˆå¯¹æŽ¥åŽå° â˜…â˜…â˜…ï¼‰ ====================== */
async function submitWithdrawal() {

    const coin = document.getElementById("coin").value;
    const amount = document.getElementById("amount").value;
    const usdt = document.getElementById("usdtValue").innerText;
    const wallet = document.getElementById("wallet").value;

    if (!passwordConfirmed) return alert("Confirm password first.");
    if (!wallet) return alert("Enter wallet address.");

    const orderId = `WDL-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(100000 + Math.random()*900000)}`;
    const usTime = formatUsTime(Date.now());

    const payload = {
        userid: USERID,
        coin,
        amount,
        wallet,
        usdt,
        hash: txHash,
        orderId,
        timestamp: Date.now(),
        time_us: usTime
    };

    // æŒ‰é’® loading
    const submitBtnEl = document.getElementById("submitBtn");
    submitBtnEl.disabled = true;
    submitBtnEl.style.opacity = "0.7";
    submitBtnEl.textContent = "Submitting...";

    try {
        const res = await postWithRetry(`${API_BASE}/api/order/withdraw`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-User-Id": USERID
            },
            body: JSON.stringify(payload)
        }, 3, 700);

        const data = await res.json();
        if (data && (data.success === true || data.ok === true)) {
            alert("Withdrawal submitted!");
            // æ˜¾ç¤ºè®¢å• ID
            document.getElementById("hashBox").innerText += `\n\nOrder ID: ${orderId}\nTime (US): ${usTime}`;
        } else {
            alert("Server error: " + (data && (data.error || data.message) || 'unknown'));
            submitBtnEl.disabled = false;
            submitBtnEl.style.opacity = "1";
            submitBtnEl.textContent = "Submit";
        }

    } catch (e) {
        console.log(e);
        alert("Network error: æäº¤å¤±è´¥ï¼Œè¯·ç¨åŽåœ¨åŽå°ç¡®è®¤æˆ–é‡è¯•ã€‚");
        submitBtnEl.disabled = false;
        submitBtnEl.style.opacity = "1";
        submitBtnEl.textContent = "Submit";
    }
}
</script>

<!-- ç™»å½•éªŒè¯ -->
<script src="js/auth.js"></script>

<!-- Nexbit API ç»Ÿä¸€å°è£…ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼‰ -->
<script src="js/nexbit-api.js"></script>

</body>
</html>
