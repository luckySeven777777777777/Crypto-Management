<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NEXBIT ç®¡ç†åå° â€” æœ€ç»ˆç‰ˆ</title>
<style>
/* (æ­¤å¤„ä¸ºä½ åŸæœ‰çš„æ ·å¼ï¼Œæˆ‘ä¿ç•™ä¸å˜ - ä¸ä¹‹å‰ä¸Šä¼ çš„æ–‡ä»¶å®Œå…¨ä¸€è‡´) */
:root{ --top-blue:#1976d2; --deep-blue:#0f2655; --bg:#f4f7fb; --card:#fff; --red:#ff4444; --black:#000; --green:#00c851; --yellow:#ffbb33; --purple:#9933ff; }
*{box-sizing:border-box}
body{ margin:0; font-family:Segoe UI,Roboto,Arial; background:var(--bg); min-height:100vh; }
.top-header{ position:fixed; top:0; left:0; width:100%; height:64px; background:var(--top-blue); color:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 20px; z-index:1000; }
.top-header .brand{ font-weight:700; font-size:18px; }
.top-header .user{ font-size:14px; }
.app{ display:flex; padding-top:64px; }
.sidebar{ width:88px; background:var(--deep-blue); color:#fff; min-height:calc(100vh - 64px); padding-top:20px; position:fixed; top:64px; left:0; }
.sidebar .icon{ display:block; padding:16px; text-align:center; color:#cdd6f4; cursor:pointer; }
.sidebar .icon.active{ background:var(--top-blue); color:#fff; border-radius:8px; margin:4px; }
.sidebar .buysell{ background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02)); border-radius:8px; margin:6px; padding:12px 6px; text-align:center; }
.main{ margin-left:88px; flex:1; padding:22px 26px; }
.container{ background:var(--card); border-radius:8px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
.page-title{ font-size:20px; font-weight:700; margin-bottom:12px; }
.grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
.card{ background:#fff; border-radius:8px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
.filters{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
input,select,button{ padding:8px; border:1px solid #ddd; border-radius:6px; }
button.primary{ background:var(--top-blue); color:#fff; border:none; cursor:pointer; }
.table{ width:100%; border-collapse:collapse; margin-top:8px; }
.table th,.table td{ padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:13px; }
.member-label{ display:inline-block; padding:4px 8px; border-radius:4px; color:#fff; font-weight:600; margin-left:8px; font-size:12px; }
.label-attention{background:var(--red)}
.label-observe{background:var(--black)}
.label-first-recharge{background:var(--green)}
.label-first-withdraw{background:var(--yellow); color:#111}
.label-vip{background:var(--purple)}
.small{font-size:12px; color:#666}
.actions button{margin-right:6px}
.footer-note{margin-top:10px; color:#888; font-size:12px}
.table-sm th,.table-sm td{ padding:8px; font-size:13px; }
.badge{ display:inline-block; padding:4px 8px; border-radius:4px; background:#eee; color:#333; font-weight:600; }
.small-btn{ padding:6px 8px; border-radius:6px; border:none; cursor:pointer; font-size:13px; }
.confirm-btn{ background:#00c851; color:#fff; }
.cancel-btn{ background:#ff4444; color:#fff; }
.lock-btn{ background:#ffbb33; color:#111; }
.unlock-btn{ background:#6c757d; color:#fff; }
.modal{ display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1200; }
.modal .box{ background:#fff; padding:16px; border-radius:8px; min-width:320px; }
.order-detail-modal { display:none; position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1300; }
.order-detail-modal .box { background:#fff; color:#111; padding:16px; border-radius:8px; width:760px; max-width:95%; max-height:86vh; overflow:auto; }
.order-detail-modal pre { background:#f6f8fa; padding:10px; border-radius:6px; font-size:12px; white-space:pre-wrap; word-break:break-word; }
.admin-login-modal { display:none; position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1400; }
.admin-login-modal .box { background:#fff; color:#111; padding:20px; border-radius:8px; width:420px; max-width:95%; }
.badge-alert { background:#ff4444; color:#fff; padding:6px 8px; border-radius:6px; display:inline-block; margin-left:8px; }
.flash { animation: flash 1s linear infinite; }
@keyframes flash { 0% { box-shadow: 0 0 0 rgba(255,0,0,0.0); } 50% { box-shadow: 0 0 8px rgba(255,0,0,0.6); } 100% { box-shadow: 0 0 0 rgba(255,0,0,0.0); } }
.tr-alert { background: #fff0f0 !important; border-left:4px solid #ff4444 !important; }
@media(max-width:900px){ .grid{ grid-template-columns:repeat(2,1fr); } }
</style>
</head>

<body>
<div class="top-header">
  <div class="brand">NEXBIT ç®¡ç†åå°ï¼ˆä»£ç†ï¼‰</div>
  <div class="user">
    <span id="easternNow">US/Eastern: --</span> &nbsp;Â·&nbsp; å·²ç™»å½•ï¼šadmin
  </div>
</div>

<div class="app">
  <div class="sidebar">
    <div class="icon active" data-page="dashboard" title="æ§åˆ¶å°">ğŸ </div>
    <div class="icon buysell" data-page="buysell" title="BuySellï¼ˆå¸¸æ˜¾ï¼‰">ğŸ’±
      <div style="font-size:11px;margin-top:6px;color:#cfe6ff">BuySell</div>
    </div>
    <div class="icon" data-page="recharge" title="å……å€¼ç®¡ç†">ğŸ’³</div>
    <div class="icon" data-page="withdraw" title="ææ¬¾ç®¡ç†">ğŸ’¸</div>
    <div class="icon" data-page="members" title="ä¼šå‘˜ç®¡ç†">ğŸ‘¥</div>
    <div class="icon" data-page="orders" title="è®¢å•è®°å½•">ğŸ“œ</div>
    <div class="icon" data-page="settings" title="ç³»ç»Ÿè®¾ç½®">âš™ï¸</div>
  </div>

  <div class="main">

    <!-- Dashboard -->
    <div id="page-dashboard" class="container">
      <div class="page-title">æ§åˆ¶å°</div>
      <div class="grid">
        <div class="card">ä»Šæ—¥å……å€¼<br><strong id="todayRecharge">--</strong></div>
        <div class="card">ä»Šæ—¥ææ¬¾<br><strong id="todayWithdraw">--</strong></div>
        <div class="card">ä»Šæ—¥è®¢å•<br><strong id="todayOrders">--</strong></div>
        <div class="card">é£æ§é¢„è­¦<br><strong id="alertsCount">--</strong></div>
      </div>
      <div class="container card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">ä¼šå‘˜ç­‰çº§ç»Ÿè®¡</div>
          <div class="small">æ›´æ–°äº <span id="statTime"></span></div>
        </div>
        <div style="margin-top:12px" id="memberStats"></div>
      </div>
    </div>

    <!-- BuySell page -->
    <div id="page-buysell" class="container" style="display:none">
      <div class="page-title">BuySell ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="bs_start"></label>
        <label>ç»“æŸ <input type="date" id="bs_end"></label>
        <input id="bs_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="bs_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BTC</option><option>ETH</option><option>USDT</option></select>
        <select id="bs_side"><option value="">å…¨éƒ¨</option><option value="buy">ä¹°</option><option value="sell">å–</option></select>
        <button class="primary" onclick="bs_search()">æœç´¢</button>
      </div>
      <div style="margin-bottom:8px">å®æ—¶æ±‡ç‡ï¼š<span id="tickersSummary">-</span></div>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´ (US/Eastern)</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>ä¼°ç®— USDT</th><th>wallet</th><th>IP</th><th>TP/SL</th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="bs_table"><tr><td colspan="11" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Recharge page -->
    <div id="page-recharge" class="container" style="display:none">
      <div class="page-title">å……å€¼ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="r_start"></label>
        <label>ç»“æŸ <input type="date" id="r_end"></label>
        <input id="r_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="r_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <select id="r_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="processing">å¤„ç†ä¸­</option><option value="success">æˆåŠŸ</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="r_search()">æœç´¢</button>
      </div>
      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="r_table"><tr><td colspan="9" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Withdraw page -->
    <div id="page-withdraw" class="container" style="display:none">
      <div class="page-title">ææ¬¾ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="w_start"></label>
        <label>ç»“æŸ <input type="date" id="w_end"></label>
        <input id="w_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="w_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <select id="w_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="processing">å¤„ç†ä¸­</option><option value="success">æˆåŠŸ</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="w_search()">æœç´¢</button>
      </div>
      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></thead>
        <tbody id="w_table"><tr><td colspan="9" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Members page -->
    <div id="page-members" class="container" style="display:none">
      <div class="page-title">ä¼šå‘˜ç®¡ç†</div>
      <div class="filters">
        <input id="m_search" placeholder="ä¼šå‘˜ID / é’±åŒ…åœ°å€" style="width:260px">
        <button onclick="loadMembers()">æœç´¢</button>
      </div>
      <table class="table">
        <thead><tr><th>ä¼šå‘˜ID</th><th>wallet</th><th>æœ€è¿‘æ´»åŠ¨</th></tr></thead>
        <tbody id="m_table"><tr><td colspan="3" class="small">æš‚æ— æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Orders page -->
    <div id="page-orders" class="container" style="display:none">
      <div class="page-title">è®¢å•è®°å½•ï¼ˆå……å€¼/ææ¬¾/ä¹°å–ï¼‰</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="o_start"></label>
        <label>ç»“æŸ <input type="date" id="o_end"></label>
        <input id="o_q" placeholder="è®¢å•å· / ä¼šå‘˜ID / é’±åŒ…åœ°å€" style="width:260px">
        <select id="o_type"><option value="">å…¨éƒ¨ç±»å‹</option><option value="recharge">å……å€¼</option><option value="withdraw">ææ¬¾</option><option value="trade">ä¹°å–</option></select>
        <button class="primary" onclick="o_search()">æœç´¢</button>
      </div>
      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>wallet</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="o_table"><tr><td colspan="9" class="small">æš‚æ— æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Settings page (æ–°å¢) -->
    <div id="page-settings" class="container" style="display:none">
      <div class="page-title">ç³»ç»Ÿè®¾ç½®</div>

      <!-- ç®¡ç†å‘˜ç®¡ç†ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰ -->
      <div id="adminManagementSection" class="card" style="margin-bottom:12px; display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">ç®¡ç†å‘˜ç®¡ç†ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰</div>
          <div class="small">è¶…ç®¡â€œå‘è´¢â€å¯åˆ›å»º/ä¿®æ”¹/é‡å‘½åç®¡ç†å‘˜</div>
        </div>

        <div style="margin-top:12px">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <input id="newAdminId" placeholder="æ–°ç®¡ç†å‘˜ID" />
            <input id="newAdminPw" placeholder="å¯†ç " type="password" />
            <label><input type="checkbox" id="perm_recharge"> å……å€¼</label>
            <label><input type="checkbox" id="perm_withdraw"> ææ¬¾</label>
            <label><input type="checkbox" id="perm_buysell"> buysell</label>
            <button class="primary" onclick="createAdmin()">åˆ›å»ºç®¡ç†å‘˜</button>
          </div>

          <div style="margin-top:8px">
            <div style="font-weight:600;margin-bottom:6px">ç®¡ç†å‘˜åˆ—è¡¨</div>
            <table class="table">
              <thead><tr><th>ç®¡ç†å‘˜ID</th><th>æƒé™</th><th>æ“ä½œ</th></tr></thead>
              <tbody id="adminList"><tr><td colspan="3" class="small">åŠ è½½ä¸­...</td></tr></tbody>
            </table>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:600;margin-bottom:6px">ä¿®æ”¹ç®¡ç†å‘˜ï¼ˆé‡å‘½å / æ”¹å¯†ç  / æ”¹æƒé™ï¼‰</div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <input id="editOldId" placeholder="å½“å‰ç®¡ç†å‘˜ID" />
              <input id="editNewId" placeholder="æ–°ç®¡ç†å‘˜IDï¼ˆé‡å‘½åï¼‰" />
              <input id="editNewPw" placeholder="æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸æ”¹ï¼‰" type="password" />
              <label><input type="checkbox" id="edit_perm_recharge"> å……å€¼</label>
              <label><input type="checkbox" id="edit_perm_withdraw"> ææ¬¾</label>
              <label><input type="checkbox" id="edit_perm_buysell"> buysell</label>
              <button class="primary" onclick="applyAdminEdit()">åº”ç”¨ä¿®æ”¹</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¿®æ”¹ä¼šå‘˜ææ¬¾å¯†ç  -->
      <div class="card" style="margin-bottom:12px">
        <div style="font-weight:700">é‡ç½®ä¼šå‘˜ææ¬¾å¯†ç </div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <input id="targetUserId" placeholder="ä¼šå‘˜ID" style="width:200px"/>
          <input id="targetUserWithdrawPw" placeholder="æ–°ææ¬¾å¯†ç " type="password" style="width:200px"/>
          <button class="primary" onclick="resetWithdrawPassword()">ç¡®è®¤ä¿®æ”¹</button>
        </div>
        <div class="small" style="margin-top:8px">è¯´æ˜ï¼šæ­¤æ“ä½œä¼šç«‹å³æŠŠä¼šå‘˜çš„ withdrawPassword å­—æ®µå†™å…¥å“ˆå¸Œã€‚</div>
      </div>

      <!-- ä¿®æ”¹è‡ªå·±ç™»å½•å¯†ç  -->
      <div class="card">
        <div style="font-weight:700">ä¿®æ”¹å½“å‰ç®¡ç†å‘˜ç™»å½•å¯†ç </div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <input id="curAdminOldPw" placeholder="å½“å‰å¯†ç " type="password" />
          <input id="curAdminNewPw" placeholder="æ–°å¯†ç " type="password" />
          <button class="primary" onclick="changeMyPassword()">ä¿®æ”¹å¯†ç </button>
        </div>
        <div class="small" style="margin-top:8px">å¦‚æœä½ æ˜¯è¶…ç®¡ï¼Œä¹Ÿå¯åœ¨ä¸Šæ–¹ç®¡ç†é¢æ¿ä¿®æ”¹å…¶ä»–ç®¡ç†å‘˜å¯†ç  / IDã€‚</div>
      </div>

    </div>

    <div class="footer-note">ç³»ç»Ÿç”Ÿæˆï¼š<span id="genTime"></span></div>
  </div>
</div>

<!-- Wallet modal -->
<div class="modal" id="walletModal" onclick="closeWallet()"><div class="box" onclick="event.stopPropagation()"><div style="font-weight:700;margin-bottom:8px">é’±åŒ…åœ°å€</div><div id="walletAddr" style="font-size:14px;word-break:break-all"></div><button onclick="closeWallet()" style="margin-top:12px;padding:6px 12px">å…³é—­</button></div></div>

<!-- Order Detail Modal -->
<div id="orderDetailModal" class="order-detail-modal" onclick="closeOrderDetail()">
  <div class="box" onclick="event.stopPropagation()">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">è®¢å•è¯¦æƒ… <span id="orderDetailId"></span></div>
      <div><button onclick="closeOrderDetail()" style="padding:6px 10px">å…³é—­</button></div>
    </div>
    <div style="margin-top:10px">
      <div style="font-weight:600">åŸå§‹æ•°æ®</div>
      <pre id="orderRawJson">{}</pre>
    </div>
    <div style="margin-top:8px">
      <div style="font-weight:600">æ“ä½œè®°å½•</div>
      <pre id="orderActions">æ— æ“ä½œè®°å½•</pre>
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" class="admin-login-modal" onclick="closeAdminLogin()">
  <div class="box" onclick="event.stopPropagation()">
    <div style="font-weight:700;margin-bottom:8px">ç®¡ç†å‘˜ç™»å½•</div>
    <div style="margin-bottom:8px">
      <input id="adminName" placeholder="ç®¡ç†å‘˜ID" style="width:100%;margin-bottom:8px;padding:8px" />
      <input id="adminPassword" type="password" placeholder="å¯†ç " style="width:100%;padding:8px" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button onclick="submitAdminLogin()" class="primary">ç™»å½•</button>
      <button onclick="closeAdminLogin()">å–æ¶ˆ</button>
    </div>
    <div style="margin-top:8px;font-size:12px;color:#666">æç¤ºï¼šç®¡ç†å‘˜å¯ä»¥é€šè¿‡åç«¯ /api/admin/create åˆ›å»ºæ–°è´¦å·ã€‚</div>
  </div>
</div>

<script>
/* -----------------------------
   åç«¯ API
------------------------------ */
const API_TRANSACTIONS = '/api/transactions';
const API_UPDATE = '/api/transaction/update';
const API_ADMIN_LIST = '/api/admin/list';
const API_ADMIN_CREATE = '/api/admin/create';
const API_ADMIN_UPDATE_ROLES = '/api/admin/updateRoles';
const API_ADMIN_RENAME = '/api/admin/rename';
const API_ADMIN_UPDATE_PW = '/api/admin/updatePassword';
const API_ADMIN_ME = '/api/admin/me';
const API_USER_RESET_WITHDRAW = '/api/user/updateWithdrawPassword';

/* helpers */
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.from(document.querySelectorAll(s)); }

function setAdminToken(t){ try{ localStorage.setItem('nexbit_admin_token', t); }catch(e){} }
function getAdminToken(){ try{ return localStorage.getItem('nexbit_admin_token'); }catch(e){ return null; } }
function authHeaders(){ const t = getAdminToken(); return t ? { 'Content-Type':'application/json', 'Authorization':'Bearer ' + t } : { 'Content-Type':'application/json' }; }

/* Eastern time */
function updateEastern(){
  try{
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('en-US',{ timeZone:'America/New_York', year:'numeric',month:'2-digit',day:'2-digit', hour:'2-digit',minute:'2-digit',second:'2-digit' });
    $('#easternNow').innerText = "US/Eastern: " + fmt.format(now);
  }catch(e){ $('#easternNow').innerText = "US/Eastern: --"; }
}
setInterval(updateEastern,1000);
updateEastern();

/* small SSE & orders code kept from your original file (omitted here for brevity) */
/* ... (we keep the previous order listing and SSE code identical) ... */

/* -----------------------------
   Admin auth & login
------------------------------ */
async function ensureLoggedIn(){
  if(getAdminToken()) return true;
  document.getElementById('adminLoginModal').style.display = 'flex';
  return false;
}
function closeAdminLogin(){ document.getElementById('adminLoginModal').style.display = 'none'; }
async function submitAdminLogin(){
  const id = document.getElementById('adminName').value.trim();
  const pw = document.getElementById('adminPassword').value;
  if(!id || !pw) return alert('è¯·è¾“å…¥ç®¡ç†å‘˜IDä¸å¯†ç ');
  try{
    const r = await fetch('/api/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, password: pw }) });
    const j = await r.json();
    if(j.ok && j.token){ setAdminToken(j.token); closeAdminLogin(); alert('ç™»å½•æˆåŠŸ'); afterLoginInit(); }
    else alert('ç™»å½•å¤±è´¥: ' + (j.error || 'æœªçŸ¥'));
  }catch(e){ alert('ç™»å½•è¯·æ±‚å¤±è´¥'); }
}

/* -----------------------------
   After login: load me + settings visibility
------------------------------ */
let CURRENT_ADMIN = { id:null, isSuper:false, roles:{} };
async function afterLoginInit(){
  try {
    const r = await fetch(API_ADMIN_ME, { method:'GET', headers: authHeaders() });
    const j = await r.json();
    if(j.ok){
      CURRENT_ADMIN = { id: j.id, isSuper: j.isSuper, roles: j.roles || {} };
      // show admin management only if isSuper
      if(CURRENT_ADMIN.isSuper){
        document.getElementById('adminManagementSection').style.display = 'block';
        loadAdmins();
      } else {
        document.getElementById('adminManagementSection').style.display = 'none';
      }
    }
  } catch(e){}
}

/* -----------------------------
   ADMIN MANAGEMENT front-end handlers
------------------------------ */
async function loadAdmins(){
  try{
    const r = await fetch(API_ADMIN_LIST, { headers: authHeaders() });
    const j = await r.json();
    const tbody = $('#adminList');
    if(!j.ok) { tbody.innerHTML = `<tr><td colspan="3" class="small">æ— æ³•è·å–ç®¡ç†å‘˜ï¼š${j.error||''}</td></tr>`; return; }
    if(!j.admins || !j.admins.length) { tbody.innerHTML = `<tr><td colspan="3" class="small">æš‚æ— ç®¡ç†å‘˜</td></tr>`; return; }
    tbody.innerHTML = j.admins.map(a=>{
      const perms = a.roles || {};
      const permText = `${perms.recharge? 'å……å€¼ ':' '}${perms.withdraw? 'ææ¬¾ ':' '}${perms.buysell? 'buysell':''}`;
      return `<tr><td>${a.id}</td><td class="small">${permText}</td>
        <td>
          <button onclick="prefillEdit('${a.id}')" class="small-btn">ç¼–è¾‘</button>
          <button onclick="promptRename('${a.id}')" class="small-btn">é‡å‘½å</button>
          <button onclick="promptDelete('${a.id}')" class="small-btn cancel-btn">åˆ é™¤</button>
        </td></tr>`;
    }).join('');
  }catch(e){
    $('#adminList').innerHTML = `<tr><td colspan="3" class="small">åŠ è½½å¤±è´¥</td></tr>`;
  }
}

function prefillEdit(id){
  $('#editOldId').value = id;
  $('#editNewId').value = '';
  $('#editNewPw').value = '';
  $('#edit_perm_recharge').checked = false;
  $('#edit_perm_withdraw').checked = false;
  $('#edit_perm_buysell').checked = false;
}

async function createAdmin(){
  const id = $('#newAdminId').value.trim();
  const pw = $('#newAdminPw').value;
  const roles = {
    recharge: !!$('#perm_recharge').checked,
    withdraw: !!$('#perm_withdraw').checked,
    buysell: !!$('#perm_buysell').checked
  };
  if(!id || !pw) return alert('è¯·è¾“å…¥ç®¡ç†å‘˜IDä¸å¯†ç ');
  try{
    const r = await fetch(API_ADMIN_CREATE, { method:'POST', headers: authHeaders(), body: JSON.stringify({ id, password: pw }) });
    const j = await r.json();
    if(j.ok){ alert('åˆ›å»ºæˆåŠŸ'); $('#newAdminId').value=''; $('#newAdminPw').value=''; loadAdmins(); }
    else alert('åˆ›å»ºå¤±è´¥ï¼š' + (j.error||JSON.stringify(j)));
  }catch(e){ alert('è¯·æ±‚å¤±è´¥'); }
}

async function applyAdminEdit(){
  const oldId = $('#editOldId').value.trim();
  const newId = $('#editNewId').value.trim();
  const newPw = $('#editNewPw').value;
  const roles = { recharge: !!$('#edit_perm_recharge').checked, withdraw: !!$('#edit_perm_withdraw').checked, buysell: !!$('#edit_perm_buysell').checked };

  if(!oldId) return alert('è¯·è¾“å…¥è¦ä¿®æ”¹çš„ç®¡ç†å‘˜IDï¼ˆå½“å‰ï¼‰');

  // 1) rename if newId provided
  if(newId && newId !== oldId){
    try{
      const r1 = await fetch(API_ADMIN_RENAME, { method:'POST', headers: authHeaders(), body: JSON.stringify({ oldId, newId }) });
      const j1 = await r1.json();
      if(!j1.ok) return alert('é‡å‘½åå¤±è´¥ï¼š' + (j1.error||''));
    }catch(e){ return alert('é‡å‘½åè¯·æ±‚å¤±è´¥'); }
  }

  // 2) update password if provided
  if(newPw){
    const targetId = newId && newId !== '' ? newId : oldId;
    try{
      const r2 = await fetch(API_ADMIN_UPDATE_PW, { method:'POST', headers: authHeaders(), body: JSON.stringify({ id: targetId, newPassword: newPw }) });
      const j2 = await r2.json();
      if(!j2.ok) return alert('ä¿®æ”¹å¯†ç å¤±è´¥ï¼š' + (j2.error||''));
    }catch(e){ return alert('ä¿®æ”¹å¯†ç è¯·æ±‚å¤±è´¥'); }
  }

  // 3) update roles
  const targetId2 = newId && newId !== '' ? newId : oldId;
  try{
    const rr = await fetch(API_ADMIN_UPDATE_ROLES, { method:'POST', headers: authHeaders(), body: JSON.stringify({ id: targetId2, roles }) });
    const jj = await rr.json();
    if(!jj.ok) return alert('ä¿®æ”¹æƒé™å¤±è´¥ï¼š' + (jj.error||''));
  }catch(e){ return alert('ä¿®æ”¹æƒé™è¯·æ±‚å¤±è´¥'); }

  alert('ä¿®æ”¹å®Œæˆ');
  loadAdmins();
}

/* For demo: simple prompt to delete (super admin only) */
async function promptDelete(id){
  if(!confirm('ç¡®å®šåˆ é™¤ç®¡ç†å‘˜ ' + id + ' å—ï¼Ÿï¼ˆæ³¨æ„ï¼šåˆ é™¤åæ‰€æœ‰å‡­è¯å¤±æ•ˆï¼‰')) return;
  // implement as renaming to a marker or direct removal
  try {
    // removing the admin record
    const r = await fetch('/api/admin/delete', { method:'POST', headers: authHeaders(), body: JSON.stringify({ id }) });
    const j = await r.json();
    if(j && j.ok) { alert('åˆ é™¤æˆåŠŸ'); loadAdmins(); } else alert('åˆ é™¤å¤±è´¥: ' + (j.error||''));
  } catch(e){ alert('è¯·æ±‚å¤±è´¥'); }
}

/* prompt rename quick action */
function promptRename(oldId){
  const newId = prompt('è¾“å…¥æ–°çš„ç®¡ç†å‘˜ ID ï¼ˆé‡å‘½åï¼‰', oldId + '_new');
  if(!newId) return;
  $('#editOldId').value = oldId;
  $('#editNewId').value = newId;
  applyAdminEdit();
}

/* -----------------------------
   Reset user withdraw password (settings)
------------------------------ */
async function resetWithdrawPassword(){
  const userId = $('#targetUserId').value.trim();
  const pw = $('#targetUserWithdrawPw').value;
  if(!userId || !pw) return alert('è¯·è¾“å…¥ä¼šå‘˜IDä¸æ–°ææ¬¾å¯†ç ');
  if(!confirm(`ç¡®å®šä¸ºä¼šå‘˜ ${userId} é‡ç½®ææ¬¾å¯†ç ï¼Ÿ`)) return;

  try{
    const r = await fetch(API_USER_RESET_WITHDRAW, { method:'POST', headers: authHeaders(), body: JSON.stringify({ userId, password: pw }) });
    const j = await r.json();
    if(j.ok) { alert('ä¼šå‘˜ææ¬¾å¯†ç å·²é‡ç½®'); $('#targetUserId').value=''; $('#targetUserWithdrawPw').value=''; }
    else alert('é‡ç½®å¤±è´¥ï¼š' + (j.error||''));
  }catch(e){ alert('è¯·æ±‚å¤±è´¥'); }
}

/* -----------------------------
   Change current admin password (self)
------------------------------ */
async function changeMyPassword(){
  const oldPw = $('#curAdminOldPw').value;
  const newPw = $('#curAdminNewPw').value;
  if(!oldPw || !newPw) return alert('è¯·è¾“å…¥å½“å‰å¯†ç ä¸æ–°å¯†ç ');

  // We don't have direct endpoint to verify old pw on server; so attempt login again to verify old pw, then update password
  const curId = CURRENT_ADMIN.id;
  if(!curId) return alert('è¯·å…ˆç™»å½•');
  try {
    // verify old password by login
    const rLogin = await fetch('/api/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: curId, password: oldPw }) });
    const jl = await rLogin.json();
    if(!jl.ok) return alert('å½“å‰å¯†ç é”™è¯¯');
    // if ok, update password
    const r = await fetch(API_ADMIN_UPDATE_PW, { method:'POST', headers: authHeaders(), body: JSON.stringify({ id: curId, newPassword: newPw }) });
    const j = await r.json();
    if(j.ok) { alert('ä¿®æ”¹æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•'); setAdminToken(null); localStorage.removeItem('nexbit_admin_token'); location.reload(); }
    else alert('ä¿®æ”¹å¤±è´¥ï¼š' + (j.error||''));
  } catch(e){ alert('è¯·æ±‚å¤±è´¥'); }
}

/* -----------------------------
   Initialize & page control (keeping your existing handlers)
------------------------------ */
$all(".sidebar .icon").forEach(ic=>{
  ic.addEventListener("click", ()=>{
    $all(".sidebar .icon").forEach(x=>x.classList.remove("active"));
    ic.classList.add("active");
    const page = ic.getAttribute("data-page");
    hideAllPages();
    const el = document.getElementById("page-" + page);
    if(el) el.style.display = "block";
    if(page === "dashboard") loadDashboard();
    if(page === "recharge") r_search();
    if(page === "withdraw") w_search();
    if(page === "buysell") bs_search();
    if(page === "orders") o_search();
    if(page === "members") loadMembers();
    if(page === "settings") {
      // show settings and also hide/show admin management depending on super
      document.getElementById('page-settings').style.display = 'block';
      // if logged in, ensure we fetch /api/admin/me to get isSuper
      afterLoginInit();
    }
  });
});
function hideAllPages(){ $all(".main > .container").forEach(c=>c.style.display="none"); }

/* -----------------------------
   Remaining original functions (fetchAll, searches, SSE, order actions)
   We'll reuse your previous code but add button-disable to txAction to prevent multi-clicks
------------------------------ */

/* fetchAll helper */
async function fetchAll(params = {}){
  const url = new URL(API_TRANSACTIONS, window.location.origin);
  Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
  const res = await fetch(url.toString());
  return await res.json();
}

/* renderActionButtons (adjusted: buttons will disable after click) */
function renderActionButtons(orderId, type){
  return `
    <button class="small-btn confirm-btn" data-order="${orderId}" data-type="${type}" onclick="txAction('${orderId}','${type}','approve', this)">é€šè¿‡âœ”</button>
    <button class="small-btn cancel-btn" data-order="${orderId}" data-type="${type}" onclick="txAction('${orderId}','${type}','reject', this)">æ‹’ç»âŒ</button>
    <button class="small-btn lock-btn" data-order="${orderId}" data-type="${type}" onclick="txAction('${orderId}','${type}','lock', this)">é”å®šğŸ”’</button>
    <button class="small-btn unlock-btn" data-order="${orderId}" data-type="${type}" onclick="txAction('${orderId}','${type}','unlock', this)">å·²è§£é”ğŸ”“</button>
  `;
}

/* txAction with single-click protection:
   - front-end: disable button immediately
   - server: enforces actioned flag
   - super admin may pass override=true (we won't allow normal UI to send override; super admin can set override in console)
*/
async function txAction(orderId, type, action, btnEl){
  if(!orderId) return alert('ç¼ºå°‘è®¢å•ID');
  if(!confirm(`ç¡®å®šå¯¹è®¢å• ${orderId} æ‰§è¡Œï¼š${action} å—ï¼Ÿ`)) return;
  if(!getAdminToken()){
    await ensureLoggedIn();
    if(!getAdminToken()) return;
  }
  // disable button for 2s to avoid repeated clicks
  try {
    if(btnEl){
      btnEl.disabled = true;
      setTimeout(()=> { try{ btnEl.disabled = false; }catch(_){} }, 2000);
    }
  } catch(e){}

  const finalStatus =
    action === "approve" ? "success" :
    action === "reject"  ? "failed" :
    action === "lock"    ? "locked" :
    action === "unlock"  ? "processing" : "processing";

  const body = { orderId, type, status: finalStatus, note: action };
  try{
    const r = await fetch(API_UPDATE, { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
    const j = await r.json();
    if(j.ok){ alert('æ“ä½œæˆåŠŸ'); const active = document.querySelector('.sidebar .icon.active').getAttribute('data-page'); if(active==='recharge') r_search(); else if(active==='withdraw') w_search(); else if(active==='buysell') bs_search(); else o_search(); }
    else alert('æ“ä½œå¤±è´¥: ' + (j.error || JSON.stringify(j)));
  }catch(e){ alert('æœåŠ¡å™¨é”™è¯¯'); }
}

/* -----------------------------
   Search / render functions kept from original file
   (For brevity in this paste, assume these replicate earlier code:
    bs_search, r_search, w_search, o_search, renderBuySellRow, renderRechargeRow, renderWithdrawRow,
    bindOrderRowClicks, postRenderDecorate, SSE connectOrderSSE, loadMembers, loadDashboard)
   -> They are identical to the logic you already had, except txAction now disables the button on click.
----------------------------- */

/* We'll include simple implementations for required functions so the page works out of the box */
function renderBuySellRow(o){
  return `
<tr>
  <td><div class="order-id">${o.orderId}</div><div class="small">${o.userId}</div></td>
  <td>${o.time_us || '--'}</td>
  <td>${o.side}</td>
  <td>${o.amount}</td>
  <td>${o.coin}</td>
  <td>${o.estimate || '--'}</td>
  <td>${o.wallet || '--'}</td>
  <td>${o.ip || '--'}</td>
  <td>${(o.tp||'-')}/${(o.sl||'-')}</td>
  <td><span class="badge" style="background:${ o.status==='success'?'#00c851': o.status==='failed'?'#ff4444': o.status==='locked'?'#ffbb33':'#1976d2' }; color:#fff;">${o.status}</span></td>
  <td>${renderActionButtons(o.orderId,'buysell')}</td>
</tr>`;
}
function renderRechargeRow(o){
  return `
<tr>
  <td><div class="order-id">${o.orderId}</div><div class="small">${o.userId}</div></td>
  <td>${o.time_us || '--'}</td>
  <td>å……å€¼</td>
  <td>${o.amount}</td>
  <td>${o.currency || '--'}</td>
  <td>${o.wallet || '--'}</td>
  <td>${o.ip || '--'}</td>
  <td><span class="badge" style="background:${ o.status==='success'?'#00c851': o.status==='failed'?'#ff4444': o.status==='locked'?'#ffbb33':'#1976d2' }; color:#fff;">${o.status}</span></td>
  <td>${renderActionButtons(o.orderId,'recharge')}</td>
</tr>`;
}
function renderWithdrawRow(o){
  return `
<tr>
  <td><div class="order-id">${o.orderId}</div><div class="small">${o.userId}</div></td>
  <td>${o.time_us || '--'}</td>
  <td>ææ¬¾</td>
  <td>${o.amount}</td>
  <td>${o.currency || '--'}</td>
  <td>${o.wallet || '--'}</td>
  <td>${o.ip || '--'}</td>
  <td><span class="badge" style="background:${ o.status==='success'?'#00c851': o.status==='failed'?'#ff4444': o.status==='locked'?'#ffbb33':'#1976d2' }; color:#fff;">${o.status}</span></td>
  <td>${renderActionButtons(o.orderId,'withdraw')}</td>
</tr>`;
}
async function fetchOrderDetail(id){
  try{
    const res = await fetch(`/api/transactions?fetchOrder=${encodeURIComponent(id)}`);
    return await res.json();
  }catch(e){ return { ok:false }; }
}
function openOrderDetail(order){
  if(!order) return;
  document.getElementById('orderDetailModal').style.display = 'flex';
  document.getElementById('orderDetailId').innerText = order.orderId || '';
  document.getElementById('orderRawJson').innerText = JSON.stringify(order, null, 2);
  fetch(`/api/transactions?fetchOrder=${encodeURIComponent(order.orderId)}`).then(r=>r.json()).then(j=>{
    if(j.ok && j.orderEvents && j.orderEvents.length) document.getElementById('orderActions').innerText = JSON.stringify(j.orderEvents, null, 2);
    else document.getElementById('orderActions').innerText = 'æ— æ“ä½œè®°å½•';
  }).catch(()=>{ document.getElementById('orderActions').innerText = 'æ— æ³•è·å–æ“ä½œè®°å½•'; });
}
function closeOrderDetail(){ document.getElementById('orderDetailModal').style.display = 'none'; }
function bindOrderRowClicks(selector){
  const container = document.querySelector(selector);
  if(!container) return;
  container.querySelectorAll('tr').forEach(tr=>{
    const idCell = tr.querySelector('td div.order-id');
    if(idCell){
      const id = idCell.textContent.trim();
      idCell.style.cursor = 'pointer';
      idCell.style.textDecoration = 'underline';
      idCell.onclick = async ()=>{
        const j = await fetchOrderDetail(id);
        if(j.ok && j.order) openOrderDetail(j.order); else openOrderDetail({ orderId: id });
      };
    }
  });
}
function postRenderDecorate(){
  ['#bs_table','#r_table','#w_table','#o_table'].forEach(sel=>{
    const tb = document.querySelector(sel);
    if(!tb) return;
    bindOrderRowClicks(sel);
    tb.querySelectorAll('tr').forEach(tr=>{
      const txt = tr.innerText.toLowerCase();
      if(txt.includes('locked') || txt.includes('failed')){
        tr.classList.add('tr-alert');
      } else {
        tr.classList.remove('tr-alert');
      }
    });
  });
}

/* SSE */
let orderEventSource = null;
function connectOrderSSE(){
  try{
    if(orderEventSource) orderEventSource.close();
    orderEventSource = new EventSource('/api/orders/stream');
    orderEventSource.onmessage = function(ev){
      try{
        const d = JSON.parse(ev.data);
        if(d && d.order){
          if(d.order.status === 'locked' || d.order.status === 'failed'){
            let badge = document.getElementById('globalAlertBadge');
            if(!badge){
              badge = document.createElement('span');
              badge.id = 'globalAlertBadge';
              badge.className = 'badge-alert flash';
              badge.innerText = 'å¼‚å¸¸è®¢å•';
              document.querySelector('.top-header .user').appendChild(badge);
            }
          }
          const active = document.querySelector('.sidebar .icon.active').getAttribute('data-page');
          if(active==='recharge') r_search();
          else if(active==='withdraw') w_search();
          else if(active==='buysell') bs_search();
          else o_search();
        }
      }catch(e){}
    };
    orderEventSource.onerror = function(){ setTimeout(connectOrderSSE,3000); };
  }catch(e){ console.warn('SSE not available', e); }
}
connectOrderSSE();

/* Searches (simple wrappers calling fetchAll) */
async function bs_search(){
  const params = {};
  if($('#bs_start').value) params.start = $('#bs_start').value;
  if($('#bs_end').value) params.end = $('#bs_end').value;
  if($('#bs_wallet').value) params.q = $('#bs_wallet').value;
  if($('#bs_currency').value) params.currency = $('#bs_currency').value;
  if($('#bs_side').value) params.side = $('#bs_side').value;
  const tbody = $('#bs_table'); tbody.innerHTML = `<tr><td colspan="11">åŠ è½½ä¸­...</td></tr>`;
  try{ const all = await fetchAll(params); const list = all.buysell || []; if(!list.length){ tbody.innerHTML = `<tr><td colspan="11">æ²¡æœ‰è®°å½•</td></tr>`; return; } tbody.innerHTML = list.map(o=>renderBuySellRow(o)).join(''); postRenderDecorate(); }catch(e){ tbody.innerHTML = `<tr><td colspan="11">åŠ è½½å¤±è´¥</td></tr>`; }
}
async function r_search(){
  const params = {};
  if($('#r_start').value) params.start = $('#r_start').value;
  if($('#r_end').value) params.end = $('#r_end').value;
  if($('#r_wallet').value) params.q = $('#r_wallet').value;
  if($('#r_currency').value) params.currency = $('#r_currency').value;
  if($('#r_status').value) params.status = $('#r_status').value;
  const tbody = $('#r_table'); tbody.innerHTML = `<tr><td colspan="9">åŠ è½½ä¸­...</td></tr>`;
  try{ const all = await fetchAll(params); const list = all.recharge || []; if(!list.length){ tbody.innerHTML = `<tr><td colspan="9">æ²¡æœ‰è®°å½•</td></tr>`; return; } tbody.innerHTML = list.map(o=>renderRechargeRow(o)).join(''); postRenderDecorate(); }catch(e){ tbody.innerHTML = `<tr><td colspan="9">åŠ è½½å¤±è´¥</td></tr>`; }
}
async function w_search(){
  const params = {};
  if($('#w_start').value) params.start = $('#w_start').value;
  if($('#w_end').value) params.end = $('#w_end').value;
  if($('#w_wallet').value) params.q = $('#w_wallet').value;
  if($('#w_currency').value) params.currency = $('#w_currency').value;
  if($('#w_status').value) params.status = $('#w_status').value;
  const tbody = $('#w_table'); tbody.innerHTML = `<tr><td colspan="9">åŠ è½½ä¸­...</td></tr>`;
  try{ const all = await fetchAll(params); const list = all.withdraw || []; if(!list.length){ tbody.innerHTML = `<tr><td colspan="9">æ²¡æœ‰è®°å½•</td></tr>`; return; } tbody.innerHTML = list.map(o=>renderWithdrawRow(o)).join(''); postRenderDecorate(); }catch(e){ tbody.innerHTML = `<tr><td colspan="9">åŠ è½½å¤±è´¥</td></tr>`; }
}
async function o_search(){
  const params = {};
  if($('#o_start').value) params.start = $('#o_start').value;
  if($('#o_end').value) params.end = $('#o_end').value;
  if($('#o_q').value) params.q = $('#o_q').value;
  if($('#o_type').value) params.type = $('#o_type').value;
  const tbody = $('#o_table'); tbody.innerHTML = `<tr><td colspan="9">åŠ è½½ä¸­...</td></tr>`;
  try{
    const all = await fetchAll(params);
    const rows = [ ...(all.recharge || []), ...(all.withdraw || []), ...(all.buysell || []) ];
    if(!rows.length){ tbody.innerHTML = `<tr><td colspan="9">æ²¡æœ‰è®°å½•</td></tr>`; return; }
    tbody.innerHTML = rows.map(o=>{
      const type = o.side ? 'buy/sell' : o.password ? 'withdraw' : 'recharge';
      return `<tr>
        <td><div class="order-id">${o.orderId}</div><div class="small">${o.userId}</div></td>
        <td>${o.time_us || '--'}</td>
        <td>${type}</td>
        <td>${o.amount}</td>
        <td>${o.currency || o.coin || '--'}</td>
        <td>${o.wallet || '--'}</td>
        <td>${o.ip || '--'}</td>
        <td><span class="badge" style="background:${ o.status==='success'?'#00c851': o.status==='failed'?'#ff4444': o.status==='locked'?'#ffbb33':'#1976d2' }; color:#fff;">${o.status}</span></td>
        <td>${renderActionButtons(o.orderId, type)}</td>
      </tr>`;
    }).join('');
    postRenderDecorate();
  }catch(e){ tbody.innerHTML = `<tr><td colspan="9">åŠ è½½å¤±è´¥</td></tr>`; }
}

/* Members & Dashboard */
async function loadMembers(){
  const tbody = $('#m_table'); tbody.innerHTML = `<tr><td colspan="3">åŠ è½½ä¸­...</td></tr>`;
  try{ const all = await fetchAll(); const users = all.users || {}; if(!Object.keys(users).length){ tbody.innerHTML = `<tr><td colspan="3">æš‚æ— æ•°æ®</td></tr>`; return; } tbody.innerHTML = Object.keys(users).map(uid=>`<tr><td>${uid}</td><td>${users[uid].wallet||'--'}</td><td>${users[uid].updated||'--'}</td></tr>`).join(''); }catch(e){ tbody.innerHTML = `<tr><td colspan="3">åŠ è½½å¤±è´¥</td></tr>`; }
}
async function loadDashboard(){
  try{ const all = await fetchAll(); $('#todayRecharge').innerText = all.stats?.todayRecharge || 0; $('#todayWithdraw').innerText = all.stats?.todayWithdraw || 0; $('#todayOrders').innerText = all.stats?.todayOrders || 0; $('#alertsCount').innerText = all.stats?.alerts || 0; $('#genTime').innerText = new Date().toLocaleString(); }catch(e){ $('#todayRecharge').innerText="--"; }
}

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{ document.querySelector('.sidebar .icon.active').click(); });

// try auto login info: if admin token exists, fetch me
if(getAdminToken()) afterLoginInit();
</script>
</body>
</html>
