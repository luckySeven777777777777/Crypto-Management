<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NEXBIT ç®¡ç†åå° â€” æœ€ç»ˆç‰ˆ</title>
<style>
:root{--top-blue:#1976d2;--deep-blue:#0f2655;--bg:#f4f7fb;--card:#fff;
--red:#ff4444;--black:#000;--green:#00c851;--yellow:#ffbb33;--purple:#9933ff;}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Roboto,Arial;background:var(--bg);min-height:100vh}
.top-header{position:fixed;top:0;left:0;width:100%;height:64px;background:var(--top-blue);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1000;}
.top-header .brand{font-weight:700;font-size:18px}
.top-header .user{font-size:14px}
.app{display:flex;padding-top:64px}
.sidebar{width:88px;background:var(--deep-blue);color:#fff;min-height:calc(100vh - 64px);padding-top:20px;position:fixed;top:64px;left:0}
.sidebar .icon{display:block;padding:16px;text-align:center;color:#cdd6f4;cursor:pointer}
.sidebar .icon.active{background:var(--top-blue);color:#fff;border-radius:8px;margin:4px}
.main{margin-left:88px;flex:1;padding:22px 26px}
.container{background:var(--card);border-radius:8px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.page-title{font-size:20px;font-weight:700;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
.card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
input,select,button{padding:8px;border:1px solid #ddd;border-radius:6px}
button.primary{background:var(--top-blue);color:#fff;border:none;cursor:pointer}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
.member-label{display:inline-block;padding:4px 8px;border-radius:4px;color:#fff;font-weight:600;margin-left:8px;font-size:12px}
.label-attention{background:var(--red)} .label-observe{background:var(--black)} .label-first-recharge{background:var(--green)} .label-first-withdraw{background:var(--yellow);color:#111} .label-vip{background:var(--purple)}
.small{font-size:12px;color:#666}
.actions button{margin-right:6px}
.footer-note{margin-top:10px;color:#888;font-size:12px}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}

/* ADDED: order/admin pages styles (keeps consistent) */
.subpage-actions{display:flex;gap:8px;align-items:center;margin-bottom:12px}
.table-sm th,.table-sm td{padding:8px;font-size:13px}
.badge{display:inline-block;padding:4px 8px;border-radius:4px;background:#eee;color:#333;font-weight:600}
</style>
</head>
<body>

<div class="top-header">
  <div class="brand">NEXBIT ç®¡ç†åå°ï¼ˆä»£ç†ï¼‰</div>
  <div class="user">å·²ç™»å½•ï¼šadmin</div>
</div>

<div class="app">
  <div class="sidebar">
    <div class="icon active" data-page="dashboard" title="æ§åˆ¶å°">ğŸ </div>
    <div class="icon" data-page="recharge" title="å……å€¼ç®¡ç†">ğŸ’³</div>
    <div class="icon" data-page="withdraw" title="ææ¬¾ç®¡ç†">ğŸ’¸</div>
    <div class="icon" data-page="members" title="ä¼šå‘˜ç®¡ç†">ğŸ‘¥</div>
    <div class="icon" data-page="settings" title="ç³»ç»Ÿè®¾ç½®">âš™ï¸</div>
  </div>

  <div class="main">
    <!-- Dashboard -->
    <div id="page-dashboard" class="container">
      <div class="page-title">æ§åˆ¶å°</div>
      <div class="grid">
        <div class="card">ä»Šæ—¥å……å€¼<br><strong id="todayRecharge">--</strong></div>
        <div class="card">ä»Šæ—¥ææ¬¾<br><strong id="todayWithdraw">--</strong></div>
        <div class="card">ä»Šæ—¥è®¢å•<br><strong id="todayOrders">--</strong></div>
        <div class="card">é£æ§é¢„è­¦<br><strong id="alertsCount">--</strong></div>
      </div>
      <div class="container card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">ä¼šå‘˜ç­‰çº§ç»Ÿè®¡</div>
          <div class="small">æ›´æ–°äº <span id="statTime"></span></div>
        </div>
        <div style="margin-top:12px" id="memberStats"></div>
      </div>
    </div>

    <!-- Recharge page -->
    <div id="page-recharge" class="container" style="display:none">
      <div class="page-title">å……å€¼ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="r_start"></label>
        <label>ç»“æŸ <input type="date" id="r_end"></label>
        <input id="r_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="r_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <input id="r_minCount" placeholder="é’±åŒ…å……å€¼æ¬¡æ•° >=" type="number" min="1" style="width:140px">
        <select id="r_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="success">æˆåŠŸ</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="r_search()">æœç´¢</button>
        <button onclick="openRechargeModal()">åœ¨çº¿å……å€¼</button>
      </div>
      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="r_table"><tr><td colspan="8" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Withdraw page -->
    <div id="page-withdraw" class="container" style="display:none">
      <div class="page-title">ææ¬¾ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="w_start"></label>
        <label>ç»“æŸ <input type="date" id="w_end"></label>
        <input id="w_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="w_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <input id="w_minCount" placeholder="é’±åŒ…ææ¬¾æ¬¡æ•° >=" type="number" min="1" style="width:140px">
        <select id="w_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="success">æˆåŠŸ</option><option value="processing">å¤„ç†ä¸­</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="w_search()">æœç´¢</button>
        <button onclick="openWithdrawModal()">åœ¨çº¿ææ¬¾</button>
        <button style="margin-left:8px;background:#6c757d;color:#fff;border:none;padding:8px;border-radius:6px;" onclick="showPage('orders')">æŸ¥çœ‹è®¢å•è®°å½•</button>
      </div>
      <table class="table">
        <thead><tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="w_table"><tr><td colspan="8" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Members page -->
    <div id="page-members" class="container" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="page-title">ä¼šå‘˜ç®¡ç†</div>
        <div><button style="background:#6c757d;color:#fff;border:none;padding:8px;border-radius:6px;" onclick="showPage('admins')">ç®¡ç†å‘˜æƒé™</button></div>
      </div>

      <div class="filters"><input id="m_search" placeholder="æœç´¢ä¼šå‘˜ID / é’±åŒ…" style="width:360px"><button onclick="loadMembers()">æœç´¢</button></div>
      <table class="table"><thead><tr><th>ä¼šå‘˜ID</th><th>é’±åŒ…</th><th>ç­‰çº§</th><th>æœ€è¿‘æ´»åŠ¨</th></tr></thead><tbody id="m_table"><tr><td colspan="4" class="small">æš‚æ— ä¼šå‘˜æ•°æ®</td></tr></tbody></table>
    </div>

    <!-- Settings page -->
    <div id="page-settings" class="container" style="display:none">
      <div class="page-title">ç³»ç»Ÿè®¾ç½®</div>
      <div style="max-width:900px">
        <div style="margin-bottom:8px">Telegram Bot Token <input id="s_tg_token" style="width:560px"></div>
        <div style="margin-bottom:8px">Telegram Chat ID <input id="s_tg_chat" style="width:200px"></div>
        <div style="margin-bottom:8px">æŠ¥è­¦é˜ˆå€¼(æ¬¡) <input id="s_tg_thresh" type="number" style="width:120px"> çª—å£(s) <input id="s_tg_window" type="number" style="width:120px"></div>
        <div style="margin-bottom:8px">ææ¬¾å¯†ç ï¼ˆå½“å‰ï¼‰ ä¿®æ”¹: <input id="s_withdraw_old" placeholder="æ—§å¯†ç " type="password" style="width:200px"> <input id="s_withdraw_new" placeholder="æ–°å¯†ç " type="password" style="width:200px"> <button onclick="changeWithdrawPassword()">ä¿®æ”¹ææ¬¾å¯†ç </button></div>
        <div style="margin-bottom:8px">ç™»å½•å¯†ç  ä¿®æ”¹: <button onclick="changeLoginPassword()">ä¿®æ”¹ç™»å½•å¯†ç </button></div>
        <div style="margin-bottom:8px"><button onclick="setup2FA()">è®¾ç½® 2FA</button> <button onclick="disable2FA()">ç¦ç”¨ 2FA</button></div>
        <div style="margin-top:12px"><button class="primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button></div>
        <div id="settingsStatus" class="small"></div>
      </div>
    </div>

    <!-- Orders page -->
    <div id="page-orders" class="container" style="display:none">
      <div class="page-title">è®¢å•è®°å½•ï¼ˆå……å€¼/ææ¬¾/ä¹°å–ï¼‰</div>

      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="o_start"></label>
        <label>ç»“æŸ <input type="date" id="o_end"></label>
        <input id="o_q" placeholder="è®¢å•å· / ä¼šå‘˜ID / é’±åŒ…åœ°å€" style="width:320px">
        <select id="o_type"><option value="">å…¨éƒ¨ç±»å‹</option><option value="recharge">å……å€¼</option><option value="withdraw">ææ¬¾</option><option value="trade">ä¹°å–</option></select>
        <select id="o_currency"><option value="">å…¨éƒ¨å¸ç§</option><option>BRL</option><option>USDT</option><option>BTC</option></select>
        <select id="o_status"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="success">æˆåŠŸ</option><option value="processing">å¤„ç†ä¸­</option><option value="failed">å¤±è´¥</option></select>
        <button class="primary" onclick="o_search()">æœç´¢</button>
        <button onclick="showPage('withdraw')">è¿”å›ææ¬¾</button>
      </div>

      <table class="table table-sm">
        <thead>
          <tr>
            <th>è®¢å• / ä¼šå‘˜ / é’±åŒ…</th>
            <th>æ—¶é—´</th>
            <th>ç±»å‹</th>
            <th>é‡‘é¢</th>
            <th>å¸ç§</th>
            <th>IP</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="o_table"><tr><td colspan="8" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr></tbody>
      </table>
    </div>

    <!-- Admins page -->
    <div id="page-admins" class="container" style="display:none">
      <div class="page-title">ç®¡ç†å‘˜æƒé™ç®¡ç†</div>

      <div class="subpage-actions">
        <input id="admin_id" placeholder="ç®¡ç†å‘˜ID" style="width:220px">
        <label><input type="checkbox" id="perm_recharge"> å……å€¼</label>
        <label><input type="checkbox" id="perm_withdraw"> ææ¬¾</label>
        <label><input type="checkbox" id="perm_trade"> äº¤æ˜“</label>
        <button class="primary" onclick="addAdmin()">æ–°å¢ç®¡ç†å‘˜</button>
        <button onclick="showPage('members')">è¿”å›ä¼šå‘˜</button>
      </div>

      <table class="table table-sm">
        <thead><tr><th>ç®¡ç†å‘˜ID</th><th>æƒé™</th><th>æœ€è¿‘ç™»å½•</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="admin_table"><tr><td colspan="4" class="small">æš‚æ— ç®¡ç†å‘˜</td></tr></tbody>
      </table>
      <div class="small" style="margin-top:8px">è¯´æ˜ï¼šæ­¤é¡µé¢å‰ç«¯ç®¡ç† UI å·²å®ç°ï¼›å¦‚éœ€æƒé™çœŸæ­£ç”Ÿæ•ˆï¼Œè¯·å°†æ–°å¢/ç¼–è¾‘è¯·æ±‚å¯¹æ¥åˆ°åç«¯æ¥å£ï¼ˆä¾‹å¦‚ /api/adminsï¼‰ã€‚</div>
    </div>

    <div class="footer-note">ç³»ç»Ÿç”Ÿæˆï¼š2025-11-21T17:08:12.970774</div>
  </div>
</div>

<script>
/* ---------------------------
   è½»é‡å‰ç«¯é€»è¾‘ï¼ˆä¿ç•™åŸæœ‰ä¸»è¦å‡½æ•°ï¼‰
   è¿™é‡Œä¸é‡å¤æ”¾ requireLogin()ï¼Œè¯·ç¡®ä¿ auth.js å†…éƒ¨ä¼šæ‰§è¡Œ requireLogin()ï¼ˆå¦‚æœéœ€è¦ï¼‰
   --------------------------- */

const PROXY_TRANSACTIONS = "/proxy/transactions";
const PROXY_RECHARGE = "/proxy/recharge";
const PROXY_WITHDRAW = "/proxy/withdraw";
const API_SETTINGS = "/api/settings";
const API_2FA_SETUP = "/api/2fa/setup";
const API_2FA_ENABLE = "/api/2fa/enable";
const API_2FA_DISABLE = "/api/2fa/disable";
const API_CHANGE_LOGIN = "/api/change-login-password";
const API_CHANGE_WITHDRAW = "/api/change-withdraw-password";
const API_LOGIN = "/api/login";

function $(s){return document.querySelector(s)}

/* Sidebar handling */
document.querySelectorAll('.sidebar .icon').forEach(ic=>ic.addEventListener('click',()=>{
  document.querySelectorAll('.sidebar .icon').forEach(x=>x.classList.remove('active'));
  ic.classList.add('active');
  const page = ic.getAttribute('data-page');
  hideAllPages();
  const el = document.getElementById('page-'+page);
  if(el) el.style.display='block';
  if(page==='dashboard') loadDashboard();
  if(page==='recharge') r_search();
  if(page==='withdraw') w_search();
  if(page==='members') loadMembers();
  if(page==='settings') loadSettings();
}));

function hideAllPages(){
  document.querySelectorAll('.main > .container').forEach(c=>c.style.display='none');
}

function showPage(key){
  document.querySelectorAll('.sidebar .icon').forEach(x=>x.classList.remove('active'));
  hideAllPages();
  const id = key==='orders' ? 'page-orders' : (key==='admins' ? 'page-admins' : 'page-'+key);
  const el = document.getElementById(id);
  if(el) el.style.display='block';
  if(key==='dashboard') loadDashboard();
  if(key==='recharge') r_search();
  if(key==='withdraw') w_search();
  if(key==='members') loadMembers();
  if(key==='settings') loadSettings();
  if(key==='orders') o_search();
  if(key==='admins') loadAdmins();
}

/* Dashboard loader */
async function loadDashboard(){
  try{
    const res = await fetch(PROXY_TRANSACTIONS);
    const list = await res.json();
    if(!Array.isArray(list)) return;
    const today = new Date(); today.setHours(0,0,0,0);
    let todayRecharge=0, todayWithdraw=0, orders=0, alerts=0;
    const memberMap = {};
    list.forEach(it=>{
      const t = Number(it.timestamp||it.time||it.date||0);
      if(t && t>=today.getTime()){
        if((it.type||it.txType||'').toString().toLowerCase().indexOf('recharge')!==-1) todayRecharge += Number(it.amount||it.value||0);
        if((it.type||it.txType||'').toString().toLowerCase().indexOf('withdraw')!==-1) todayWithdraw += Number(it.amount||it.value||0);
        orders++;
      }
      const user = it.userId||it.user||it.member||it.account||'unknown';
      const wallet = (it.wallet||it.address||it.to||it.from||'').toString();
      memberMap[user] = memberMap[user] || {user, wallets:new Set(), last:t, flags:[]};
      if(wallet) memberMap[user].wallets.add(wallet);
      if(t && (!memberMap[user].last || t>memberMap[user].last)) memberMap[user].last = t;
      if((it.status||'').toString().toLowerCase()==='failed'){ alerts++; }
    });
    document.getElementById('todayRecharge').innerText = todayRecharge;
    document.getElementById('todayWithdraw').innerText = todayWithdraw;
    document.getElementById('todayOrders').innerText = orders;
    document.getElementById('alertsCount').innerText = alerts;
    const stats = {attention:0,observe:0,firstRecharge:0,firstWithdraw:0,vip:0};
    Object.values(memberMap).forEach(m=>{
      if(m.wallets.size>5) stats.vip++;
    });
    const statEl = document.getElementById('memberStats');
    statEl.innerHTML = `<div>VIP: ${stats.vip}</div><div>æ³¨æ„ä¼šå‘˜: ${stats.attention}</div><div>è§‚å¯Ÿä¼šå‘˜: ${stats.observe}</div><div>é¦–æ¬¡å……å€¼: ${stats.firstRecharge}</div><div>é¦–æ¬¡ææ¬¾: ${stats.firstWithdraw}</div>`;
    document.getElementById('statTime').innerText = new Date().toLocaleString();
  }catch(e){console.error(e)}
}

/* Recharge / Withdraw / Orders / Members / Admins functions */
/* ä¸å‰ç«¯åŸå®ç°ä¸€è‡´ï¼Œä»…åšå®¹é”™ã€‚è‹¥éœ€è¦æ›´æ·±æƒé™æ§åˆ¶è¯·å¯¹æ¥åç«¯æ–°å¢æ¥å£ã€‚ */

async function r_search(){
  const params = new URLSearchParams();
  const s = $('#r_start').value; const e = $('#r_end').value;
  const w = $('#r_wallet').value.trim(); const c = $('#r_currency').value;
  const min = $('#r_minCount').value; const status = $('#r_status').value;
  if(s) params.append('start', s); if(e) params.append('end', e); if(w) params.append('q', w);
  if(c) params.append('currency', c); if(min) params.append('minCount', min); if(status) params.append('status', status);
  const tbody = $('#r_table'); tbody.innerHTML='<tr><td colspan="8" class="small">åŠ è½½ä¸­...</td></tr>';
  try{
    const res = await fetch(PROXY_TRANSACTIONS + '?' + params.toString());
    const list = await res.json();
    if(!Array.isArray(list)){ tbody.innerHTML='<tr><td colspan="8" class="small">è¿”å›å¼‚å¸¸</td></tr>'; return; }
    if(list.length===0){ tbody.innerHTML='<tr><td colspan="8" class="small">æ²¡æœ‰è®°å½•</td></tr>'; return; }
    const rows = list.filter(it=>(it.type||it.txType||'').toString().toLowerCase().indexOf('recharge')!==-1).map(it=>renderRow(it));
    tbody.innerHTML = rows.length?rows.join(''):'<tr><td colspan="8" class="small">æ²¡æœ‰è®°å½•</td></tr>';
  }catch(e){ tbody.innerHTML='<tr><td colspan="8" class="small">åŠ è½½å¤±è´¥</td></tr>'; console.error(e) }
}

async function w_search(){
  const params = new URLSearchParams();
  const s = $('#w_start').value; const e = $('#w_end').value;
  const w = $('#w_wallet').value.trim(); const c = $('#w_currency').value; const min = $('#w_minCount').value; const status = $('#w_status').value;
  if(s) params.append('start', s); if(e) params.append('end', e); if(w) params.append('q', w);
  if(c) params.append('currency', c); if(min) params.append('minCount', min); if(status) params.append('status', status);
  const tbody = $('#w_table'); tbody.innerHTML='<tr><td colspan="8" class="small">åŠ è½½ä¸­...</td></tr>';
  try{
    const res = await fetch(PROXY_TRANSACTIONS + '?' + params.toString());
    const list = await res.json();
    if(!Array.isArray(list)){ tbody.innerHTML='<tr><td colspan="8" class="small">è¿”å›å¼‚å¸¸</td></tr>'; return; }
    if(list.length===0){ tbody.innerHTML='<tr><td colspan="8" class="small">æ²¡æœ‰è®°å½•</td></tr>'; return; }
    const rows = list.filter(it=>(it.type||it.txType||'').toString().toLowerCase().indexOf('withdraw')!==-1).map(it=>renderRow(it));
    tbody.innerHTML = rows.length?rows.join(''):'<tr><td colspan="8" class="small">æ²¡æœ‰è®°å½•</td></tr>';
  }catch(e){ tbody.innerHTML='<tr><td colspan="8" class="small">åŠ è½½å¤±è´¥</td></tr>'; console.error(e) }
}

function renderRow(it){
  const order = it.orderId||it.oid||it.id||''; const user = it.userId||it.user||it.member||'';
  const wallet = it.wallet||it.address||''; const time = it.timestamp?new Date(Number(it.timestamp)).toLocaleString(): (it.time||it.date||'');
  const amount = it.amount||it.value||0; const currency = it.currency||it.coin||'BRL';
  const ip = it.ip||it.ipAddr||''; const status = (it.status||'').toString().toLowerCase();
  const label = memberLabel(it);
  const type = (it.type||it.txType||'').toString();
  return `<tr><td><div class="small">${order}</div><div>${user}</div><div style="color:var(--top-blue)">${wallet}</div>${label}</td><td>${time}</td><td>${type}</td><td>${amount}</td><td>${currency}</td><td>${ip}</td><td>${status}</td><td class="actions"><button onclick="viewDetail('${order}')">æŸ¥çœ‹</button></td></tr>`;
}

function memberLabel(item){
  const lvl = (item.memberLevel||item.level||'').toString().toLowerCase();
  const isFirstRecharge = item.firstRecharge||false; const isFirstWithdraw = item.firstWithdraw||false; const isVip = lvl.indexOf('vip')!==-1;
  if(item.flag==='attention') return '<span class="member-label label-attention">æ³¨æ„ä¼šå‘˜</span>';
  if(item.flag==='observe') return '<span class="member-label label-observe">è§‚å¯Ÿä¼šå‘˜</span>';
  if(isFirstRecharge) return '<span class="member-label label-first-recharge">é¦–æ¬¡å……å€¼</span>';
  if(isFirstWithdraw) return '<span class="member-label label-first-withdraw">é¦–æ¬¡ææ¬¾</span>';
  if(isVip) return '<span class="member-label label-vip">VIP</span>';
  return '';
}

async function o_search(){
  const params = new URLSearchParams();
  const s = $('#o_start').value; const e = $('#o_end').value; const q = $('#o_q').value.trim();
  const type = $('#o_type').value; const currency = $('#o_currency').value; const status = $('#o_status').value;
  if(s) params.append('start', s); if(e) params.append('end', e); if(q) params.append('q', q);
  if(type) params.append('type', type); if(currency) params.append('currency', currency); if(status) params.append('status', status);
  const tbody = $('#o_table'); tbody.innerHTML='<tr><td colspan="8" class="small">åŠ è½½ä¸­...</td></tr>';
  try{
    const res = await fetch(PROXY_TRANSACTIONS + '?' + params.toString());
    const list = await res.json();
    if(!Array.isArray(list)){ tbody.innerHTML='<tr><td colspan="8" class="small">è¿”å›å¼‚å¸¸</td></tr>'; return; }
    const filtered = list.filter(it=>{
      const t = (it.type||it.txType||'').toString().toLowerCase();
      if(type && t.indexOf(type)===-1) return false;
      if(status && ((it.status||'').toString().toLowerCase()!==status)) return false;
      if(currency && ((it.currency||it.coin||'').toString().toLowerCase()!==currency.toLowerCase())) return false;
      if(q){
        const joint = `${it.orderId||it.id||''} ${it.userId||it.user||it.member||''} ${it.wallet||it.address||''}`.toLowerCase();
        if(joint.indexOf(q.toLowerCase())===-1) return false;
      }
      return true;
    });
    if(filtered.length===0){ tbody.innerHTML='<tr><td colspan="8" class="small">æ²¡æœ‰è®°å½•</td></tr>'; return; }
    tbody.innerHTML = filtered.map(it=>renderRow(it)).join('');
  }catch(e){ tbody.innerHTML='<tr><td colspan="8" class="small">åŠ è½½å¤±è´¥</td></tr>'; console.error(e) }
}

/* Admins (localStorage UI) */
function loadAdmins(){
  const raw = localStorage.getItem('nexbit_admins') || '[]';
  let arr = [];
  try{ arr = JSON.parse(raw); }catch(e){ arr = []; }
  const tbody = document.getElementById('admin_table');
  if(!arr.length){ tbody.innerHTML = '<tr><td colspan="4" class="small">æš‚æ— ç®¡ç†å‘˜</td></tr>'; return; }
  tbody.innerHTML = arr.map(a=>`<tr><td>${a.id}</td><td>${a.perms.join(', ')}</td><td>${a.lastLogin||''}</td><td><button onclick="removeAdmin('${a.id}')">åˆ é™¤</button></td></tr>`).join('');
}

function addAdmin(){
  const id = document.getElementById('admin_id').value.trim();
  if(!id) return alert('è¯·è¾“å…¥ç®¡ç†å‘˜ID');
  const perms = [];
  if(document.getElementById('perm_recharge').checked) perms.push('å……å€¼');
  if(document.getElementById('perm_withdraw').checked) perms.push('ææ¬¾');
  if(document.getElementById('perm_trade').checked) perms.push('äº¤æ˜“');
  const raw = localStorage.getItem('nexbit_admins') || '[]';
  let arr = [];
  try{ arr = JSON.parse(raw); }catch(e){ arr = []; }
  if(arr.find(x=>x.id===id)) return alert('ç®¡ç†å‘˜å·²å­˜åœ¨');
  arr.push({id,perms,lastLogin:new Date().toLocaleString()});
  localStorage.setItem('nexbit_admins', JSON.stringify(arr));
  document.getElementById('admin_id').value=''; document.getElementById('perm_recharge').checked=false; document.getElementById('perm_withdraw').checked=false; document.getElementById('perm_trade').checked=false;
  loadAdmins();
  alert('æ–°å¢ç®¡ç†å‘˜å·²ä¿å­˜ï¼ˆæœ¬åœ°å­˜å‚¨ï¼Œä»…ä¾› UI ç®¡ç†ï¼‰ã€‚å¦‚éœ€åç«¯æƒé™æ§åˆ¶ï¼Œè¯·å¯¹æ¥ /api/adminsã€‚');
}

function removeAdmin(id){
  const raw = localStorage.getItem('nexbit_admins') || '[]';
  let arr = [];
  try{ arr = JSON.parse(raw); }catch(e){ arr = []; }
  arr = arr.filter(x=>x.id!==id);
  localStorage.setItem('nexbit_admins', JSON.stringify(arr));
  loadAdmins();
}

/* Members loader */
async function loadMembers(){
  const q = $('#m_search').value.trim(); const tbody = $('#m_table'); tbody.innerHTML='<tr><td colspan="4" class="small">åŠ è½½ä¸­...</td></tr>';
  try{
    const res = await fetch(PROXY_TRANSACTIONS); const list = await res.json();
    const map = {};
    list.forEach(it=>{ const user = it.userId||it.user||it.member||''; const wallet = it.wallet||it.address||''; if(!map[user]) map[user]={user:user,wallets:new Set(),last:it.timestamp||it.time||it.date}; if(wallet) map[user].wallets.add(wallet); if(it.timestamp && (!map[user].last || it.timestamp>map[user].last)) map[user].last=it.timestamp; });
    const items = Object.values(map).map(m=>({user:m.user,wallets:Array.from(m.wallets),last:m.last}));
    const filtered = q?items.filter(i=>(i.user+''+i.wallets.join('')).indexOf(q)!==-1):items;
    if(filtered.length===0){ tbody.innerHTML='<tr><td colspan="4" class="small">æ²¡æœ‰ä¼šå‘˜</td></tr>'; return; }
    tbody.innerHTML = filtered.map(m=>`<tr><td>${m.user}</td><td>${m.wallets.join(', ')}</td><td><span class="member-label label-observe">è§‚å¯Ÿä¼šå‘˜</span></td><td>${m.last||''}</td></tr>`).join('');
  }catch(e){ tbody.innerHTML='<tr><td colspan="4" class="small">åŠ è½½å¤±è´¥</td></tr>'; console.error(e) }
}

/* Settings functions */
async function loadSettings(){ try{ const res = await fetch(API_SETTINGS); const s = await res.json(); $('#s_tg_token').value = s.telegramBotToken||''; $('#s_tg_chat').value = s.telegramChatId||''; $('#s_tg_thresh').value = s.tgThresholdCount||5; $('#s_tg_window').value = s.tgWindowSeconds||3600; $('#settingsStatus').innerText=''; }catch(e){ $('#settingsStatus').innerText='åŠ è½½å¤±è´¥'; } }

async function saveSettings(){ const body = { telegramBotToken:$('#s_tg_token').value.trim(), telegramChatId:$('#s_tg_chat').value.trim(), tgThresholdCount:parseInt($('#s_tg_thresh').value||'5',10), tgWindowSeconds:parseInt($('#s_tg_window').value||'3600',10) }; const res = await fetch(API_SETTINGS,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); const j = await res.json(); if(j.ok) $('#settingsStatus').innerText='ä¿å­˜æˆåŠŸ'; else $('#settingsStatus').innerText='ä¿å­˜å¤±è´¥'; }

async function changeWithdrawPassword(){ const oldP = $('#s_withdraw_old').value; const newP = $('#s_withdraw_new').value; if(!oldP||!newP) return alert('è¯·è¾“å…¥æ—§å¯†ç å’Œæ–°å¯†ç '); const res = await fetch(API_CHANGE_WITHDRAW,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({oldPassword:oldP,newPassword:newP})}); const j = await res.json(); if(j.ok) alert('ææ¬¾å¯†ç å·²ä¿®æ”¹'); else alert('ä¿®æ”¹å¤±è´¥:'+ (j.message||'')); $('#s_withdraw_old').value=''; $('#s_withdraw_new').value=''; }

async function changeLoginPassword(){ const oldP = prompt('æ—§ç™»å½•å¯†ç :'); const newP = prompt('æ–°ç™»å½•å¯†ç :'); if(!oldP||!newP) return alert('å–æ¶ˆ'); const res = await fetch(API_CHANGE_LOGIN,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({oldPassword:oldP,newPassword:newP})}); const j = await res.json(); if(j.ok) alert('ç™»å½•å¯†ç å·²ä¿®æ”¹'); else alert('ä¿®æ”¹å¤±è´¥:'+ (j.message||'')); }

async function setup2FA(){ try{ const res = await fetch(API_2FA_SETUP); const j = await res.json(); if(!j.ok) return alert('2FA setup failed'); const w = window.open('', '_blank'); w.document.write('<img src="'+j.qr+'" /><p>å¯†é’¥: '+j.secret+'</p>'); const token = prompt('æ‰«æäºŒç»´ç åè¯·è¾“å…¥ä¸€æ¬¡æ€§éªŒè¯ç ä»¥å¯ç”¨ 2FA:'); if(!token) return; const enableRes = await fetch(API_2FA_ENABLE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({secret:j.secret,token:token})}); const je = await enableRes.json(); if(je.ok) alert('2FA å·²å¯ç”¨'); else alert('å¯ç”¨å¤±è´¥: '+(je.message||'')); loadSettings(); }catch(e){alert('2FA setup error')} }

async function disable2FA(){ try{ const token = prompt('è¯·è¾“å…¥å½“å‰ 2FA éªŒè¯ç ä»¥ç¡®è®¤ç¦ç”¨:'); const res = await fetch(API_2FA_DISABLE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:token})}); const j = await res.json(); if(j.ok) alert('2FA å·²ç¦ç”¨'); else alert('ç¦ç”¨å¤±è´¥: '+(j.message||'')); loadSettings(); }catch(e){alert('disable error')} }

function viewDetail(id){ alert('æŸ¥çœ‹è®¢å•: '+id) }

document.addEventListener('DOMContentLoaded',()=>{
  // show dashboard
  document.querySelector('.sidebar .icon.active').click();
  // load admins from localStorage
  loadAdmins();
});
</script>

<!-- ç™»å½•éªŒè¯ï¼ˆè¯·ç¡®ä¿ public/js/auth.js å­˜åœ¨å¹¶åœ¨å†…éƒ¨æ‰§è¡Œ requireLogin()ï¼‰ -->
<script src="js/auth.js"></script>

<!-- Nexbit APIï¼ˆä¿®å¤ç‰ˆï¼‰ -->
<script src="js/nexbit-api.js"></script>
</body>
</html>
