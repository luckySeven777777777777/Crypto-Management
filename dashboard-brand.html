<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NEXBIT ç®¡ç†åå° â€” æœ€ç»ˆç‰ˆ</title>
<style>
:root{
  --top-blue:#1976d2;
  --deep-blue:#0f2655;
  --bg:#f4f7fb;
  --card:#fff;
  --red:#ff4444;
  --black:#000;
  --green:#00c851;
  --yellow:#ffbb33;
  --purple:#9933ff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Roboto,Arial;background:var(--bg);min-height:100vh}
.top-header{
  position:fixed;top:0;left:0;width:100%;height:64px;
  background:var(--top-blue);color:#fff;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;z-index:1000;
}
.top-header .brand{font-weight:700;font-size:18px}
.top-header .user{font-size:14px;display:flex;align-items:center;gap:16px}

/* å³ä¸Šé€€å‡ºæŒ‰é’®æ ·å¼ */
.top-header .user a.logout-btn{
  color:white;text-decoration:none;font-size:14px;
  background: rgba(255,255,255,0.12);
  padding:6px 10px;border-radius:6px;
}
.top-header .user a.logout-btn:hover{
  background: rgba(255,255,255,0.18);
}

.app{display:flex;padding-top:64px}
.sidebar{
  width:88px;background:var(--deep-blue);color:#fff;
  min-height:calc(100vh - 64px);
  padding-top:20px;position:fixed;top:64px;left:0
}
.sidebar .icon{
  display:block;padding:16px;text-align:center;
  color:#cdd6f4;cursor:pointer
}
.sidebar .icon.active{
  background:var(--top-blue);color:#fff;
  border-radius:8px;margin:4px
}

.main{margin-left:88px;flex:1;padding:22px 26px}
.container{background:var(--card);border-radius:8px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.page-title{font-size:20px;font-weight:700;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
.card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
input,select,button{padding:8px;border:1px solid #ddd;border-radius:6px}
button.primary{background:var(--top-blue);color:#fff;border:none;cursor:pointer}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
.small{font-size:12px;color:#666}
.actions button{margin-right:6px}
.footer-note{margin-top:10px;color:#888;font-size:12px}

@media(max-width:900px){
  .grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<div class="top-header">
  <div class="brand">NEXBIT ç®¡ç†åå°ï¼ˆä»£ç†ï¼‰</div>
  
  <div class="user">
    å·²ç™»å½•ï¼šadmin
    <a class="logout-btn" href="logout.html">é€€å‡º</a>
  </div>
</div>

<div class="app">
  <div class="sidebar">
    <div class="icon active" data-page="dashboard" title="æ§åˆ¶å°">ğŸ </div>
    <div class="icon" data-page="recharge" title="å……å€¼ç®¡ç†">ğŸ’³</div>
    <div class="icon" data-page="withdraw" title="ææ¬¾ç®¡ç†">ğŸ’¸</div>
    <div class="icon" data-page="members" title="ä¼šå‘˜ç®¡ç†">ğŸ‘¥</div>
    <div class="icon" data-page="settings" title="ç³»ç»Ÿè®¾ç½®">âš™ï¸</div>
  </div>

  <div class="main">
    <!-- Dashboard -->
    <div id="page-dashboard" class="container">
      <div class="page-title">æ§åˆ¶å°</div>
      <div class="grid">
        <div class="card">ä»Šæ—¥å……å€¼<br><strong id="todayRecharge">--</strong></div>
        <div class="card">ä»Šæ—¥ææ¬¾<br><strong id="todayWithdraw">--</strong></div>
        <div class="card">ä»Šæ—¥è®¢å•<br><strong id="todayOrders">--</strong></div>
        <div class="card">é£æ§é¢„è­¦<br><strong id="alertsCount">--</strong></div>
      </div>

      <div class="container card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">ä¼šå‘˜ç­‰çº§ç»Ÿè®¡</div>
          <div class="small">æ›´æ–°äº <span id="statTime"></span></div>
        </div>
        <div style="margin-top:12px" id="memberStats"></div>
      </div>
    </div>

    <!-- Recharge page -->
    <div id="page-recharge" class="container" style="display:none">
      <div class="page-title">å……å€¼ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="r_start"></label>
        <label>ç»“æŸ <input type="date" id="r_end"></label>
        <input id="r_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="r_currency">
          <option value="">å…¨éƒ¨å¸ç§</option>
          <option>BRL</option>
          <option>USDT</option>
          <option>BTC</option>
        </select>
        <input id="r_minCount" placeholder="é’±åŒ…å……å€¼æ¬¡æ•° >=" type="number" min="1" style="width:140px">
        <select id="r_status">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          <option value="success">æˆåŠŸ</option>
          <option value="failed">å¤±è´¥</option>
        </select>
        <button class="primary" onclick="r_search()">æœç´¢</button>
        <button onclick="openRechargeModal()">åœ¨çº¿å……å€¼</button>
      </div>
      <table class="table">
        <thead>
          <tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="r_table">
          <tr><td colspan="8" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Withdraw page -->
    <div id="page-withdraw" class="container" style="display:none">
      <div class="page-title">ææ¬¾ç®¡ç†</div>
      <div class="filters">
        <label>å¼€å§‹ <input type="date" id="w_start"></label>
        <label>ç»“æŸ <input type="date" id="w_end"></label>
        <input id="w_wallet" placeholder="é’±åŒ…åœ°å€ / ä¼šå‘˜ID / è®¢å•å·" style="width:260px">
        <select id="w_currency">
          <option value="">å…¨éƒ¨å¸ç§</option>
          <option>BRL</option>
          <option>USDT</option>
          <option>BTC</option>
        </select>
        <input id="w_minCount" placeholder="é’±åŒ…ææ¬¾æ¬¡æ•° >=" type="number" min="1" style="width:140px">
        <select id="w_status">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          <option value="success">æˆåŠŸ</option>
          <option value="processing">å¤„ç†ä¸­</option>
          <option value="failed">å¤±è´¥</option>
        </select>
        <button class="primary" onclick="w_search()">æœç´¢</button>
        <button onclick="openWithdrawModal()">åœ¨çº¿ææ¬¾</button>
      </div>
      <table class="table">
        <thead>
          <tr><th>è®¢å•/ä¼šå‘˜/é’±åŒ…</th><th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>å¸ç§</th><th>IP</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="w_table">
          <tr><td colspan="8" class="small">ç‚¹å‡»æœç´¢åŠ è½½æ•°æ®</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Members page -->
    <div id="page-members" class="container" style="display:none">
      <div class="page-title">ä¼šå‘˜ç®¡ç†</div>
      <div class="filters">
        <input id="m_search" placeholder="æœç´¢ä¼šå‘˜ID / é’±åŒ…" style="width:360px">
        <button onclick="loadMembers()">æœç´¢</button>
      </div>
      <table class="table">
        <thead>
          <tr><th>ä¼šå‘˜ID</th><th>é’±åŒ…</th><th>ç­‰çº§</th><th>æœ€è¿‘æ´»åŠ¨</th><th>ä½™é¢ï¼ˆå¯ç¼–è¾‘ï¼‰</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="m_table">
          <tr><td colspan="6" class="small">æš‚æ— ä¼šå‘˜æ•°æ®</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Settings page -->
    <div id="page-settings" class="container" style="display:none">
      <div class="page-title">ç³»ç»Ÿè®¾ç½®</div>
      <div style="max-width:900px">
        <div style="margin-bottom:8px">Telegram Bot Token <input id="s_tg_token" style="width:560px"></div>
        <div style="margin-bottom:8px">Telegram Chat ID <input id="s_tg_chat" style="width:200px"></div>
        <div style="margin-bottom:8px">æŠ¥è­¦é˜ˆå€¼(æ¬¡) <input id="s_tg_thresh" type="number" style="width:120px">
          çª—å£(s) <input id="s_tg_window" type="number" style="width:120px">
        </div>
        <div style="margin-bottom:8px">ææ¬¾å¯†ç ï¼ˆæ—§ï¼‰ <input id="s_withdraw_old" type="password" style="width:200px">
          æ–° <input id="s_withdraw_new" type="password" style="width:200px">
          <button onclick="changeWithdrawPassword()">ä¿®æ”¹ææ¬¾å¯†ç </button>
        </div>
        <div style="margin-bottom:8px"><button onclick="changeLoginPassword()">ä¿®æ”¹ç™»å½•å¯†ç </button></div>
        <div style="margin-bottom:8px"><button onclick="setup2FA()">è®¾ç½® 2FA</button>
          <button onclick="disable2FA()">ç¦ç”¨ 2FA</button></div>
        <div style="margin-top:12px"><button class="primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button></div>
        <div id="settingsStatus" class="small"></div>
      </div>
    </div>

  </div><!-- main -->
</div><!-- app -->

<!-- JSï¼šä¿æŒåŸæ¥é€»è¾‘ï¼ˆåˆ é™¤äº† admin balance ç›¸å…³è„šæœ¬ï¼‰ -->
<script>
const PROXY_TRANSACTIONS = "/proxy/transactions";
const PROXY_RECHARGE = "/proxy/recharge";
const PROXY_WITHDRAW = "/proxy/withdraw";
const API_SETTINGS = "/api/settings";
const API_2FA_SETUP = "/api/2fa/setup";
const API_2FA_ENABLE = "/api/2fa/enable";
const API_2FA_DISABLE = "/api/2fa/disable";
const API_CHANGE_LOGIN = "/api/change-login-password";
const API_CHANGE_WITHDRAW = "/api/change-withdraw-password";

function $(s){return document.querySelector(s)}

// sidebar click handling
document.querySelectorAll('.sidebar .icon').forEach(ic=>ic.addEventListener('click',()=>{
  document.querySelectorAll('.sidebar .icon').forEach(x=>x.classList.remove('active'));
  ic.classList.add('active');
  const page = ic.getAttribute('data-page');
  document.querySelectorAll('.container').forEach(c=>c.style.display='none');
  document.getElementById('page-'+page).style.display='block';

  if(page==='dashboard') loadDashboard();
  if(page==='recharge') r_search();
  if(page==='withdraw') w_search();
  if(page==='members') loadMembers();
  if(page==='settings') loadSettings();
}));

// Dashboard metrics
async function loadDashboard(){
  try{
    const res = await fetch(PROXY_TRANSACTIONS);
    const list = await res.json();
    if(!Array.isArray(list)) return;

    const today = new Date(); today.setHours(0,0,0,0);
    let todayRecharge=0, todayWithdraw=0, orders=0, alerts=0;
    const memberMap = {};

    list.forEach(it=>{
      const t = Date.parse(it.timestamp||it.time||it.date||'');
      if(isNaN(t)) return;
      if(t>=today.getTime()) orders++;
    });

    document.getElementById('todayOrders').innerText=orders;
    document.getElementById('statTime').innerText=new Date().toLocaleString();
  }catch(e){}
}

// Recharge search
async function r_search(){
  const params = new URLSearchParams();
  const s = $('#r_start').value; const e = $('#r_end').value;
  const w = $('#r_wallet').value.trim();
  const c = $('#r_currency').value;
  const min = $('#r_minCount').value;
  const st = $('#r_status').value;

  if(s) params.append('start', s);
  if(e) params.append('end', e);
  if(w) params.append('wallet', w);
  if(c) params.append('currency', c);
  if(min) params.append('minCount', min);
  if(st) params.append('status', st);

  const tbody = $('#r_table');
  tbody.innerHTML='<tr><td colspan="8" class="small">åŠ è½½ä¸­...</td></tr>';

  try{
    const res = await fetch(PROXY_TRANSACTIONS + '?' + params.toString());
    const list = await res.json();
    if(!Array.isArray(list)){ tbody.innerHTML='<tr><td colspan="8" class="small">è¿”å›å¼‚å¸¸</td></tr>'; return; }

    const rows = list.filter(it=>String(it.type).includes("å……å€¼")).map(it=>{
      const order = it.orderId||it.oid||'';
      return `<tr><td>${order}</td><td>${it.time||''}</td>
      <td>${it.type}</td><td>${it.amount}</td><td>${it.currency}</td>
      <td>${it.ip||''}</td><td>${it.status||''}</td>
      <td><button>æŸ¥çœ‹</button></td></tr>`;
    });

    tbody.innerHTML = rows.length?rows.join(''):'<tr><td colspan="8" class="small">æ²¡æœ‰è®°å½•</td></tr>';
  }catch(e){}
}

// Withdraw search
async function w_search(){
  const tbody = $('#w_table');
  tbody.innerHTML='<tr><td colspan="8" class="small">åŠ è½½ä¸­...</td></tr>';

  try{
    const res = await fetch(PROXY_TRANSACTIONS);
    const list = await res.json();
    const rows = list.map(it=>{
      const order = it.orderId||'';
      return `<tr><td>${order}</td><td>${it.time||''}</td>
      <td>${it.type}</td><td>${it.amount}</td><td>${it.currency}</td>
      <td>${it.ip||''}</td><td>${it.status||''}</td>
      <td><button>æŸ¥çœ‹</button></td></tr>`;
    });
    tbody.innerHTML = rows.join('');
  }catch(e){}
}

// Members
async function loadMembers(){
  const tbody = $('#m_table');
  tbody.innerHTML='<tr><td colspan="6" class="small">åŠ è½½ä¸­...</td></tr>';
  try{
    // ä»æ–°çš„ Firestore åç«¯è¯»å–ä¼šå‘˜åˆ—è¡¨
    const res = await fetch('/api/admin/users');
    const list = await res.json();

    if(!Array.isArray(list) || list.length===0){
      tbody.innerHTML='<tr><td colspan="6" class="small">æš‚æ— ä¼šå‘˜æ•°æ®</td></tr>';
      return;
    }

    const rows = list.map(u=>{
      const wallet = u.wallet||'';
      const level = u.level||'';
      const last = u.lastActivity||'';
      const bal = (typeof u.balance === 'number') ? u.balance.toFixed(2) : (u.balance||0);

      return `<tr>
        <td>${u.userid}</td>
        <td>${wallet}</td>
        <td>${level}</td>
        <td>${last}</td>
        <td>
          <input id="bal_input_${u.userid}" type="number" value="${bal}" style="width:110px;padding:6px;border-radius:6px;border:1px solid #ddd">
        </td>
        <td>
          <button onclick="saveMemberBalance('${u.userid}')">ä¿å­˜</button>
        </td>
      </tr>`;
    });

    tbody.innerHTML = rows.join('');
  }catch(e){
    console.error("loadMembers error", e);
    tbody.innerHTML='<tr><td colspan="6" class="small">åŠ è½½å¤±è´¥</td></tr>';
  }
}

// ä¿å­˜ä¼šå‘˜ä½™é¢ï¼ˆä¼šå†™å…¥ Firestore via /api/admin/balanceï¼‰
async function saveMemberBalance(userid){
  const el = document.getElementById(`bal_input_${userid}`);
  if(!el) return alert("æ‰¾ä¸åˆ°è¾“å…¥æ¡†");
  const v = Number(el.value);
  if (isNaN(v)) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");

  try{
    const res = await fetch('/api/admin/balance', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ user: userid, amount: v })
    });
    const j = await res.json();
    if (j.success) {
      alert('ä¿å­˜æˆåŠŸï¼Œæ–°ä½™é¢ï¼š' + (j.balance ?? v));
      loadMembers();
    } else {
      alert('ä¿å­˜å¤±è´¥');
    }
  }catch(e){
    console.error("saveMemberBalance error", e);
    alert('ä¿å­˜é”™è¯¯');
  }
}

// Settings
async function loadSettings(){
  try{
    const res = await fetch(API_SETTINGS);
    const s = await res.json();
    $('#s_tg_token').value = s.telegramBotToken||'';
    $('#s_tg_chat').value = s.telegramChatId||'';
    $('#s_tg_thresh').value = s.tgThresholdCount||5;
    $('#s_tg_window').value = s.tgWindowSeconds||3600;
  }catch(e){}
}

async function saveSettings(){
  const body = {
    telegramBotToken:$('#s_tg_token').value.trim(),
    telegramChatId:$('#s_tg_chat').value.trim(),
    tgThresholdCount:parseInt($('#s_tg_thresh').value||'5',10),
    tgWindowSeconds:parseInt($('#s_tg_window').value||'3600',10)
  };
  await fetch(API_SETTINGS,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  alert("ä¿å­˜æˆåŠŸ");
}

async function changeWithdrawPassword(){}
async function changeLoginPassword(){}
async function setup2FA(){}
async function disable2FA(){}

</script>

<!-- ç™»å½•éªŒè¯ + API å°è£… -->
<script>requireLogin();</script>
<script src="nexbit-api.js"></script>

</body>
</html>
